// src\pages\admin\HallsManagement.jsx
// /**
//  * Halls Management Page - إدارة القاعات
//  * صفحة إدارة القاعات مع دعم كامل للـ CRUD، التصدير، والبحث المتقدم
//  */

// import { useState, useMemo, useEffect } from 'react'
// import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
// import { useForm, Controller } from 'react-hook-form'
// import { zodResolver } from '@hookform/resolvers/zod'
// import { z } from 'zod'
// import { useMediaQuery, useTheme } from '@mui/material'
// import * as XLSX from 'xlsx'
// import { saveAs } from 'file-saver'

// // MUI Components - استخدم فقط المكونات المتوفرة
// import MuiBox from '@/components/ui/MuiBox'
// import MuiTypography from '@/components/ui/MuiTypography'
// import MuiButton from '@/components/ui/MuiButton'
// import MuiTextField from '@/components/ui/MuiTextField'
// import MuiPaper from '@/components/ui/MuiPaper'
// import MuiCard from '@/components/ui/MuiCard'
// import MuiCardContent from '@/components/ui/MuiCardContent'
// import MuiCardActions from '@/components/ui/MuiCardActions'
// import MuiCardMedia from '@/components/ui/MuiCardMedia'
// import MuiIconButton from '@/components/ui/MuiIconButton'
// import MuiDialog from '@/components/ui/MuiDialog'
// import MuiDialogTitle from '@/components/ui/MuiDialogTitle'
// import MuiDialogContent from '@/components/ui/MuiDialogContent'
// import MuiDialogActions from '@/components/ui/MuiDialogActions'
// import MuiDivider from '@/components/ui/MuiDivider'
// import MuiGrid from '@/components/ui/MuiGrid'
// import MuiChip from '@/components/ui/MuiChip'
// import MuiAlert from '@/components/ui/MuiAlert'
// import MuiCircularProgress from '@/components/ui/MuiCircularProgress'
// import MuiSelect from '@/components/ui/MuiSelect'
// import MuiSwitch from '@/components/ui/MuiSwitch'
// // إزالة MuiFormControlLabel و MuiCheckbox لأنها غير موجودة

// // Layout & Common Components
// import DashboardLayout from '@/components/layout/DashboardLayout'
// import { LoadingScreen, EmptyState, ConfirmDialog, SEOHead, CardsView, TablePagination, DataTable } from '@/components/common'
// import PageHeader from '@/components/common/PageHeader'

// // Hooks & Utilities
// import { useNotification, useDebounce } from '@/hooks'
// import { QUERY_KEYS } from '@/config/constants'
// import { getHallsList, createHall, updateHall, deleteHall } from '@/api/admin'
// import { formatCurrency, formatPhoneNumber, generateExportFileName } from '@/utils/helpers'

// // Icons
// import {
//   Building2,
//   Search,
//   Plus,
//   Pencil,
//   Trash2,
//   AlertCircle,
//   Eye,
//   Download,
//   Filter,
//   RefreshCw,
//   CheckCircle,
//   XCircle,
//   User,
//   Phone,
//   Users,
//   DollarSign,
//   MapPin,
//   Table,
//   Armchair as Chair,
//   Users as EmployeesIcon,
//   Check,
//   X,
//   FileText
// } from 'lucide-react'

// // ====================== Validation Schema ======================
// const createHallSchema = (editingHall = null) => z.object({
//   name: z.string()
//     .min(3, 'اسم القاعة يجب أن يكون 3 أحرف على الأقل')
//     .max(100, 'اسم القاعة طويل جداً'),

//   location: z.string()
//     .min(3, 'الموقع مطلوب')
//     .max(200, 'الموقع طويل جداً'),

//   capacity: z.coerce.number()
//     .min(1, 'السعة مطلوبة')
//     .max(10000, 'السعة كبيرة جداً'),

//   tables: z.coerce.number()
//     .min(1, 'عدد الطاولات مطلوب')
//     .max(1000, 'عدد الطاولات كبير جداً'),

//   chairs: z.coerce.number()
//     .min(1, 'عدد الكراسي مطلوب')
//     .max(10000, 'عدد الكراسي كبير جداً'),

//   maxEmployees: z.coerce.number()
//     .min(1, 'الحد الأقصى للموظفين مطلوب')
//     .max(1000, 'الحد الأقصى للموظفين كبير جداً'),

//   defaultPrices: z.coerce.number()
//     .min(0, 'السعر مطلوب')
//     .max(1000000, 'السعر كبير جداً'),

//   managerName: z.string()
//     .min(3, 'اسم المدير مطلوب')
//     .max(100, 'اسم المدير طويل جداً'),

//   managerPhone: z.string()
//     .regex(/^\d+$/, 'رقم الهاتف يجب أن يكون أرقام فقط')
//     .min(6, 'رقم الهاتف يجب أن يكون 6 أرقام على الأقل')
//     .max(15, 'رقم الهاتف طويل جداً'),

//   managerPassword: editingHall 
//     ? z.string()
//         .min(6, 'كلمة المرور يجب أن تكون 6 أحرف على الأقل')
//         .max(50, 'كلمة المرور طويلة جداً')
//         .optional()
//         .or(z.literal(''))
//     : z.string()
//         .min(6, 'كلمة المرور مطلوبة')
//         .max(50, 'كلمة المرور طويلة جداً'),

//   description: z.string()
//     .max(500, 'الوصف طويل جداً')
//     .optional()
//     .or(z.literal('')),

//   isActive: z.boolean()
//     .optional()
//     .default(true)
// })

// // ====================== Main Component ======================
// export default function HallsManagement() {
//   const queryClient = useQueryClient()
//   const { success, error: showError } = useNotification()
//   const theme = useTheme()
//   const isLargeScreen = useMediaQuery(theme.breakpoints.up('md'))

//   // ====================== State Management ======================
//   const [search, setSearch] = useState('')
//   const debouncedSearch = useDebounce(search, 500)

//   const [filters, setFilters] = useState({
//     minCapacity: '',
//     maxCapacity: '',
//     minPrice: '',
//     maxPrice: '',
//     isActive: 'all'
//   })

//   const [dialogOpen, setDialogOpen] = useState(false)
//   const [viewDialogOpen, setViewDialogOpen] = useState(false)
//   const [exportDialogOpen, setExportDialogOpen] = useState(false)
//   const [filterDialogOpen, setFilterDialogOpen] = useState(false)

//   const [editingHall, setEditingHall] = useState(null)
//   const [viewingHall, setViewingHall] = useState(null)

//   const [confirmDialog, setConfirmDialog] = useState({
//     open: false,
//     hall: null,
//     title: '',
//     message: '',
//     action: 'delete'
//   })

//   const [exportOptions, setExportOptions] = useState({
//     format: 'excel',
//     includeInactive: false,
//     columns: ['name', 'location', 'capacity', 'tables', 'chairs', 'defaultPrices', 'manager', 'status']
//   })

//   const [sortConfig, setSortConfig] = useState({
//     field: 'name',
//     direction: 'asc'
//   })

//   // Pagination State
//   const [pagination, setPagination] = useState({
//     page: 1,
//     limit: 10,
//     total: 0,
//     totalPages: 0
//   })

//   // Dynamic schema based on editing state
//   const hallSchema = useMemo(() => 
//     createHallSchema(editingHall), 
//     [editingHall]
//   )

//   // ====================== Form Setup ======================
//   const { control, handleSubmit, reset, formState: { errors } } = useForm({
//     resolver: zodResolver(hallSchema),
//     defaultValues: {
//       name: '',
//       location: '',
//       capacity: '',
//       tables: '',
//       chairs: '',
//       maxEmployees: '',
//       defaultPrices: '',
//       managerName: '',
//       managerPhone: '',
//       managerPassword: '',
//       description: '',
//       isActive: true
//     }
//   })

//   // ====================== Data Fetching ======================
//   const { data: hallsResponse, isLoading, error, isFetching, refetch } = useQuery({
//     queryKey: [QUERY_KEYS.ADMIN_HALLS, {
//       search: debouncedSearch,
//       page: pagination.page,
//       limit: pagination.limit,
//       sortBy: sortConfig.field,
//       sortOrder: sortConfig.direction,
//       ...filters
//     }],
//     queryFn: () => getHallsList({
//       search: debouncedSearch,
//       page: pagination.page,
//       limit: pagination.limit,
//       sortBy: sortConfig.field,
//       sortOrder: sortConfig.direction,
//       ...Object.fromEntries(
//         Object.entries(filters).filter(([key, value]) => value !== '' && value !== 'all')
//       )
//     }),
//     keepPreviousData: true,
//     staleTime: 30000,
//     cacheTime: 60000
//   })

//   // Update pagination from response
//   useEffect(() => {
//     if (hallsResponse?.pagination) {
//       setPagination(prev => ({
//         ...prev,
//         total: hallsResponse.pagination.totalItems || 0,
//         totalPages: hallsResponse.pagination.totalPages || 1
//       }))
//     }
//   }, [hallsResponse])

//   // ====================== Data Processing ======================
//   const normalizedHalls = useMemo(() => {
//     if (!hallsResponse?.data || !Array.isArray(hallsResponse.data)) {
//       return []
//     }

//     return hallsResponse.data.map(hall => ({
//       id: hall.id || hall._id,
//       name: hall.name || 'غير محدد',
//       location: hall.location || 'غير محدد',
//       capacity: hall.capacity || 0,
//       tables: hall.tables || 0,
//       chairs: hall.chairs || 0,
//       maxEmployees: hall.maxEmployees || 0,
//       defaultPrices: hall.defaultPrices || 0,
//       manager: {
//         name: hall.generalManager?.name || 'غير معين',
//         phone: hall.generalManager?.phone || '',
//         id: hall.generalManager?._id
//       },
//       description: hall.description || '',
//       amenities: Array.isArray(hall.amenities) ? hall.amenities : [],
//       services: Array.isArray(hall.services) ? hall.services : [],
//       images: Array.isArray(hall.images) ? hall.images : [],
//       isActive: hall.isActive !== false,
//       createdAt: hall.createdAt ? new Date(hall.createdAt) : new Date(),
//       updatedAt: hall.updatedAt ? new Date(hall.updatedAt) : new Date(),
//       primaryImage: hall.primaryImage
//     }))
//   }, [hallsResponse])

//   // Filtered halls for display
//   const displayedHalls = useMemo(() => {
//     return normalizedHalls
//   }, [normalizedHalls])

//   // Table columns for large screens
//   const tableColumns = useMemo(() => [
//     {
//       id: 'name',
//       label: 'اسم القاعة',
//       align: 'right',
//       format: (value, row) => (
//         <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
//           <Building2 size={18} style={{ color: 'var(--color-secondary-500)' }} />
//           <MuiTypography variant="body2" sx={{ fontWeight: 600 }}>
//             {value}
//           </MuiTypography>
//         </MuiBox>
//       )
//     },
//     {
//       id: 'location',
//       label: 'الموقع',
//       align: 'right',
//       format: (value) => (
//         <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
//           <MapPin size={14} style={{ color: 'var(--color-text-secondary)' }} />
//           <MuiTypography variant="body2">{value}</MuiTypography>
//         </MuiBox>
//       )
//     },
//     {
//       id: 'capacity',
//       label: 'السعة',
//       align: 'center',
//       format: (value) => (
//         <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5, justifyContent: 'center' }}>
//           <Users size={16} style={{ color: 'var(--color-info-500)' }} />
//           <MuiTypography variant="body2" sx={{ fontWeight: 600 }}>
//             {new Intl.NumberFormat('en-US').format(value)}
//           </MuiTypography>
//         </MuiBox>
//       )
//     },
//     {
//       id: 'defaultPrices',
//       label: 'السعر الافتراضي',
//       align: 'center',
//       format: (value) => (
//         <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5, justifyContent: 'center' }}>
//           {/* <DollarSign size={16} style={{ color: 'var(--color-success-500)' }} /> */}
//           <MuiTypography variant="body2" sx={{ fontWeight: 600, color: 'var(--color-success-500)' }}>
//             {formatCurrency(value)}
//           </MuiTypography>
//         </MuiBox>
//       )
//     },
//     {
//       id: 'manager',
//       label: 'المدير',
//       align: 'right',
//       format: (value, row) => (
//         <MuiBox>
//           <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 0.5 }}>
//             <User size={14} style={{ color: 'var(--color-text-secondary)' }} />
//             <MuiTypography variant="body2" sx={{ fontSize: '0.875rem' }}>
//               {row.manager?.name || 'غير معين'}
//             </MuiTypography>
//           </MuiBox>
//           {row.manager?.phone && (
//             <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
//               <Phone size={12} style={{ color: 'var(--color-text-secondary)' }} />
//               <MuiTypography variant="caption" sx={{ fontSize: '0.75rem', color: 'var(--color-text-secondary)' }}>
//                 {formatPhoneNumber(row.manager.phone)}
//               </MuiTypography>
//             </MuiBox>
//           )}
//         </MuiBox>
//       )
//     },
//     {
//       id: 'isActive',
//       label: 'الحالة',
//       align: 'center',
//       format: (value) => (
//         <MuiChip
//           label={value ? 'نشطة' : 'غير نشطة'}
//           color={value ? 'success' : 'warning'}
//           size="small"
//           icon={value ? <CheckCircle size={14} /> : <XCircle size={14} />}
//           sx={{ fontWeight: 600 }}
//         />
//       )
//     }
//   ], [])

//   // ====================== Mutations ======================
//   const addMutation = useMutation({
//     mutationFn: createHall,
//     onSuccess: (data) => {
//       success('تم إضافة القاعة بنجاح')
//       queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
//       queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_STATS] })
//       handleCloseDialog()
//     },
//     onError: (err) => {
//       const errorMessage = err.isAuthError
//         ? 'جلسة العمل منتهية. يرجى تسجيل الدخول مرة أخرى'
//         : err.response?.data?.message || err.message || 'فشل إضافة القاعة'
//       showError(errorMessage)
//     },
//   })

//   const editMutation = useMutation({
//     mutationFn: ({ id, data }) => updateHall(id, data),
//     onSuccess: () => {
//       success('تم تعديل القاعة بنجاح')
//       queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
//       handleCloseDialog()
//     },
//     onError: (err) => {
//       const errorMessage = err.isAuthError
//         ? 'جلسة العمل منتهية. يرجى تسجيل الدخول مرة أخرى'
//         : err.response?.data?.message || err.message || 'فشل تعديل القاعة'
//       showError(errorMessage)
//     },
//   })

//   const deleteMutation = useMutation({
//     mutationFn: deleteHall,
//     onSuccess: () => {
//       success('تم حذف القاعة بنجاح')
//       queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
//       queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_STATS] })
//       handleCloseConfirm()
//     },
//     onError: (err) => {
//       const errorMessage = err.isAuthError
//         ? 'جلسة العمل منتهية. يرجى تسجيل الدخول مرة أخرى'
//         : err.response?.data?.message || err.message || 'فشل حذف القاعة'
//       showError(errorMessage)
//     },
//   })

//   const toggleStatusMutation = useMutation({
//     mutationFn: ({ id, isActive }) => updateHall(id, { isActive }),
//     onSuccess: (_, variables) => {
//       success(`تم ${variables.isActive ? 'تفعيل' : 'تعطيل'} القاعة بنجاح`)
//       queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
//     },
//     onError: (err) => {
//       showError(err.response?.data?.message || err.message || 'فشل تغيير حالة القاعة')
//     }
//   })

//   // ====================== Event Handlers ======================
//   const handleOpenDialog = (hall = null) => {
//     setEditingHall(hall)
//     if (hall) {
//       reset({
//         name: hall.name,
//         location: hall.location,
//         capacity: hall.capacity,
//         tables: hall.tables,
//         chairs: hall.chairs,
//         maxEmployees: hall.maxEmployees,
//         defaultPrices: hall.defaultPrices,
//         managerName: hall.manager?.name || '',
//         managerPhone: hall.manager?.phone || '',
//         managerPassword: '',
//         description: hall.description || '',
//         isActive: hall.isActive
//       })
//     } else {
//       reset({
//         name: '',
//         location: '',
//         capacity: '',
//         tables: '',
//         chairs: '',
//         maxEmployees: '',
//         defaultPrices: '',
//         managerName: '',
//         managerPhone: '',
//         managerPassword: '',
//         description: '',
//         isActive: true
//       })
//     }
//     setDialogOpen(true)
//   }

//   const handleCloseDialog = () => {
//     setDialogOpen(false)
//     setEditingHall(null)
//     reset()
//   }

//   const handleOpenViewDialog = (hall) => {
//     setViewingHall(hall)
//     setViewDialogOpen(true)
//   }

//   const handleCloseViewDialog = () => {
//     setViewDialogOpen(false)
//     setViewingHall(null)
//   }

//   const handleOpenFilterDialog = () => {
//     setFilterDialogOpen(true)
//   }

//   const handleCloseFilterDialog = () => {
//     setFilterDialogOpen(false)
//   }

//   const handleApplyFilters = () => {
//     setPagination(prev => ({ ...prev, page: 1 }))
//     handleCloseFilterDialog()
//   }

//   const handleResetFilters = () => {
//     setFilters({
//       minCapacity: '',
//       maxCapacity: '',
//       minPrice: '',
//       maxPrice: '',
//       isActive: 'all'
//     })
//     setPagination(prev => ({ ...prev, page: 1 }))
//     handleCloseFilterDialog()
//   }

//   const handleOpenConfirm = (hall, action = 'delete') => {
//     let title = ''
//     let message = ''

//     switch (action) {
//       case 'delete':
//         title = 'حذف القاعة'
//         message = `هل أنت متأكد من حذف القاعة "${hall.name}"؟ سيتم حذف جميع البيانات المرتبطة بها ولا يمكن التراجع عن هذا الإجراء.`
//         break
//       case 'deactivate':
//         title = 'تعطيل القاعة'
//         message = `هل أنت متأكد من تعطيل القاعة "${hall.name}"؟ لن تكون متاحة للحجوزات الجديدة.`
//         break
//       case 'activate':
//         title = 'تفعيل القاعة'
//         message = `هل أنت متأكد من تفعيل القاعة "${hall.name}"؟`
//         break
//     }

//     setConfirmDialog({
//       open: true,
//       hall,
//       title,
//       message,
//       action
//     })
//   }

//   const handleCloseConfirm = () => {
//     setConfirmDialog({
//       open: false,
//       hall: null,
//       title: '',
//       message: '',
//       action: 'delete'
//     })
//   }

//   const handleConfirmAction = async () => {
//     const { hall, action } = confirmDialog

//     try {
//       switch (action) {
//         case 'delete':
//           await deleteMutation.mutateAsync(hall.id)
//           break
//         case 'deactivate':
//           await toggleStatusMutation.mutateAsync({ id: hall.id, isActive: false })
//           break
//         case 'activate':
//           await toggleStatusMutation.mutateAsync({ id: hall.id, isActive: true })
//           break
//       }
//     } catch (error) {
//       // Error handled in mutation
//     }
//   }

//   const handleOpenExportDialog = () => {
//     setExportDialogOpen(true)
//   }

//   const handleCloseExportDialog = () => {
//     setExportDialogOpen(false)
//   }

//   // ====================== Form Submission ======================
//   const onSubmit = async (data) => {
//     try {
//       const payload = { 
//         name: data.name,
//         location: data.location,
//         capacity: Number(data.capacity),
//         tables: Number(data.tables),
//         chairs: Number(data.chairs),
//         maxEmployees: Number(data.maxEmployees),
//         defaultPrices: Number(data.defaultPrices),
//         description: data.description || '',
//         isActive: data.isActive,
//         generalManager: {
//           name: data.managerName,
//           phone: data.managerPhone,
//           ...(data.managerPassword && { password: data.managerPassword })
//         }
//       }

//       if (editingHall) {
//         // عند التعديل، لا نرسل كلمة المرور إذا كانت فارغة
//         if (!data.managerPassword) {
//           delete payload.generalManager.password
//         }
//         await editMutation.mutateAsync({ id: editingHall.id, data: payload })
//       } else {
//         // عند الإضافة، كلمة المرور مطلوبة
//         await addMutation.mutateAsync(payload)
//       }
//     } catch (error) {
//       // Error handled in mutation
//     }
//   }

//   // ====================== Export Functions ======================
//   const handleExportData = () => {
//     try {
//       // جمع جميع البيانات للتصدير
//       const exportData = normalizedHalls.map(hall => ({
//         'اسم القاعة': hall.name,
//         'الموقع': hall.location,
//         'السعة': hall.capacity,
//         'عدد الطاولات': hall.tables,
//         'عدد الكراسي': hall.chairs,
//         'الحد الأقصى للموظفين': hall.maxEmployees,
//         'السعر (للشخص)': formatCurrency(hall.defaultPrices),
//         'اسم المدير': hall.manager.name,
//         'هاتف المدير': formatPhoneNumber(hall.manager.phone),
//         'الحالة': hall.isActive ? 'نشطة' : 'غير نشطة',
//         'تاريخ الإنشاء': hall.createdAt.toLocaleDateString('ar-SA'),
//         'تاريخ التحديث': hall.updatedAt.toLocaleDateString('ar-SA'),
//         'الوصف': hall.description,
//         'عدد المرافق': hall.amenities.length,
//         'عدد الخدمات': hall.services.length
//       }))

//       // إنشاء ورقة عمل Excel
//       const worksheet = XLSX.utils.json_to_sheet(exportData)
//       const workbook = XLSX.utils.book_new()
//       XLSX.utils.book_append_sheet(workbook, worksheet, 'القاعات')

//       // تنسيق الأعمدة
//       const wscols = [
//         { wch: 25 }, // اسم القاعة
//         { wch: 30 }, // الموقع
//         { wch: 10 }, // السعة
//         { wch: 15 }, // الطاولات
//         { wch: 15 }, // الكراسي
//         { wch: 20 }, // الحد الأقصى للموظفين
//         { wch: 15 }, // السعر
//         { wch: 20 }, // اسم المدير
//         { wch: 15 }, // هاتف المدير
//         { wch: 10 }, // الحالة
//         { wch: 15 }, // تاريخ الإنشاء
//         { wch: 15 }, // تاريخ التحديث
//         { wch: 40 }, // الوصف
//         { wch: 15 }, // المرافق
//         { wch: 15 }  // الخدمات
//       ]
//       worksheet['!cols'] = wscols

//       // حفظ الملف
//       const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' })
//       const blob = new Blob([excelBuffer], { 
//         type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
//       })

//       const fileName = generateExportFileName('halls')
//       saveAs(blob, fileName)

//       success('تم تصدير البيانات بنجاح')
//       handleCloseExportDialog()
//     } catch (error) {
//       showError('فشل تصدير البيانات: ' + error.message)
//     }
//   }

//   // ====================== Pagination Handlers ======================
//   const handlePageChange = (event, newPage) => {
//     setPagination(prev => ({ ...prev, page: newPage }))
//   }

//   const handleRowsPerPageChange = (newLimit) => {
//     setPagination(prev => ({ 
//       ...prev, 
//       limit: newLimit,
//       page: 1
//     }))
//   }

//   const handleSort = (field) => {
//     setSortConfig(prev => ({
//       field,
//       direction: prev.field === field && prev.direction === 'asc' ? 'desc' : 'asc'
//     }))
//   }

//   const handleRefresh = () => {
//     refetch()
//     success('تم تحديث البيانات')
//   }

//   // ====================== UI Helpers ======================
//   const getSortIcon = (field) => {
//     if (sortConfig.field !== field) return null
//     return sortConfig.direction === 'asc' ? '↑' : '↓'
//   }

//   const isSubmitting = addMutation.isPending || editMutation.isPending

//   // ====================== Render ======================
//   return (
//     <>
//       <SEOHead 
//         pageKey="hallsManagement" 
//         title="إدارة القاعات | INVOCCA" 
//         description="إدارة قاعات المناسبات والحفلات، إضافة وتعديل وحذف القاعات"
//       />

//       {/* Main Header */}
//       <MuiBox sx={{ mb: { xs: 2, sm: 3, md: 4 } }}>
//         <MuiBox sx={{ 
//           display: 'flex', 
//           alignItems: { xs: 'flex-start', sm: 'center' }, 
//           justifyContent: 'space-between', 
//           flexDirection: { xs: 'column', sm: 'row' },
//           flexWrap: 'wrap',
//           gap: { xs: 2, sm: 2, md: 3 },
//           mb: { xs: 2, sm: 2.5, md: 3 }
//         }}>
//           <MuiBox>
//             <MuiTypography
//               variant="h4"
//               sx={{
//                 fontWeight: 800,
//                 background: 'linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%)',
//                 WebkitBackgroundClip: 'text',
//                 WebkitTextFillColor: 'transparent',
//                 backgroundClip: 'text',
//                 mb: 1,
//                 fontSize: { xs: '1.75rem', md: '2rem' }
//               }}
//             >
//               إدارة القاعات
//             </MuiTypography>
//             <MuiTypography
//               variant="body2"
//               sx={{ color: 'var(--color-text-secondary)' }}
//             >
//               {hallsResponse?.pagination
//                 ? `إجمالي ${hallsResponse.pagination.totalItems || 0} قاعة • ${displayedHalls.filter(h => h.isActive).length} نشطة`
//                 : 'جاري تحميل البيانات...'}
//             </MuiTypography>
//           </MuiBox>

//           {/* Search and Actions */}
//           <MuiBox sx={{ 
//             display: 'flex', 
//             alignItems: 'center', 
//             gap: { xs: 1, sm: 1.5, md: 2 }, 
//             flexWrap: 'wrap',
//             width: { xs: '100%', sm: 'auto' },
//             justifyContent: { xs: 'flex-start', md: 'flex-end' }
//           }}>
//             <MuiTextField
//               placeholder="ابحث عن قاعة..."
//               value={search}
//               onChange={(e) => setSearch(e.target.value)}
//               size="small"
//               sx={{
//                 width: { xs: '100%', sm: 250 },
//                 '& .MuiOutlinedInput-root': {
//                   borderRadius: '12px',
//                   backgroundColor: 'rgba(255, 255, 255, 0.9)',
//                   '&:hover': {
//                     backgroundColor: 'rgba(255, 255, 255, 1)',
//                   }
//                 }
//               }}
//               startIcon={<Search size={18} style={{ color: 'var(--color-text-secondary)' }} />}
//             />

//             <MuiButton
//               variant="outlined"
//               onClick={handleOpenFilterDialog}
//               start_icon={<Filter size={16} />}
//               sx={{
//                 borderRadius: '12px',
//                 borderColor: 'var(--color-border)',
//                 fontSize: { xs: '0.75rem', sm: '0.875rem' },
//                 padding: { xs: '6px 12px', sm: '8px 16px' },
//                 minWidth: { xs: 'auto', sm: '80px' },
//                 '&:hover': {
//                   borderColor: 'var(--color-primary-500)',
//                   backgroundColor: 'var(--color-primary-50)'
//                 }
//               }}
//               size="small"
//             >
//               تصفية
//             </MuiButton>

//             <MuiButton
//               variant="outlined"
//               onClick={handleRefresh}
//               start_icon={<RefreshCw size={16} />}
//               disabled={isFetching}
//               sx={{
//                 borderRadius: '12px',
//                 borderColor: 'var(--color-border)',
//                 fontSize: { xs: '0.75rem', sm: '0.875rem' },
//                 padding: { xs: '6px 12px', sm: '8px 16px' },
//                 minWidth: { xs: 'auto', sm: '80px' },
//                 '&:hover': {
//                   borderColor: 'var(--color-primary-500)',
//                   backgroundColor: 'var(--color-primary-50)'
//                 }
//               }}
//               size="small"
//             >
//               {isFetching ? 'جاري...' : 'تحديث'}
//             </MuiButton>

//             <MuiButton
//               variant="outlined"
//               onClick={handleOpenExportDialog}
//               start_icon={<Download size={16} />}
//               sx={{
//                 borderRadius: '12px',
//                 borderColor: 'var(--color-border)',
//                 fontSize: { xs: '0.75rem', sm: '0.875rem' },
//                 padding: { xs: '6px 12px', sm: '8px 16px' },
//                 minWidth: { xs: 'auto', sm: '80px' },
//                 '&:hover': {
//                   borderColor: 'var(--color-primary-500)',
//                   backgroundColor: 'var(--color-primary-50)'
//                 }
//               }}
//               size="small"
//             >
//               تصدير
//             </MuiButton>

//             <MuiButton
//               variant="contained"
//               onClick={() => handleOpenDialog()}
//               start_icon={<Plus size={16} />}
//               sx={{
//                 borderRadius: '12px',
//                 background: 'linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%)',
//                 boxShadow: '0 4px 12px rgba(26, 26, 26, 0.2)',
//                 fontSize: { xs: '0.75rem', sm: '0.875rem' },
//                 padding: { xs: '6px 12px', sm: '8px 16px' },
//                 minWidth: { xs: 'auto', sm: '100px' },
//                 '&:hover': {
//                   boxShadow: '0 6px 20px rgba(26, 26, 26, 0.3)',
//                   transform: 'translateY(-1px)'
//                 }
//               }}
//               size="small"
//             >
//               إضافة قاعة
//             </MuiButton>
//           </MuiBox>
//         </MuiBox>
//       </MuiBox>

//       {/* Loading State */}
//       {isLoading ? (
//         <LoadingScreen 
//           message="جاري تحميل بيانات القاعات..." 
//           fullScreen={false}
//           progress
//         />
//       ) : error ? (
//         <EmptyState
//           title="حدث خطأ"
//           description={error.message || 'فشل تحميل قائمة القاعات'}
//           icon={AlertCircle}
//           showPaper
//           action={
//             <MuiButton
//               variant="contained"
//               onClick={() => refetch()}
//               start_icon={<RefreshCw size={20} />}
//             >
//               إعادة المحاولة
//             </MuiButton>
//           }
//         />
//       ) : displayedHalls.length === 0 ? (
//         <EmptyState
//           title="لا توجد قاعات"
//           description={
//             debouncedSearch || Object.values(filters).some(v => v !== '' && v !== 'all')
//               ? 'لا توجد نتائج مطابقة لبحثك أو تصفيتك'
//               : "لم يتم إضافة أي قاعات بعد. ابدأ بإضافة قاعة جديدة"
//           }
//           icon={Building2}
//           showPaper
//           action={
//             <MuiButton variant="contained" onClick={() => handleOpenDialog()}>
//               إضافة قاعة جديدة
//             </MuiButton>
//           }
//         />
//       ) : (
//         <>
//           {/* Stats Bar */}
//           <MuiBox sx={{ 
//             mb: 3, 
//             display: 'flex', 
//             gap: 1, 
//             flexWrap: 'wrap',
//             justifyContent: { xs: 'center', sm: 'flex-start' }
//           }}>
//             <MuiChip
//               label={`إجمالي: ${hallsResponse?.pagination?.totalItems || 0}`}
//               color="primary"
//               variant="outlined"
//               icon={<Building2 size={16} />}
//               size="small"
//             />
//             <MuiChip
//               label={`نشطة: ${displayedHalls.filter(h => h.isActive).length}`}
//               color="success"
//               variant="outlined"
//               icon={<CheckCircle size={16} />}
//               size="small"
//             />
//             <MuiChip
//               label={`متوسط السعة: ${Math.round(displayedHalls.reduce((acc, h) => acc + h.capacity, 0) / displayedHalls.length)}`}
//               color="info"
//               variant="outlined"
//               icon={<Users size={16} />}
//               size="small"
//             />
//           </MuiBox>

//           {/* Fetching Indicator */}
//           {isFetching && (
//             <MuiAlert 
//               severity="info" 
//               sx={{ mb: 2 }}
//               icon={<MuiCircularProgress size={20} />}
//             >
//               جاري تحديث البيانات...
//             </MuiAlert>
//           )}

//           {/* Responsive View: Table for large screens, Cards for small screens */}
//           {isLargeScreen ? (
//             <DataTable
//               columns={tableColumns}
//               rows={displayedHalls}
//               onView={handleOpenViewDialog}
//               onEdit={handleOpenDialog}
//               onDelete={(hall) => handleOpenConfirm(hall, 'delete')}
//               onToggleStatus={(hall) => toggleStatusMutation.mutate({ id: hall.id, isActive: !hall.isActive })}
//               pagination={{
//                 page: pagination.page - 1,
//                 limit: pagination.limit,
//                 total: hallsResponse?.pagination?.totalItems || 0
//               }}
//               onPageChange={(newPage) => setPagination(prev => ({ ...prev, page: newPage + 1 }))}
//               onRowsPerPageChange={(newLimit) => setPagination(prev => ({ 
//                 ...prev, 
//                 limit: newLimit,
//                 page: 1
//               }))}
//               emptyMessage="لا توجد قاعات"
//             />
//           ) : (
//             <>
//               <CardsView
//                 data={displayedHalls}
//                 columns={{ xs: 1, sm: 2 }}
//                 renderCard={(hall) => (
//               <MuiCard
//                 sx={{
//                   height: '100%',
//                   width: '100%',
//                   maxWidth: '100%',
//                   display: 'flex',
//                   flexDirection: 'column',
//                   opacity: hall.isActive ? 1 : 0.7,
//                   transition: 'all 0.3s ease',
//                 }}
//               >
//                 {/* Image Section */}
//                 <MuiBox
//                   sx={{
//                     height: 180,
//                     background: hall.primaryImage
//                       ? `url(${hall.primaryImage}) center/cover`
//                       : 'linear-gradient(135deg, var(--color-secondary-400) 0%, var(--color-secondary-600) 100%)',
//                     position: 'relative',
//                     display: 'flex',
//                     alignItems: 'center',
//                     justifyContent: 'center',
//                   }}
//                 >
//                   {!hall.primaryImage && (
//                     <Building2 size={64} style={{ color: 'white', opacity: 0.3 }} />
//                   )}
//                   <MuiChip
//                     label={hall.isActive ? 'نشطة' : 'غير نشطة'}
//                     color={hall.isActive ? 'success' : 'warning'}
//                     size="small"
//                     sx={{
//                       position: 'absolute',
//                       top: 12,
//                       left: 12,
//                       fontWeight: 600
//                     }}
//                     icon={hall.isActive ? <CheckCircle size={14} /> : <XCircle size={14} />}
//                   />
//                 </MuiBox>

//                 <MuiCardContent sx={{ flex: 1, p: 2.5, display: 'flex', flexDirection: 'column' }}>
//                   {/* Title */}
//                   <MuiTypography
//                     variant="h6"
//                     sx={{
//                       fontWeight: 700,
//                       mb: 1.5,
//                       color: 'var(--color-primary-500)',
//                       fontSize: '1rem',
//                       display: 'flex',
//                       alignItems: 'flex-start',
//                       gap: 1,
//                       lineHeight: 1.4,
//                       minHeight: '48px'
//                     }}
//                   >
//                     <Building2 size={18} style={{ flexShrink: 0, marginTop: '2px' }} />
//                     <span style={{ flex: 1, wordBreak: 'break-word', lineHeight: 1.4 }}>{hall.name}</span>
//                   </MuiTypography>

//                   {/* Location */}
//                   <MuiBox sx={{ display: 'flex', alignItems: 'flex-start', gap: 1, mb: 2, color: 'var(--color-text-secondary)', minHeight: '40px' }}>
//                     <MapPin size={16} style={{ marginTop: '2px', flexShrink: 0 }} />
//                     <MuiTypography variant="body2" sx={{ fontSize: '0.875rem', lineHeight: 1.5, wordBreak: 'break-word', flex: 1 }}>
//                       {hall.location}
//                     </MuiTypography>
//                   </MuiBox>

//                   {/* Stats Grid */}
//                   <MuiGrid container spacing={1.5} sx={{ mb: 2 }}>
//                     <MuiGrid item xs={6}>
//                       <MuiBox sx={{ 
//                         p: 1.25, 
//                         borderRadius: '10px', 
//                         backgroundColor: 'rgba(59, 130, 246, 0.1)',
//                         display: 'flex',
//                         alignItems: 'center',
//                         gap: 0.75,
//                         minHeight: '60px'
//                       }}>
//                         <Users size={16} style={{ color: 'var(--color-info-500)', flexShrink: 0 }} />
//                         <MuiBox sx={{ flex: 1, minWidth: 0 }}>
//                           <MuiTypography variant="caption" sx={{ display: 'block', color: 'var(--color-text-secondary)', fontSize: '0.7rem', mb: 0.25 }}>
//                             السعة
//                           </MuiTypography>
//                           <MuiTypography variant="body2" sx={{ fontWeight: 700, color: 'var(--color-info-500)', fontSize: '0.875rem', lineHeight: 1.2 }}>
//                             {new Intl.NumberFormat('en-US').format(hall.capacity)}
//                           </MuiTypography>
//                         </MuiBox>
//                       </MuiBox>
//                     </MuiGrid>
//                     <MuiGrid item xs={6}>
//                       <MuiBox sx={{ 
//                         p: 1.25, 
//                         borderRadius: '10px', 
//                         backgroundColor: 'rgba(34, 197, 94, 0.1)',
//                         display: 'flex',
//                         alignItems: 'center',
//                         gap: 0.75,
//                         minHeight: '60px'
//                       }}>
//                         {/* <DollarSign size={16} style={{ color: 'var(--color-success-500)', flexShrink: 0 }} /> */}
//                         <MuiBox sx={{ flex: 1, minWidth: 0 }}>
//                           <MuiTypography variant="caption" sx={{ display: 'block', color: 'var(--color-text-secondary)', fontSize: '0.7rem', mb: 0.25 }}>
//                             السعر
//                           </MuiTypography>
//                           <MuiTypography variant="body2" sx={{ fontWeight: 700, color: 'var(--color-success-500)', fontSize: '0.875rem', lineHeight: 1.2, wordBreak: 'break-word' }}>
//                             {formatCurrency(hall.defaultPrices)}
//                           </MuiTypography>
//                         </MuiBox>
//                       </MuiBox>
//                     </MuiGrid>
//                     <MuiGrid item xs={6}>
//                       <MuiBox sx={{ 
//                         p: 1.25, 
//                         borderRadius: '10px', 
//                         backgroundColor: 'rgba(216, 185, 138, 0.1)',
//                         display: 'flex',
//                         alignItems: 'center',
//                         gap: 0.75,
//                         minHeight: '50px'
//                       }}>
//                         <Table size={14} style={{ color: 'var(--color-secondary-700)', flexShrink: 0 }} />
//                         <MuiTypography variant="body2" sx={{ fontSize: '0.8rem', color: 'var(--color-text-primary)', lineHeight: 1.3, wordBreak: 'break-word' }}>
//                           {new Intl.NumberFormat('en-US').format(hall.tables)} طاولة
//                         </MuiTypography>
//                       </MuiBox>
//                     </MuiGrid>
//                     <MuiGrid item xs={6}>
//                       <MuiBox sx={{ 
//                         p: 1.25, 
//                         borderRadius: '10px', 
//                         backgroundColor: 'rgba(216, 185, 138, 0.1)',
//                         display: 'flex',
//                         alignItems: 'center',
//                         gap: 0.75,
//                         minHeight: '50px'
//                       }}>
//                         <Chair size={14} style={{ color: 'var(--color-secondary-700)', flexShrink: 0 }} />
//                         <MuiTypography variant="body2" sx={{ fontSize: '0.8rem', color: 'var(--color-text-primary)', lineHeight: 1.3, wordBreak: 'break-word' }}>
//                           {new Intl.NumberFormat('en-US').format(hall.chairs)} كرسي
//                         </MuiTypography>
//                       </MuiBox>
//                     </MuiGrid>
//                   </MuiGrid>

//                   {/* Manager Info */}
//                   <MuiBox sx={{ 
//                     p: 1.5, 
//                     borderRadius: '10px', 
//                     backgroundColor: 'rgba(0, 0, 0, 0.02)',
//                     border: '1px solid rgba(0, 0, 0, 0.05)'
//                   }}>
//                     <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>
//                       <User size={16} style={{ color: 'var(--color-text-secondary)' }} />
//                       <MuiTypography variant="body2" sx={{ fontWeight: 600, fontSize: '0.875rem' }}>
//                         {hall.manager.name}
//                       </MuiTypography>
//                     </MuiBox>
//                     {hall.manager.phone && (
//                       <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
//                         <Phone size={14} style={{ color: 'var(--color-text-secondary)' }} />
//                         <MuiTypography variant="caption" sx={{ fontSize: '0.75rem', color: 'var(--color-text-secondary)' }}>
//                           {formatPhoneNumber(hall.manager.phone)}
//                         </MuiTypography>
//                       </MuiBox>
//                     )}
//                   </MuiBox>
//                 </MuiCardContent>

//                 {/* Actions */}
//                 <MuiCardActions sx={{ p: 2, pt: 0, gap: 1, flexWrap: 'wrap' }}>
//                   <MuiButton
//                     size="small"
//                     variant="outlined"
//                     onClick={() => handleOpenViewDialog(hall)}
//                     start_icon={<Eye size={16} />}
//                     sx={{ flex: 1, minWidth: '80px' }}
//                   >
//                     عرض
//                   </MuiButton>
//                   <MuiButton
//                     size="small"
//                     variant="outlined"
//                     onClick={() => handleOpenDialog(hall)}
//                     start_icon={<Pencil size={16} />}
//                     sx={{ flex: 1, minWidth: '80px' }}
//                   >
//                     تعديل
//                   </MuiButton>
//                   <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
//                     <MuiSwitch
//                       checked={hall.isActive}
//                       onChange={(e) => {
//                         e.stopPropagation()
//                         toggleStatusMutation.mutate({ id: hall.id, isActive: !hall.isActive })
//                       }}
//                       color="success"
//                       size="small"
//                     />
//                     <MuiTypography variant="caption" sx={{ fontSize: '0.75rem', color: 'var(--color-text-secondary)' }}>
//                       {hall.isActive ? 'نشطة' : 'غير نشطة'}
//                     </MuiTypography>
//                   </MuiBox>
//                   <MuiIconButton
//                     size="small"
//                     color="error"
//                     onClick={() => handleOpenConfirm(hall, 'delete')}
//                     title="حذف"
//                   >
//                     <Trash2 size={18} />
//                   </MuiIconButton>
//                 </MuiCardActions>
//               </MuiCard>
//                 )}
//               />

//               {/* Pagination for Cards View */}
//               {hallsResponse?.pagination && (
//                 <MuiPaper sx={{ mt: 3, borderRadius: '16px', overflow: 'hidden' }}>
//                   <TablePagination
//                     page={pagination.page}
//                     limit={pagination.limit}
//                     total={hallsResponse.pagination.totalItems || 0}
//                     totalPages={pagination.totalPages}
//                     onPageChange={(newPage) => setPagination(prev => ({ ...prev, page: newPage }))}
//                     onRowsPerPageChange={(newLimit) => setPagination(prev => ({ 
//                       ...prev, 
//                       limit: newLimit,
//                       page: 1
//                     }))}
//                     rowsPerPageOptions={[6, 12, 24, 48]}
//                     label="عدد القاعات في الصفحة:"
//                   />
//                 </MuiPaper>
//               )}
//             </>
//           )}
//         </>
//       )}

//       {/* ====================== Dialogs ====================== */}

//       {/* Add/Edit Dialog */}
//       <MuiDialog
//         open={dialogOpen}
//         onClose={handleCloseDialog}
//         maxWidth="md"
//         fullWidth
//         showCloseButton={false}
//         PaperProps={{
//           sx: { 
//             borderRadius: 3,
//             maxHeight: '90vh',
//             display: 'flex',
//             flexDirection: 'column',
//             overflow: 'hidden'
//           }
//         }}
//       >
//         <MuiBox sx={{ display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0, height: '100%' }}>
//           {/* Title */}
//           <MuiDialogTitle 
//             onClose={handleCloseDialog}
//             sx={{ flexShrink: 0 }}
//           >
//             <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
//               <Building2 size={24} />
//               <span>{editingHall ? 'تعديل القاعة' : 'إضافة قاعة جديدة'}</span>
//             </MuiBox>
//           </MuiDialogTitle>

//           <form onSubmit={handleSubmit(onSubmit)} style={{ display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0, overflow: 'hidden' }}>
//             <MuiDialogContent 
//               dividers 
//               sx={{ 
//                 pt: 3,
//                 flex: 1,
//                 minHeight: 0,
//               }}
//             >
//             <MuiGrid container spacing={2}>
//               {/* Basic Information */}
//               <MuiGrid item xs={12}>
//                 <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main' }}>
//                   المعلومات الأساسية
//                 </MuiTypography>
//               </MuiGrid>

//               <MuiGrid item xs={12} md={6}>
//                 <Controller
//                   name="name"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label="اسم القاعة *"
//                       fullWidth
//                       size="small"
//                       error={!!errors.name}
//                       helperText={errors.name?.message}
//                       required
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               <MuiGrid item xs={12} md={6}>
//                 <Controller
//                   name="location"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label="الموقع *"
//                       fullWidth
//                       size="small"
//                       error={!!errors.location}
//                       helperText={errors.location?.message}
//                       required
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               <MuiGrid item xs={12} md={6}>
//                 <Controller
//                   name="capacity"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label="السعة (عدد الأشخاص) *"
//                       type="number"
//                       fullWidth
//                       size="small"
//                       error={!!errors.capacity}
//                       helperText={errors.capacity?.message}
//                       required
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               <MuiGrid item xs={12} md={6}>
//                 <Controller
//                   name="defaultPrices"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label="السعر الافتراضي (للشخص) *"
//                       type="number"
//                       fullWidth
//                       size="small"
//                       error={!!errors.defaultPrices}
//                       helperText={errors.defaultPrices?.message}
//                       required
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               <MuiGrid item xs={12}>
//                 <MuiDivider sx={{ my: 2 }} />
//                 <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main' }}>
//                   المعدات والتجهيزات
//                 </MuiTypography>
//               </MuiGrid>

//               <MuiGrid item xs={12} md={4}>
//                 <Controller
//                   name="tables"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label="عدد الطاولات *"
//                       type="number"
//                       fullWidth
//                       size="small"
//                       error={!!errors.tables}
//                       helperText={errors.tables?.message}
//                       required
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               <MuiGrid item xs={12} md={4}>
//                 <Controller
//                   name="chairs"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label="عدد الكراسي *"
//                       type="number"
//                       fullWidth
//                       size="small"
//                       error={!!errors.chairs}
//                       helperText={errors.chairs?.message}
//                       required
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               <MuiGrid item xs={12} md={4}>
//                 <Controller
//                   name="maxEmployees"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label="الحد الأقصى للموظفين *"
//                       type="number"
//                       fullWidth
//                       size="small"
//                       error={!!errors.maxEmployees}
//                       helperText={errors.maxEmployees?.message}
//                       required
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               <MuiGrid item xs={12}>
//                 <Controller
//                   name="description"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label="الوصف"
//                       fullWidth
//                       size="small"
//                       multiline
//                       rows={2}
//                       error={!!errors.description}
//                       helperText={errors.description?.message}
//                       placeholder="وصف مختصر للقاعة والمميزات..."
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               <MuiGrid item xs={12}>
//                 <MuiDivider sx={{ my: 2 }} />
//                 <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main' }}>
//                   بيانات المدير
//                 </MuiTypography>
//               </MuiGrid>

//               <MuiGrid item xs={12} md={6}>
//                 <Controller
//                   name="managerName"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label="اسم المدير *"
//                       fullWidth
//                       size="small"
//                       error={!!errors.managerName}
//                       helperText={errors.managerName?.message}
//                       required
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               <MuiGrid item xs={12} md={6}>
//                 <Controller
//                   name="managerPhone"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label="رقم هاتف المدير *"
//                       fullWidth
//                       size="small"
//                       error={!!errors.managerPhone}
//                       helperText={errors.managerPhone?.message}
//                       required
//                       placeholder="أرقام فقط"
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               <MuiGrid item xs={12} md={6}>
//                 <Controller
//                   name="managerPassword"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiTextField
//                       {...field}
//                       label={editingHall ? "كلمة المرور (اتركها فارغة للإبقاء على الحالية)" : "كلمة المرور *"}
//                       type="password"
//                       fullWidth
//                       size="small"
//                       error={!!errors.managerPassword}
//                       helperText={errors.managerPassword?.message}
//                       required={!editingHall}
//                     />
//                   )}
//                 />
//               </MuiGrid>

//               {/* Status Field باستخدام أزرار بدلاً من Checkbox */}
//               <MuiGrid item xs={12}>
//                 <MuiDivider sx={{ my: 2 }} />
//                 <MuiTypography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
//                   حالة القاعة:
//                 </MuiTypography>
//                 <Controller
//                   name="isActive"
//                   control={control}
//                   render={({ field }) => (
//                     <MuiBox sx={{ display: 'flex', gap: 2 }}>
//                       <MuiButton
//                         variant={field.value ? "contained" : "outlined"}
//                         color="success"
//                         size="small"
//                         onClick={() => field.onChange(true)}
//                         start_icon={<Check size={16} />}
//                       >
//                         نشطة
//                       </MuiButton>
//                       <MuiButton
//                         variant={!field.value ? "contained" : "outlined"}
//                         color="warning"
//                         size="small"
//                         onClick={() => field.onChange(false)}
//                         start_icon={<X size={16} />}
//                       >
//                         غير نشطة
//                       </MuiButton>
//                     </MuiBox>
//                   )}
//                 />
//               </MuiGrid>
//             </MuiGrid>
//           </MuiDialogContent>

//           <MuiDialogActions
//             sx={{
//               flexShrink: 0,
//               borderTop: '1px solid rgba(0, 0, 0, 0.12)',
//               backgroundColor: 'rgba(255, 255, 255, 0.95)',
//             }}
//           >
//             <MuiButton
//               onClick={handleCloseDialog}
//               color="inherit"
//               disabled={isSubmitting}
//               size="small"
//             >
//               إلغاء
//             </MuiButton>
//             <MuiButton
//               type="submit"
//               variant="contained"
//               color="primary"
//               disabled={isSubmitting}
//               start_icon={isSubmitting ? <MuiCircularProgress size={20} /> : null}
//               size="small"
//             >
//               {isSubmitting ? 'جاري الحفظ...' : (editingHall ? 'تحديث' : 'حفظ')}
//             </MuiButton>
//           </MuiDialogActions>
//           </form>
//         </MuiBox>
//       </MuiDialog>

//       {/* باقي الـ Dialogs (View, Filter, Export, Confirm) تبقى كما هي في الكود السابق */}
//       {/* View Dialog */}
//       <MuiDialog
//         open={viewDialogOpen}
//         onClose={handleCloseViewDialog}
//         maxWidth="sm"
//         fullWidth
//         PaperProps={{
//           sx: { 
//             borderRadius: 3,
//             maxHeight: '90vh',
//             display: 'flex',
//             flexDirection: 'column'
//           }
//         }}
//       >
//         {viewingHall && (
//           <>
//             <MuiDialogTitle onClose={handleCloseViewDialog} sx={{ 
//               backgroundColor: 'info.light', 
//               color: 'info.contrastText',
//               py: 2,
//               position: 'sticky',
//               top: 0,
//               zIndex: 1,
//               flexShrink: 0
//             }}>
//               <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2, flexWrap: 'wrap' }}>
//                 <Building2 size={24} />
//                 <span style={{ wordBreak: 'break-word' }}>تفاصيل القاعة: {viewingHall.name}</span>
//               </MuiBox>
//             </MuiDialogTitle>

//             <MuiDialogContent 
//               dividers 
//               sx={{ 
//                 pt: 3,
//                 flex: 1,
//                 overflowY: 'auto',
//                 overflowX: 'hidden'
//               }}
//             >
//               <MuiGrid container spacing={2}>
//                 <MuiGrid item xs={12}>
//                   <MuiBox sx={{ 
//                     p: 2, 
//                     backgroundColor: 'background.default', 
//                     borderRadius: 2,
//                     border: '1px solid',
//                     borderColor: 'divider'
//                   }}>
//                     <MuiTypography variant="subtitle1" sx={{ mb: 2, fontWeight: 600 }}>
//                       <Building2 size={18} style={{ marginLeft: 8, verticalAlign: 'middle' }} />
//                       المعلومات الأساسية
//                     </MuiTypography>

//                     <MuiGrid container spacing={2}>
//                       <MuiGrid item xs={12} sm={6}>
//                         <MuiTypography variant="body2" color="text.secondary">الاسم:</MuiTypography>
//                         <MuiTypography variant="body1" fontWeight="bold">{viewingHall.name}</MuiTypography>
//                       </MuiGrid>
//                       <MuiGrid item xs={12} sm={6}>
//                         <MuiTypography variant="body2" color="text.secondary">الموقع:</MuiTypography>
//                         <MuiTypography variant="body1">{viewingHall.location}</MuiTypography>
//                       </MuiGrid>
//                       <MuiGrid item xs={12} sm={6}>
//                         <MuiTypography variant="body2" color="text.secondary">السعة:</MuiTypography>
//                         <MuiTypography variant="body1">
//                           {viewingHall.capacity.toLocaleString()} شخص
//                         </MuiTypography>
//                       </MuiGrid>
//                       <MuiGrid item xs={12} sm={6}>
//                         <MuiTypography variant="body2" color="text.secondary">السعر:</MuiTypography>
//                         <MuiTypography variant="body1" color="success.main" fontWeight="bold">
//                           {formatCurrency(viewingHall.defaultPrices)} للشخص
//                         </MuiTypography>
//                       </MuiGrid>
//                       <MuiGrid item xs={12}>
//                         <MuiTypography variant="body2" color="text.secondary">الحالة:</MuiTypography>
//                         <MuiChip
//                           label={viewingHall.isActive ? 'نشطة' : 'غير نشطة'}
//                           color={viewingHall.isActive ? 'success' : 'warning'}
//                           size="small"
//                           sx={{ mt: 0.5 }}
//                         />
//                       </MuiGrid>
//                     </MuiGrid>
//                   </MuiBox>
//                 </MuiGrid>

//                 <MuiGrid item xs={12}>
//                   <MuiBox sx={{ 
//                     p: 2, 
//                     backgroundColor: 'background.default', 
//                     borderRadius: 2,
//                     border: '1px solid',
//                     borderColor: 'divider'
//                   }}>
//                     <MuiTypography variant="subtitle1" sx={{ mb: 2, fontWeight: 600 }}>
//                       <Table size={18} style={{ marginLeft: 8, verticalAlign: 'middle' }} />
//                       المعدات
//                     </MuiTypography>

//                     <MuiGrid container spacing={2}>
//                       <MuiGrid item xs={6}>
//                         <MuiTypography variant="body2" color="text.secondary">عدد الطاولات:</MuiTypography>
//                         <MuiTypography variant="body1" fontWeight="bold">
//                           {viewingHall.tables}
//                         </MuiTypography>
//                       </MuiGrid>
//                       <MuiGrid item xs={6}>
//                         <MuiTypography variant="body2" color="text.secondary">عدد الكراسي:</MuiTypography>
//                         <MuiTypography variant="body1" fontWeight="bold">
//                           {viewingHall.chairs}
//                         </MuiTypography>
//                       </MuiGrid>
//                       <MuiGrid item xs={12}>
//                         <MuiTypography variant="body2" color="text.secondary">الحد الأقصى للموظفين:</MuiTypography>
//                         <MuiTypography variant="body1">
//                           {viewingHall.maxEmployees} موظف
//                         </MuiTypography>
//                       </MuiGrid>
//                     </MuiGrid>
//                   </MuiBox>
//                 </MuiGrid>

//                 <MuiGrid item xs={12}>
//                   <MuiBox sx={{ 
//                     p: 2, 
//                     backgroundColor: 'background.default', 
//                     borderRadius: 2,
//                     border: '1px solid',
//                     borderColor: 'divider'
//                   }}>
//                     <MuiTypography variant="subtitle1" sx={{ mb: 2, fontWeight: 600 }}>
//                       <User size={18} style={{ marginLeft: 8, verticalAlign: 'middle' }} />
//                       بيانات المدير
//                     </MuiTypography>

//                     <MuiGrid container spacing={2}>
//                       <MuiGrid item xs={12} sm={6}>
//                         <MuiTypography variant="body2" color="text.secondary">الاسم:</MuiTypography>
//                         <MuiTypography variant="body1" fontWeight="bold">
//                           {viewingHall.manager.name}
//                         </MuiTypography>
//                       </MuiGrid>
//                       <MuiGrid item xs={12} sm={6}>
//                         <MuiTypography variant="body2" color="text.secondary">الهاتف:</MuiTypography>
//                         <MuiTypography variant="body1" dir="ltr">
//                           {formatPhoneNumber(viewingHall.manager.phone) || 'غير متوفر'}
//                         </MuiTypography>
//                       </MuiGrid>
//                     </MuiGrid>
//                   </MuiBox>
//                 </MuiGrid>

//                 {viewingHall.description && (
//                   <MuiGrid item xs={12}>
//                     <MuiBox sx={{ 
//                       p: 2, 
//                       backgroundColor: 'background.default', 
//                       borderRadius: 2,
//                       border: '1px solid',
//                       borderColor: 'divider'
//                     }}>
//                       <MuiTypography variant="subtitle1" sx={{ mb: 2, fontWeight: 600 }}>
//                         <FileText size={18} style={{ marginLeft: 8, verticalAlign: 'middle' }} />
//                         الوصف
//                       </MuiTypography>
//                       <MuiTypography variant="body1">
//                         {viewingHall.description}
//                       </MuiTypography>
//                     </MuiBox>
//                   </MuiGrid>
//                 )}

//                 {viewingHall.amenities && viewingHall.amenities.length > 0 && (
//                   <MuiGrid item xs={12}>
//                     <MuiBox sx={{ 
//                       p: 2, 
//                       backgroundColor: 'background.default', 
//                       borderRadius: 2,
//                       border: '1px solid',
//                       borderColor: 'divider'
//                     }}>
//                       <MuiTypography variant="subtitle1" sx={{ mb: 2, fontWeight: 600 }}>
//                         المرافق
//                       </MuiTypography>
//                       <MuiBox sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
//                         {viewingHall.amenities.map((amenity, index) => (
//                           <MuiChip
//                             key={index}
//                             label={amenity}
//                             size="small"
//                             variant="outlined"
//                             color="primary"
//                           />
//                         ))}
//                       </MuiBox>
//                     </MuiBox>
//                   </MuiGrid>
//                 )}
//               </MuiGrid>
//             </MuiDialogContent>

//             <MuiDialogActions sx={{ 
//               px: 3, 
//               py: 2, 
//               position: 'sticky', 
//               bottom: 0, 
//               backgroundColor: 'background.paper',
//               borderTop: '1px solid rgba(0, 0, 0, 0.08)',
//               zIndex: 1,
//               flexShrink: 0
//             }}>
//               <MuiButton
//                 onClick={() => {
//                   handleCloseViewDialog()
//                   handleOpenDialog(viewingHall)
//                 }}
//                 color="primary"
//                 variant="outlined"
//                 size="small"
//               >
//                 تعديل
//               </MuiButton>
//               <MuiButton
//                 onClick={handleCloseViewDialog}
//                 color="inherit"
//                 size="small"
//               >
//                 إغلاق
//               </MuiButton>
//             </MuiDialogActions>
//           </>
//         )}
//       </MuiDialog>

//       {/* Filter Dialog */}
//       <MuiDialog
//         open={filterDialogOpen}
//         onClose={handleCloseFilterDialog}
//         maxWidth="xs"
//         fullWidth
//       >
//         <MuiDialogTitle>
//           <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
//             <Filter size={24} />
//             <span>تصفية القاعات</span>
//           </MuiBox>
//         </MuiDialogTitle>

//         <MuiDialogContent dividers>
//           <MuiGrid container spacing={2}>
//             <MuiGrid item xs={12} sm={6}>
//               <MuiTextField
//                 label="الحد الأدنى للسعة"
//                 type="number"
//                 fullWidth
//                 size="small"
//                 value={filters.minCapacity}
//                 onChange={(e) => setFilters(prev => ({ ...prev, minCapacity: e.target.value }))}
//               />
//             </MuiGrid>

//             <MuiGrid item xs={12} sm={6}>
//               <MuiTextField
//                 label="الحد الأقصى للسعة"
//                 type="number"
//                 fullWidth
//                 size="small"
//                 value={filters.maxCapacity}
//                 onChange={(e) => setFilters(prev => ({ ...prev, maxCapacity: e.target.value }))}
//               />
//             </MuiGrid>

//             <MuiGrid item xs={12} sm={6}>
//               <MuiTextField
//                 label="الحد الأدنى للسعر"
//                 type="number"
//                 fullWidth
//                 size="small"
//                 value={filters.minPrice}
//                 onChange={(e) => setFilters(prev => ({ ...prev, minPrice: e.target.value }))}
//               />
//             </MuiGrid>

//             <MuiGrid item xs={12} sm={6}>
//               <MuiTextField
//                 label="الحد الأقصى للسعر"
//                 type="number"
//                 fullWidth
//                 size="small"
//                 value={filters.maxPrice}
//                 onChange={(e) => setFilters(prev => ({ ...prev, maxPrice: e.target.value }))}
//               />
//             </MuiGrid>

//             <MuiGrid item xs={12}>
//               <MuiTypography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
//                 حالة القاعة:
//               </MuiTypography>
//               <MuiBox sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
//                 <MuiButton
//                   variant={filters.isActive === 'all' ? "contained" : "outlined"}
//                   color="primary"
//                   size="small"
//                   onClick={() => setFilters(prev => ({ ...prev, isActive: 'all' }))}
//                 >
//                   الكل
//                 </MuiButton>
//                 <MuiButton
//                   variant={filters.isActive === 'active' ? "contained" : "outlined"}
//                   color="success"
//                   size="small"
//                   onClick={() => setFilters(prev => ({ ...prev, isActive: 'active' }))}
//                 >
//                   النشطة فقط
//                 </MuiButton>
//                 <MuiButton
//                   variant={filters.isActive === 'inactive' ? "contained" : "outlined"}
//                   color="warning"
//                   size="small"
//                   onClick={() => setFilters(prev => ({ ...prev, isActive: 'inactive' }))}
//                 >
//                   غير النشطة فقط
//                 </MuiButton>
//               </MuiBox>
//             </MuiGrid>
//           </MuiGrid>
//         </MuiDialogContent>

//         <MuiDialogActions>
//           <MuiButton onClick={handleResetFilters} color="inherit" size="small">
//             إعادة التعيين
//           </MuiButton>
//           <MuiButton onClick={handleCloseFilterDialog} color="inherit" size="small">
//             إلغاء
//           </MuiButton>
//           <MuiButton onClick={handleApplyFilters} variant="contained" color="primary" size="small">
//             تطبيق التصفية
//           </MuiButton>
//         </MuiDialogActions>
//       </MuiDialog>

//       {/* Export Dialog */}
//       <MuiDialog
//         open={exportDialogOpen}
//         onClose={handleCloseExportDialog}
//         maxWidth="xs"
//         fullWidth
//       >
//         <MuiDialogTitle>
//           <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
//             <Download size={24} />
//             <span>تصدير البيانات</span>
//           </MuiBox>
//         </MuiDialogTitle>

//         <MuiDialogContent dividers>
//           <MuiTypography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
//             سيتم تصدير {hallsResponse?.pagination?.totalItems || 0} قاعة بتنسيق Excel
//           </MuiTypography>

//           <MuiBox sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
//             <MuiTypography variant="body2">
//               <strong>الأعمدة المتضمنة:</strong>
//             </MuiTypography>

//             <MuiBox sx={{ pl: 2 }}>
//               {exportOptions.columns.map((column, index) => (
//                 <MuiTypography key={index} variant="body2" color="text.secondary">
//                   • {getColumnName(column)}
//                 </MuiTypography>
//               ))}
//             </MuiBox>

//             <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2, mt: 2 }}>
//               <MuiTypography variant="body2">تضمين القاعات غير النشطة:</MuiTypography>
//               <MuiButton
//                 size="small"
//                 variant={exportOptions.includeInactive ? "contained" : "outlined"}
//                 color={exportOptions.includeInactive ? "primary" : "inherit"}
//                 onClick={() => setExportOptions(prev => ({ 
//                   ...prev, 
//                   includeInactive: !prev.includeInactive 
//                 }))}
//               >
//                 {exportOptions.includeInactive ? 'نعم' : 'لا'}
//               </MuiButton>
//             </MuiBox>
//           </MuiBox>
//         </MuiDialogContent>

//         <MuiDialogActions>
//           <MuiButton onClick={handleCloseExportDialog} color="inherit" size="small">
//             إلغاء
//           </MuiButton>
//           <MuiButton 
//             onClick={handleExportData} 
//             variant="contained" 
//             color="success"
//             start_icon={<Download size={20} />}
//             size="small"
//           >
//             بدء التصدير
//           </MuiButton>
//         </MuiDialogActions>
//       </MuiDialog>

//       {/* Confirm Dialog */}
//       <ConfirmDialog
//         open={confirmDialog.open}
//         onClose={handleCloseConfirm}
//         onConfirm={handleConfirmAction}
//         title={confirmDialog.title}
//         message={confirmDialog.message}
//         confirmLabel={
//           confirmDialog.action === 'delete' ? 'حذف' :
//           confirmDialog.action === 'deactivate' ? 'تعطيل' :
//           'تفعيل'
//         }
//         confirmColor={
//           confirmDialog.action === 'delete' ? 'error' :
//           confirmDialog.action === 'deactivate' ? 'warning' :
//           'success'
//         }
//         cancelLabel="إلغاء"
//         loading={deleteMutation.isPending || toggleStatusMutation.isPending}
//       />
//     </>
//   )
// }

// // Helper function for column names
// function getColumnName(key) {
//   const columns = {
//     'name': 'اسم القاعة',
//     'location': 'الموقع',
//     'capacity': 'السعة',
//     'tables': 'الطاولات',
//     'chairs': 'الكراسي',
//     'maxEmployees': 'الموظفين',
//     'defaultPrices': 'السعر',
//     'manager': 'المدير',
//     'status': 'الحالة'
//   }
//   return columns[key] || key
// }


// src\pages\admin\HallsManagement.jsx
/**
 * Halls Management Page - إدارة القاعات
 * صفحة إدارة القاعات مع دعم كامل للـ CRUD، التصدير، والبحث المتقدم
 */



import { useState, useMemo, useEffect, useRef } from 'react'
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { useForm, Controller } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { useMediaQuery, useTheme } from '@mui/material'
import * as XLSX from 'xlsx'
import { saveAs } from 'file-saver'

// MUI Components
import MuiBox from '@/components/ui/MuiBox'
import MuiTypography from '@/components/ui/MuiTypography'
import MuiButton from '@/components/ui/MuiButton'
import MuiTextField from '@/components/ui/MuiTextField'
import MuiPaper from '@/components/ui/MuiPaper'
import MuiCard from '@/components/ui/MuiCard'
import MuiCardContent from '@/components/ui/MuiCardContent'
import MuiCardActions from '@/components/ui/MuiCardActions'
import MuiDialog from '@/components/ui/MuiDialog'
import MuiDialogTitle from '@/components/ui/MuiDialogTitle'
import MuiDialogContent from '@/components/ui/MuiDialogContent'
import MuiDialogActions from '@/components/ui/MuiDialogActions'
import MuiDivider from '@/components/ui/MuiDivider'
import MuiGrid from '@/components/ui/MuiGrid'
import MuiChip from '@/components/ui/MuiChip'
import MuiAlert from '@/components/ui/MuiAlert'
import MuiCircularProgress from '@/components/ui/MuiCircularProgress'
import MuiSelect from '@/components/ui/MuiSelect'
import MuiSwitch from '@/components/ui/MuiSwitch'
import MuiAutocomplete from '@/components/ui/MuiAutocomplete'
import MuiAvatar from '@/components/ui/MuiAvatar'

// Layout & Common Components
import DashboardLayout from '@/components/layout/DashboardLayout'
import { LoadingScreen, EmptyState, ConfirmDialog, SEOHead, CardsView, TablePagination, DataTable } from '@/components/common'

// Hooks & Utilities
import { useNotification, useDebounce } from '@/hooks'
import { QUERY_KEYS } from '@/config/constants'
import { getHallsList, createHall, updateHall, deleteHall, getServicesList } from '@/api/admin'
import { formatCurrency, formatPhoneNumber, generateExportFileName } from '@/utils/helpers'

// Icons
import {
  Building2,
  Search,
  Plus,
  Pencil,
  Trash2,
  AlertCircle,
  Eye,
  Download,
  Filter,
  RefreshCw,
  CheckCircle,
  XCircle,
  User,
  Phone,
  Users,
  DollarSign,
  MapPin,
  Table,
  Armchair as Chair,
  Check,
  X,
  FileText,
  Image as ImageIcon,
  Wifi,
  Car,
  Coffee,
  Music,
  Star,
  Upload,
  Settings,
  Shield,
  Calendar,
  Clock
} from 'lucide-react'

// Helper function for truncating text
const truncateText = (text, maxLength = 50) => {
  if (!text || typeof text !== 'string') return ''
  if (text.length <= maxLength) return text
  return text.substring(0, maxLength) + '...'
}

// ====================== Validation Schema ======================
const createHallSchema = (editingHall = null) => z.object({
  name: z.string()
    .min(3, 'اسم القاعة يجب أن يكون 3 أحرف على الأقل')
    .max(100, 'اسم القاعة طويل جداً'),
  
  location: z.string()
    .min(3, 'الموقع مطلوب')
    .max(200, 'الموقع طويل جداً'),
  
  address: z.string()
    .min(5, 'العنوان التفصيلي مطلوب')
    .max(300, 'العنوان طويل جداً'),
  
  capacity: z.coerce.number()
    .min(1, 'السعة مطلوبة')
    .max(10000, 'السعة كبيرة جداً'),
  
  tables: z.coerce.number()
    .min(1, 'عدد الطاولات مطلوب')
    .max(1000, 'عدد الطاولات كبير جداً'),
  
  chairs: z.coerce.number()
    .min(1, 'عدد الكراسي مطلوب')
    .max(10000, 'عدد الكراسي كبير جداً'),
  
  maxEmployees: z.coerce.number()
    .min(1, 'الحد الأقصى للموظفين مطلوب')
    .max(1000, 'الحد الأقصى للموظفين كبير جداً'),
  
  defaultPrices: z.coerce.number()
    .min(0, 'السعر مطلوب')
    .max(1000000, 'السعر كبير جداً'),
  
  managerName: z.string()
    .min(3, 'اسم المدير مطلوب')
    .max(100, 'اسم المدير طويل جداً'),
  
  managerUsername: z.string()
    .min(3, 'اسم المستخدم مطلوب')
    .max(50, 'اسم المستخدم طويل جداً')
    .regex(/^[a-zA-Z0-9_]+$/, 'اسم المستخدم يجب أن يحتوي على أحرف إنجليزية وأرقام و _ فقط'),
  
  managerPhone: z.string()
    .regex(/^\d+$/, 'رقم الهاتف يجب أن يكون أرقام فقط')
    .min(6, 'رقم الهاتف يجب أن يكون 6 أرقام على الأقل')
    .max(15, 'رقم الهاتف طويل جداً'),
  
  managerPassword: editingHall 
    ? z.string()
        .min(6, 'كلمة المرور يجب أن تكون 6 أحرف على الأقل')
        .max(50, 'كلمة المرور طويلة جداً')
        .optional()
        .or(z.literal(''))
    : z.string()
        .min(6, 'كلمة المرور مطلوبة')
        .max(50, 'كلمة المرور طويلة جداً'),
  
  description: z.string()
    .max(1000, 'الوصف طويل جداً')
    .optional()
    .or(z.literal('')),
  
  amenities: z.array(z.string())
    .optional()
    .default([]),
  
  services: z.array(z.object({
    service: z.string(),
    customPrice: z.number().optional(),
    isIncluded: z.boolean().optional().default(false),
    notes: z.string().optional()
  }))
    .optional()
    .default([]),
  
  images: z.array(z.string())
    .optional()
    .default([]),
  
  primaryImage: z.string()
    .optional()
    .nullable(),
  
  isActive: z.boolean()
    .optional()
    .default(true)
})

// ====================== Main Component ======================
export default function HallsManagement() {
  const queryClient = useQueryClient()
  const { success, error: showError } = useNotification()
  const theme = useTheme()
  const isLargeScreen = useMediaQuery(theme.breakpoints.up('md'))
  
  // Refs
  const fileInputRef = useRef(null)

  // ====================== State Management ======================
  const [search, setSearch] = useState('')
  const debouncedSearch = useDebounce(search, 500)
  
  const [filters, setFilters] = useState({
    minCapacity: '',
    maxCapacity: '',
    minPrice: '',
    maxPrice: '',
    isActive: 'all'
  })
  
  const [dialogOpen, setDialogOpen] = useState(false)
  const [viewDialogOpen, setViewDialogOpen] = useState(false)
  const [exportDialogOpen, setExportDialogOpen] = useState(false)
  const [filterDialogOpen, setFilterDialogOpen] = useState(false)
  const [servicesDialogOpen, setServicesDialogOpen] = useState(false)
  
  const [editingHall, setEditingHall] = useState(null)
  const [viewingHall, setViewingHall] = useState(null)
  const [selectedServices, setSelectedServices] = useState([])
  
  const [confirmDialog, setConfirmDialog] = useState({
    open: false,
    hall: null,
    title: '',
    message: '',
    action: 'delete'
  })
  
  const [exportOptions, setExportOptions] = useState({
    format: 'excel',
    includeInactive: false,
    columns: ['name', 'location', 'address', 'capacity', 'tables', 'chairs', 'defaultPrices', 'manager', 'services', 'status']
  })
  
  const [sortConfig, setSortConfig] = useState({
    field: 'name',
    direction: 'asc'
  })
  
  const [uploadingImages, setUploadingImages] = useState(false)
  
  // Pagination State
  const [pagination, setPagination] = useState({
    page: 1,
    limit: 10,
    total: 0,
    totalPages: 0
  })

  // Dynamic schema based on editing state
  const hallSchema = useMemo(() => 
    createHallSchema(editingHall), 
    [editingHall]
  )

  // ====================== Form Setup ======================
  const { control, handleSubmit, reset, watch, setValue, formState: { errors } } = useForm({
    resolver: zodResolver(hallSchema),
    defaultValues: {
      name: '',
      location: '',
      address: '',
      capacity: '',
      tables: '',
      chairs: '',
      maxEmployees: '',
      defaultPrices: '',
      managerName: '',
      managerUsername: '',
      managerPhone: '',
      managerPassword: '',
      description: '',
      amenities: [],
      services: [],
      images: [],
      primaryImage: null,
      isActive: true
    }
  })

  // Watch form values
  const watchedServices = watch('services')
  const watchedImages = watch('images')
  const watchedAmenities = watch('amenities')
  const watchedPrimaryImage = watch('primaryImage')

  // ====================== Data Fetching ======================
  const { data: hallsResponse, isLoading, error, isFetching, refetch } = useQuery({
    queryKey: [QUERY_KEYS.ADMIN_HALLS, {
      search: debouncedSearch,
      page: pagination.page,
      limit: pagination.limit,
      sortBy: sortConfig.field,
      sortOrder: sortConfig.direction,
      ...filters
    }],
    queryFn: () => getHallsList({
      search: debouncedSearch,
      page: pagination.page,
      limit: pagination.limit,
      sortBy: sortConfig.field,
      sortOrder: sortConfig.direction,
      ...Object.fromEntries(
        Object.entries(filters).filter(([key, value]) => value !== '' && value !== 'all')
      )
    }),
    keepPreviousData: true,
    staleTime: 30000,
    cacheTime: 60000
  })

  // Fetch services for selection
  const { data: servicesData } = useQuery({
    queryKey: [QUERY_KEYS.SERVICES],
    queryFn: getServicesList,
    staleTime: 60000
  })

  // Update pagination from response
  useEffect(() => {
    if (hallsResponse?.pagination) {
      setPagination(prev => ({
        ...prev,
        total: hallsResponse.pagination.totalItems || 0,
        totalPages: hallsResponse.pagination.totalPages || 1
      }))
    }
  }, [hallsResponse])

  // ====================== Helper Functions ======================
  const extractServiceDetails = (services, availableServices) => {
    if (!services || !Array.isArray(services)) return []
    
    return services.map(service => {
      if (typeof service === 'string') {
        const serviceDetails = availableServices.find(s => s._id === service)
        return {
          service: service,
          customPrice: 0,
          isIncluded: false,
          notes: '',
          serviceDetails: serviceDetails || { _id: service, name: 'خدمة غير معروفة' }
        }
      }
      
      // If service is already an object
      const serviceDetails = availableServices.find(s => s._id === service.service)
      return {
        ...service,
        serviceDetails: serviceDetails || { _id: service.service, name: 'خدمة غير معروفة' }
      }
    })
  }

  const getAmenityIcon = (amenity) => {
    const icons = {
      'واي فاي': <Wifi size={16} />,
      'موقف سيارات': <Car size={16} />,
      'مطعم': <Coffee size={16} />,
      'موسيقى': <Music size={16} />,
      'تجهيزات فاخرة': <Star size={16} />
    }
    return icons[amenity] || <Settings size={16} />
  }

  // ====================== Data Processing ======================
  const availableServices = useMemo(() => {
    return servicesData?.data || []
  }, [servicesData])

  const normalizedHalls = useMemo(() => {
    if (!hallsResponse?.data || !Array.isArray(hallsResponse.data)) {
      return []
    }

    return hallsResponse.data.map(hall => {
      // استخراج تفاصيل الخدمات
      const serviceDetails = extractServiceDetails(hall.services, availableServices)
      
      return {
        id: hall.id || hall._id,
        name: hall.name || 'غير محدد',
        location: hall.location || 'غير محدد',
        address: hall.address || 'غير محدد',
        capacity: hall.capacity || 0,
        tables: hall.tables || 0,
        chairs: hall.chairs || 0,
        maxEmployees: hall.maxEmployees || 0,
        defaultPrices: hall.defaultPrices || 0,
        manager: {
          name: hall.generalManager?.name || 'غير معين',
          username: hall.generalManager?.username || '',
          phone: hall.generalManager?.phone || '',
          id: hall.generalManager?._id
        },
        description: hall.description || '',
        amenities: Array.isArray(hall.amenities) ? hall.amenities : [],
        services: serviceDetails,
        images: Array.isArray(hall.images) ? hall.images : [],
        isActive: hall.isActive !== false,
        createdAt: hall.createdAt ? new Date(hall.createdAt) : new Date(),
        updatedAt: hall.updatedAt ? new Date(hall.updatedAt) : new Date(),
        primaryImage: hall.primaryImage || (hall.images?.[0] || null)
      }
    })
  }, [hallsResponse, availableServices])

  // Filtered halls for display
  const displayedHalls = useMemo(() => {
    return normalizedHalls
  }, [normalizedHalls])

  // Table columns for large screens
  const tableColumns = useMemo(() => [
    {
      id: 'name',
      label: 'اسم القاعة',
      align: 'right',
      format: (value, row) => (
        <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
          {row.primaryImage ? (
            <MuiAvatar
              src={row.primaryImage}
              alt={value}
              sx={{ width: 40, height: 40, border: '2px solid var(--color-secondary-100)' }}
            />
          ) : (
            <Building2 size={24} style={{ color: 'var(--color-secondary-500)' }} />
          )}
          <MuiBox>
            <MuiTypography variant="body2" sx={{ fontWeight: 600 }}>
              {value}
            </MuiTypography>
            <MuiTypography variant="caption" sx={{ color: 'var(--color-text-secondary)' }}>
              {truncateText(row.address, 30)}
            </MuiTypography>
          </MuiBox>
        </MuiBox>
      )
    },
    {
      id: 'location',
      label: 'الموقع',
      align: 'right',
      format: (value, row) => (
        <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
          <MapPin size={14} style={{ color: 'var(--color-text-secondary)' }} />
          <MuiTypography variant="body2">{value}</MuiTypography>
        </MuiBox>
      )
    },
    {
      id: 'capacity',
      label: 'السعة',
      align: 'center',
      format: (value) => (
        <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5, justifyContent: 'center' }}>
          <Users size={16} style={{ color: 'var(--color-info-500)' }} />
          <MuiTypography variant="body2" sx={{ fontWeight: 600 }}>
            {new Intl.NumberFormat('en-US').format(value)}
          </MuiTypography>
        </MuiBox>
      )
    },
    {
      id: 'defaultPrices',
      label: 'السعر الافتراضي',
      align: 'center',
      format: (value) => (
        <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5, justifyContent: 'center' }}>
          <DollarSign size={16} style={{ color: 'var(--color-success-500)' }} />
          <MuiTypography variant="body2" sx={{ fontWeight: 600, color: 'var(--color-success-500)' }}>
            {formatCurrency(value)}
          </MuiTypography>
        </MuiBox>
      )
    },
    {
      id: 'services',
      label: 'الخدمات',
      align: 'center',
      format: (value) => (
        <MuiChip
          label={`${value.length} خدمة`}
          color="info"
          size="small"
          icon={<Settings size={14} />}
        />
      )
    },
    {
      id: 'manager',
      label: 'المدير',
      align: 'right',
      format: (value, row) => (
        <MuiBox>
          <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 0.5 }}>
            <User size={14} style={{ color: 'var(--color-text-secondary)' }} />
            <MuiTypography variant="body2" sx={{ fontSize: '0.875rem' }}>
              {row.manager?.name || 'غير معين'}
            </MuiTypography>
          </MuiBox>
          {row.manager?.username && (
            <MuiTypography variant="caption" sx={{ fontSize: '0.75rem', color: 'var(--color-text-secondary)' }}>
              @{row.manager.username}
            </MuiTypography>
          )}
        </MuiBox>
      )
    },
    {
      id: 'isActive',
      label: 'الحالة',
      align: 'center',
      format: (value) => (
        <MuiChip
          label={value ? 'نشطة' : 'غير نشطة'}
          color={value ? 'success' : 'warning'}
          size="small"
          icon={value ? <CheckCircle size={14} /> : <XCircle size={14} />}
          sx={{ fontWeight: 600 }}
        />
      )
    }
  ], [])

  // ====================== Mutations ======================
  const addMutation = useMutation({
    mutationFn: createHall,
    onSuccess: (data) => {
      success('تم إضافة القاعة بنجاح')
      queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
      queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_STATS] })
      handleCloseDialog()
    },
    onError: (err) => {
      const errorMessage = err.isAuthError
        ? 'جلسة العمل منتهية. يرجى تسجيل الدخول مرة أخرى'
        : err.response?.data?.message || err.message || 'فشل إضافة القاعة'
      showError(errorMessage)
    },
  })

  const editMutation = useMutation({
    mutationFn: ({ id, data }) => updateHall(id, data),
    onSuccess: () => {
      success('تم تعديل القاعة بنجاح')
      queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
      handleCloseDialog()
    },
    onError: (err) => {
      const errorMessage = err.isAuthError
        ? 'جلسة العمل منتهية. يرجى تسجيل الدخول مرة أخرى'
        : err.response?.data?.message || err.message || 'فشل تعديل القاعة'
      showError(errorMessage)
    },
  })

  const deleteMutation = useMutation({
    mutationFn: deleteHall,
    onSuccess: () => {
      success('تم حذف القاعة بنجاح')
      queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
      queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_STATS] })
      handleCloseConfirm()
    },
    onError: (err) => {
      const errorMessage = err.isAuthError
        ? 'جلسة العمل منتهية. يرجى تسجيل الدخول مرة أخرى'
        : err.response?.data?.message || err.message || 'فشل حذف القاعة'
      showError(errorMessage)
    },
  })

  const toggleStatusMutation = useMutation({
    mutationFn: ({ id, isActive }) => updateHall(id, { isActive }),
    onSuccess: (_, variables) => {
      success(`تم ${variables.isActive ? 'تفعيل' : 'تعطيل'} القاعة بنجاح`)
      queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
    },
    onError: (err) => {
      showError(err.response?.data?.message || err.message || 'فشل تغيير حالة القاعة')
    }
  })

  // ====================== Event Handlers ======================

  const handleOpenDialog = (hall = null) => {
    setEditingHall(hall)
    
    if (hall) {
      // استخراج تفاصيل الخدمات
      const extractedServices = extractServiceDetails(hall.services, availableServices)
      
      reset({
        name: hall.name,
        location: hall.location,
        address: hall.address,
        capacity: hall.capacity,
        tables: hall.tables,
        chairs: hall.chairs,
        maxEmployees: hall.maxEmployees,
        defaultPrices: hall.defaultPrices,
        managerName: hall.manager?.name || '',
        managerUsername: hall.manager?.username || '',
        managerPhone: hall.manager?.phone || '',
        managerPassword: '',
        description: hall.description || '',
        amenities: hall.amenities || [],
        services: extractedServices.map(s => ({
          service: s.service,
          customPrice: s.customPrice || 0,
          isIncluded: s.isIncluded || false,
          notes: s.notes || ''
        })),
        images: hall.images || [],
        primaryImage: hall.primaryImage || null,
        isActive: hall.isActive
      })
      
      // تعيين الخدمات المختارة
      setSelectedServices(extractedServices.map(s => ({
        service: s.service,
        customPrice: s.customPrice || 0,
        isIncluded: s.isIncluded || false,
        notes: s.notes || ''
      })))
    } else {
      reset({
        name: '',
        location: '',
        address: '',
        capacity: '',
        tables: '',
        chairs: '',
        maxEmployees: '',
        defaultPrices: '',
        managerName: '',
        managerUsername: '',
        managerPhone: '',
        managerPassword: '',
        description: '',
        amenities: [],
        services: [],
        images: [],
        primaryImage: null,
        isActive: true
      })
      setSelectedServices([])
    }
    
    setDialogOpen(true)
  }

  const handleCloseDialog = () => {
    setDialogOpen(false)
    setEditingHall(null)
    reset()
  }

  const handleOpenViewDialog = (hall) => {
    setViewingHall(hall)
    setViewDialogOpen(true)
  }

  const handleCloseViewDialog = () => {
    setViewDialogOpen(false)
    setViewingHall(null)
  }

  const handleOpenFilterDialog = () => {
    setFilterDialogOpen(true)
  }

  const handleCloseFilterDialog = () => {
    setFilterDialogOpen(false)
  }

  const handleOpenServicesDialog = () => {
    setSelectedServices(watchedServices || [])
    setServicesDialogOpen(true)
  }

  const handleCloseServicesDialog = () => {
    setServicesDialogOpen(false)
  }

  const handleSaveServices = () => {
    setValue('services', selectedServices)
    handleCloseServicesDialog()
  }

  const handleAddService = (service) => {
    const newService = {
      service: service._id,
      customPrice: service.basePrice || 0,
      isIncluded: false,
      notes: ''
    }
    setSelectedServices(prev => [...prev, newService])
  }

  const handleRemoveService = (index) => {
    setSelectedServices(prev => prev.filter((_, i) => i !== index))
  }

  const handleUpdateService = (index, updates) => {
    setSelectedServices(prev => prev.map((service, i) => 
      i === index ? { ...service, ...updates } : service
    ))
  }

  const handleApplyFilters = () => {
    setPagination(prev => ({ ...prev, page: 1 }))
    handleCloseFilterDialog()
  }

  const handleResetFilters = () => {
    setFilters({
      minCapacity: '',
      maxCapacity: '',
      minPrice: '',
      maxPrice: '',
      isActive: 'all'
    })
    setPagination(prev => ({ ...prev, page: 1 }))
    handleCloseFilterDialog()
  }

  const handleOpenConfirm = (hall, action = 'delete') => {
    let title = ''
    let message = ''
    
    switch (action) {
      case 'delete':
        title = 'حذف القاعة'
        message = `هل أنت متأكد من حذف القاعة "${hall.name}"؟ سيتم حذف جميع البيانات المرتبطة بها ولا يمكن التراجع عن هذا الإجراء.`
        break
      case 'deactivate':
        title = 'تعطيل القاعة'
        message = `هل أنت متأكد من تعطيل القاعة "${hall.name}"؟ لن تكون متاحة للحجوزات الجديدة.`
        break
      case 'activate':
        title = 'تفعيل القاعة'
        message = `هل أنت متأكد من تفعيل القاعة "${hall.name}"؟`
        break
    }
    
    setConfirmDialog({
      open: true,
      hall,
      title,
      message,
      action
    })
  }

  const handleConfirmAction = async () => {
    const { hall, action } = confirmDialog
    
    if (!hall) return
    
    try {
      switch (action) {
        case 'delete':
          await deleteMutation.mutateAsync(hall.id)
          break
        case 'deactivate':
          await toggleStatusMutation.mutateAsync({ id: hall.id, isActive: false })
          break
        case 'activate':
          await toggleStatusMutation.mutateAsync({ id: hall.id, isActive: true })
          break
        default:
          console.error('Invalid action:', action)
      }
    } catch (error) {
      // Error handled in mutation
      console.error('Error in confirm action:', error)
    }
  }

  const handleCloseConfirm = () => {
    setConfirmDialog({
      open: false,
      hall: null,
      title: '',
      message: '',
      action: 'delete'
    })
  }

  const handleOpenExportDialog = () => {
    setExportDialogOpen(true)
  }

  const handleCloseExportDialog = () => {
    setExportDialogOpen(false)
  }

  // ====================== Image Upload Handlers ======================
  const handleImageUpload = async (event) => {
    const files = event.target.files
    if (!files || files.length === 0) return
    
    try {
      setUploadingImages(true)
      
      const uploadedImages = []
      const currentImages = watch('images') || []
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i]
        
        // استخدام FileReader لعرض الصورة مؤقتاً
        const reader = new FileReader()
        const imageUrl = await new Promise((resolve) => {
          reader.onload = (e) => resolve(e.target.result)
          reader.readAsDataURL(file)
        })
        
        uploadedImages.push(imageUrl)
      }
      
      // إضافة الصور إلى النموذج
      const newImages = [...currentImages, ...uploadedImages]
      setValue('images', newImages)
      
      // إذا لم يكن هناك صورة رئيسية، اجعل أول صورة رئيسية
      if (!watch('primaryImage') && uploadedImages.length > 0) {
        setValue('primaryImage', uploadedImages[0])
      }
      
      success(`تم رفع ${uploadedImages.length} صورة بنجاح`)
    } catch (error) {
      showError('فشل رفع الصور: ' + error.message)
    } finally {
      setUploadingImages(false)
      // Reset file input
      if (event.target) {
        event.target.value = ''
      }
    }
  }

  const handleRemoveImage = (index) => {
    const currentImages = [...(watch('images') || [])]
    const removedImage = currentImages[index]
    
    // حذف الصورة محلياً
    currentImages.splice(index, 1)
    setValue('images', currentImages)
    
    // إذا كانت الصورة المحذوفة هي الرئيسية، اجعل أول صورة رئيسية
    if (watch('primaryImage') === removedImage) {
      setValue('primaryImage', currentImages[0] || null)
    }
    
    success('تم حذف الصورة')
  }

  const handleSetPrimaryImage = (imageUrl) => {
    setValue('primaryImage', imageUrl)
  }

  // ====================== Form Submission ======================
  const onSubmit = async (data) => {
    try {
      // تحويل الخدمات إلى التنسيق المطلوب
      const formattedServices = data.services.map(service => ({
        service: service.service,
        ...(service.customPrice && { customPrice: Number(service.customPrice) }),
        ...(service.isIncluded !== undefined && { isIncluded: service.isIncluded }),
        ...(service.notes && { notes: service.notes })
      }))

      const payload = { 
        name: data.name,
        location: data.location,
        address: data.address,
        capacity: Number(data.capacity),
        tables: Number(data.tables),
        chairs: Number(data.chairs),
        maxEmployees: Number(data.maxEmployees),
        defaultPrices: Number(data.defaultPrices),
        description: data.description || '',
        amenities: data.amenities || [],
        services: formattedServices,
        images: data.images || [],
        primaryImage: data.primaryImage || null,
        isActive: data.isActive,
        managerName: data.managerName,
        managerUsername: data.managerUsername,
        managerPhone: data.managerPhone,
        ...(data.managerPassword && data.managerPassword.trim() !== '' && { 
          managerPassword: data.managerPassword 
        })
      }

      // تنظيف البيانات الفارغة
      Object.keys(payload).forEach(key => {
        if (payload[key] === null || payload[key] === undefined || payload[key] === '') {
          delete payload[key]
        }
      })

      if (editingHall) {
        await editMutation.mutateAsync({ id: editingHall.id, data: payload })
      } else {
        await addMutation.mutateAsync(payload)
      }
    } catch (error) {
      // Error handled in mutation
    }
  }

  // ====================== Export Functions ======================
  const handleExportData = () => {
    try {
      // جمع جميع البيانات للتصدير
      const exportData = normalizedHalls.map(hall => ({
        'اسم القاعة': hall.name,
        'الموقع': hall.location,
        'العنوان التفصيلي': hall.address,
        'السعة': hall.capacity,
        'عدد الطاولات': hall.tables,
        'عدد الكراسي': hall.chairs,
        'الحد الأقصى للموظفين': hall.maxEmployees,
        'السعر (للشخص)': formatCurrency(hall.defaultPrices),
        'اسم المدير': hall.manager.name,
        'اسم المستخدم': hall.manager.username || 'غير محدد',
        'هاتف المدير': formatPhoneNumber(hall.manager.phone),
        'عدد الخدمات': hall.services.length,
        'عدد المرافق': hall.amenities.length,
        'عدد الصور': hall.images.length,
        'الحالة': hall.isActive ? 'نشطة' : 'غير نشطة',
        'تاريخ الإنشاء': hall.createdAt.toLocaleDateString('ar-SA'),
        'تاريخ التحديث': hall.updatedAt.toLocaleDateString('ar-SA'),
        'الوصف': hall.description || ''
      }))

      // إنشاء ورقة عمل Excel
      const worksheet = XLSX.utils.json_to_sheet(exportData)
      const workbook = XLSX.utils.book_new()
      XLSX.utils.book_append_sheet(workbook, worksheet, 'القاعات')

      // تنسيق الأعمدة
      const wscols = [
        { wch: 25 },
        { wch: 20 },
        { wch: 30 },
        { wch: 10 },
        { wch: 15 },
        { wch: 15 },
        { wch: 20 },
        { wch: 15 },
        { wch: 20 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 10 },
        { wch: 15 },
        { wch: 15 },
        { wch: 40 }
      ]
      worksheet['!cols'] = wscols

      // حفظ الملف
      const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' })
      const blob = new Blob([excelBuffer], { 
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
      })
      
      const fileName = generateExportFileName('halls')
      saveAs(blob, fileName)
      
      success('تم تصدير البيانات بنجاح')
      handleCloseExportDialog()
    } catch (error) {
      showError('فشل تصدير البيانات: ' + error.message)
    }
  }

  // ====================== Pagination Handlers ======================
  const handlePageChange = (event, newPage) => {
    setPagination(prev => ({ ...prev, page: newPage }))
  }

  const handleRowsPerPageChange = (newLimit) => {
    setPagination(prev => ({ 
      ...prev, 
      limit: newLimit,
      page: 1
    }))
  }

  const handleRefresh = () => {
    refetch()
    success('تم تحديث البيانات')
  }

  const isSubmitting = addMutation.isPending || editMutation.isPending

  // ====================== Render ======================
  return (
    <>
      <SEOHead 
        pageKey="hallsManagement" 
        title="إدارة القاعات | INVOCCA" 
        description="إدارة قاعات المناسبات والحفلات، إضافة وتعديل وحذف القاعات"
      />

      {/* Main Header */}
      <MuiBox sx={{ mb: { xs: 2, sm: 3, md: 4 } }}>
        <MuiBox sx={{ 
          display: 'flex', 
          alignItems: { xs: 'flex-start', sm: 'center' }, 
          justifyContent: 'space-between', 
          flexDirection: { xs: 'column', sm: 'row' },
          flexWrap: 'wrap',
          gap: { xs: 2, sm: 2, md: 3 },
          mb: { xs: 2, sm: 2.5, md: 3 }
        }}>
          <MuiBox>
            <MuiTypography
              variant="h4"
              sx={{
                fontWeight: 800,
                background: 'linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                backgroundClip: 'text',
                mb: 1,
                fontSize: { xs: '1.75rem', md: '2rem' }
              }}
            >
              إدارة القاعات
            </MuiTypography>
            <MuiTypography
              variant="body2"
              sx={{ color: 'var(--color-text-secondary)' }}
            >
              {hallsResponse?.pagination
                ? `إجمالي ${hallsResponse.pagination.totalItems || 0} قاعة • ${displayedHalls.filter(h => h.isActive).length} نشطة`
                : 'جاري تحميل البيانات...'}
            </MuiTypography>
          </MuiBox>

          {/* Search and Actions */}
          <MuiBox sx={{ 
            display: 'flex', 
            alignItems: 'center', 
            gap: { xs: 1, sm: 1.5, md: 2 }, 
            flexWrap: 'wrap',
            width: { xs: '100%', sm: 'auto' },
            justifyContent: { xs: 'flex-start', md: 'flex-end' }
          }}>
            <MuiTextField
              placeholder="ابحث عن قاعة..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              size="small"
              sx={{
                width: { xs: '100%', sm: 250 },
                '& .MuiOutlinedInput-root': {
                  borderRadius: '12px',
                  backgroundColor: 'rgba(255, 255, 255, 0.9)',
                  '&:hover': {
                    backgroundColor: 'rgba(255, 255, 255, 1)',
                  }
                }
              }}
              startIcon={<Search size={18} style={{ color: 'var(--color-text-secondary)' }} />}
            />

            <MuiButton
              variant="outlined"
              onClick={handleOpenFilterDialog}
              start_icon={<Filter size={16} />}
              sx={{
                borderRadius: '12px',
                borderColor: 'var(--color-border)',
                fontSize: { xs: '0.75rem', sm: '0.875rem' },
                padding: { xs: '6px 12px', sm: '8px 16px' },
                minWidth: { xs: 'auto', sm: '80px' },
                '&:hover': {
                  borderColor: 'var(--color-primary-500)',
                  backgroundColor: 'var(--color-primary-50)'
                }
              }}
              size="small"
            >
              تصفية
            </MuiButton>

            <MuiButton
              variant="outlined"
              onClick={handleRefresh}
              start_icon={<RefreshCw size={16} />}
              disabled={isFetching}
              sx={{
                borderRadius: '12px',
                borderColor: 'var(--color-border)',
                fontSize: { xs: '0.75rem', sm: '0.875rem' },
                padding: { xs: '6px 12px', sm: '8px 16px' },
                minWidth: { xs: 'auto', sm: '80px' },
                '&:hover': {
                  borderColor: 'var(--color-primary-500)',
                  backgroundColor: 'var(--color-primary-50)'
                }
              }}
              size="small"
            >
              {isFetching ? 'جاري...' : 'تحديث'}
            </MuiButton>

            <MuiButton
              variant="outlined"
              onClick={handleOpenExportDialog}
              start_icon={<Download size={16} />}
              sx={{
                borderRadius: '12px',
                borderColor: 'var(--color-border)',
                fontSize: { xs: '0.75rem', sm: '0.875rem' },
                padding: { xs: '6px 12px', sm: '8px 16px' },
                minWidth: { xs: 'auto', sm: '80px' },
                '&:hover': {
                  borderColor: 'var(--color-primary-500)',
                  backgroundColor: 'var(--color-primary-50)'
                }
              }}
              size="small"
            >
              تصدير
            </MuiButton>

            <MuiButton
              variant="contained"
              onClick={() => handleOpenDialog()}
              start_icon={<Plus size={16} />}
              sx={{
                borderRadius: '12px',
                background: 'linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%)',
                boxShadow: '0 4px 12px rgba(26, 26, 26, 0.2)',
                fontSize: { xs: '0.75rem', sm: '0.875rem' },
                padding: { xs: '6px 12px', sm: '8px 16px' },
                minWidth: { xs: 'auto', sm: '100px' },
                '&:hover': {
                  boxShadow: '0 6px 20px rgba(26, 26, 26, 0.3)',
                  transform: 'translateY(-1px)'
                }
              }}
              size="small"
            >
              إضافة قاعة
            </MuiButton>
          </MuiBox>
        </MuiBox>
      </MuiBox>

      {/* Loading State */}
      {isLoading ? (
        <LoadingScreen 
          message="جاري تحميل بيانات القاعات..." 
          fullScreen={false}
          progress
        />
      ) : error ? (
        <EmptyState
          title="حدث خطأ"
          description={error.message || 'فشل تحميل قائمة القاعات'}
          icon={AlertCircle}
          showPaper
          action={
            <MuiButton
              variant="contained"
              onClick={() => refetch()}
              start_icon={<RefreshCw size={20} />}
            >
              إعادة المحاولة
            </MuiButton>
          }
        />
      ) : displayedHalls.length === 0 ? (
        <EmptyState
          title="لا توجد قاعات"
          description={
            debouncedSearch || Object.values(filters).some(v => v !== '' && v !== 'all')
              ? 'لا توجد نتائج مطابقة لبحثك أو تصفيتك'
              : "لم يتم إضافة أي قاعات بعد. ابدأ بإضافة قاعة جديدة"
          }
          icon={Building2}
          showPaper
          action={
            <MuiButton variant="contained" onClick={() => handleOpenDialog()}>
              إضافة قاعة جديدة
            </MuiButton>
          }
        />
      ) : (
        <>
          {/* Stats Bar */}
          <MuiBox sx={{ 
            mb: 3, 
            display: 'flex', 
            gap: 1, 
            flexWrap: 'wrap',
            justifyContent: { xs: 'center', sm: 'flex-start' }
          }}>
            <MuiChip
              label={`إجمالي: ${hallsResponse?.pagination?.totalItems || 0}`}
              color="primary"
              variant="outlined"
              icon={<Building2 size={16} />}
              size="small"
            />
            <MuiChip
              label={`نشطة: ${displayedHalls.filter(h => h.isActive).length}`}
              color="success"
              variant="outlined"
              icon={<CheckCircle size={16} />}
              size="small"
            />
            <MuiChip
              label={`متوسط السعة: ${Math.round(displayedHalls.reduce((acc, h) => acc + h.capacity, 0) / displayedHalls.length)}`}
              color="info"
              variant="outlined"
              icon={<Users size={16} />}
              size="small"
            />
            <MuiChip
              label={`إجمالي الخدمات: ${displayedHalls.reduce((acc, h) => acc + h.services.length, 0)}`}
              color="secondary"
              variant="outlined"
              icon={<Settings size={16} />}
              size="small"
            />
          </MuiBox>

          {/* Fetching Indicator */}
          {isFetching && (
            <MuiAlert 
              severity="info" 
              sx={{ mb: 2 }}
              icon={<MuiCircularProgress size={20} />}
            >
              جاري تحديث البيانات...
            </MuiAlert>
          )}

          {/* Responsive View: Table for large screens, Cards for small screens */}
          {isLargeScreen ? (
            <DataTable
              columns={tableColumns}
              rows={displayedHalls}
              onView={handleOpenViewDialog}
              onEdit={handleOpenDialog}
              onDelete={(hall) => handleOpenConfirm(hall, 'delete')}
              onToggleStatus={(hall) => toggleStatusMutation.mutate({ id: hall.id, isActive: !hall.isActive })}
              pagination={{
                page: pagination.page - 1,
                limit: pagination.limit,
                total: hallsResponse?.pagination?.totalItems || 0
              }}
              onPageChange={(newPage) => setPagination(prev => ({ ...prev, page: newPage + 1 }))}
              onRowsPerPageChange={(newLimit) => setPagination(prev => ({ 
                ...prev, 
                limit: newLimit,
                page: 1
              }))}
              emptyMessage="لا توجد قاعات"
            />
          ) : (
            <>
              <CardsView
                data={displayedHalls}
                columns={{ xs: 1, sm: 2 }}
                renderCard={(hall) => (
                  <MuiCard
                    sx={{
                      height: '100%',
                      width: '100%',
                      maxWidth: '100%',
                      display: 'flex',
                      flexDirection: 'column',
                      opacity: hall.isActive ? 1 : 0.7,
                      transition: 'all 0.3s ease',
                      '&:hover': {
                        transform: 'translateY(-4px)',
                        boxShadow: '0 8px 24px rgba(0,0,0,0.12)'
                      }
                    }}
                  >
                    {/* Image Section */}
                    <MuiBox
                      sx={{
                        height: 180,
                        background: hall.primaryImage
                          ? `url(${hall.primaryImage}) center/cover`
                          : 'linear-gradient(135deg, var(--color-secondary-400) 0%, var(--color-secondary-600) 100%)',
                        position: 'relative',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                      }}
                    >
                      {!hall.primaryImage && (
                        <Building2 size={64} style={{ color: 'white', opacity: 0.3 }} />
                      )}
                      <MuiChip
                        label={hall.isActive ? 'نشطة' : 'غير نشطة'}
                        color={hall.isActive ? 'success' : 'warning'}
                        size="small"
                        sx={{
                          position: 'absolute',
                          top: 12,
                          left: 12,
                          fontWeight: 600
                        }}
                        icon={hall.isActive ? <CheckCircle size={14} /> : <XCircle size={14} />}
                      />
                      {hall.images.length > 0 && (
                        <MuiChip
                          label={`${hall.images.length} صورة`}
                          size="small"
                          sx={{
                            position: 'absolute',
                            top: 12,
                            right: 12,
                            backgroundColor: 'rgba(0,0,0,0.6)',
                            color: 'white'
                          }}
                          icon={<ImageIcon size={14} />}
                        />
                      )}
                    </MuiBox>

                    <MuiCardContent sx={{ flex: 1, p: 2.5, display: 'flex', flexDirection: 'column' }}>
                      {/* Title */}
                      <MuiTypography
                        variant="h6"
                        sx={{
                          fontWeight: 700,
                          mb: 1.5,
                          color: 'var(--color-primary-500)',
                          fontSize: '1rem',
                          display: 'flex',
                          alignItems: 'flex-start',
                          gap: 1,
                          lineHeight: 1.4,
                          minHeight: '48px'
                        }}
                      >
                        <Building2 size={18} style={{ flexShrink: 0, marginTop: '2px' }} />
                        <span style={{ flex: 1, wordBreak: 'break-word', lineHeight: 1.4 }}>{hall.name}</span>
                      </MuiTypography>

                      {/* Location and Address */}
                      <MuiBox sx={{ display: 'flex', alignItems: 'flex-start', gap: 1, mb: 1, color: 'var(--color-text-secondary)' }}>
                        <MapPin size={16} style={{ marginTop: '2px', flexShrink: 0 }} />
                        <MuiBox sx={{ flex: 1 }}>
                          <MuiTypography variant="body2" sx={{ fontSize: '0.875rem', lineHeight: 1.5, wordBreak: 'break-word' }}>
                            {hall.location}
                          </MuiTypography>
                          <MuiTypography variant="caption" sx={{ color: 'var(--color-text-secondary)', fontSize: '0.75rem' }}>
                            {truncateText(hall.address, 40)}
                          </MuiTypography>
                        </MuiBox>
                      </MuiBox>

                      {/* Description */}
                      {hall.description && (
                        <MuiBox sx={{ mb: 2 }}>
                          <MuiTypography variant="body2" sx={{ 
                            fontSize: '0.8rem', 
                            color: 'var(--color-text-secondary)',
                            lineHeight: 1.5,
                            wordBreak: 'break-word'
                          }}>
                            {truncateText(hall.description, 80)}
                          </MuiTypography>
                        </MuiBox>
                      )}

                      {/* Stats Grid */}
                      <MuiGrid container spacing={1.5} sx={{ mb: 2, mt: 1 }}>
                        <MuiGrid item xs={6}>
                          <MuiBox sx={{ 
                            p: 1.25, 
                            borderRadius: '10px', 
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: 0.75,
                            minHeight: '60px'
                          }}>
                            <Users size={16} style={{ color: 'var(--color-info-500)', flexShrink: 0 }} />
                            <MuiBox sx={{ flex: 1, minWidth: 0 }}>
                              <MuiTypography variant="caption" sx={{ display: 'block', color: 'var(--color-text-secondary)', fontSize: '0.7rem', mb: 0.25 }}>
                                السعة
                              </MuiTypography>
                              <MuiTypography variant="body2" sx={{ fontWeight: 700, color: 'var(--color-info-500)', fontSize: '0.875rem', lineHeight: 1.2 }}>
                                {new Intl.NumberFormat('en-US').format(hall.capacity)}
                              </MuiTypography>
                            </MuiBox>
                          </MuiBox>
                        </MuiGrid>
                        <MuiGrid item xs={6}>
                          <MuiBox sx={{ 
                            p: 1.25, 
                            borderRadius: '10px', 
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: 0.75,
                            minHeight: '60px'
                          }}>
                            <DollarSign size={16} style={{ color: 'var(--color-success-500)', flexShrink: 0 }} />
                            <MuiBox sx={{ flex: 1, minWidth: 0 }}>
                              <MuiTypography variant="caption" sx={{ display: 'block', color: 'var(--color-text-secondary)', fontSize: '0.7rem', mb: 0.25 }}>
                                السعر
                              </MuiTypography>
                              <MuiTypography variant="body2" sx={{ fontWeight: 700, color: 'var(--color-success-500)', fontSize: '0.875rem', lineHeight: 1.2, wordBreak: 'break-word' }}>
                                {formatCurrency(hall.defaultPrices)}
                              </MuiTypography>
                            </MuiBox>
                          </MuiBox>
                        </MuiGrid>
                        <MuiGrid item xs={6}>
                          <MuiBox sx={{ 
                            p: 1.25, 
                            borderRadius: '10px', 
                            backgroundColor: 'rgba(216, 185, 138, 0.1)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: 0.75,
                            minHeight: '50px'
                          }}>
                            <Table size={14} style={{ color: 'var(--color-secondary-700)', flexShrink: 0 }} />
                            <MuiTypography variant="body2" sx={{ fontSize: '0.8rem', color: 'var(--color-text-primary)', lineHeight: 1.3, wordBreak: 'break-word' }}>
                              {new Intl.NumberFormat('en-US').format(hall.tables)} طاولة
                            </MuiTypography>
                          </MuiBox>
                        </MuiGrid>
                        <MuiGrid item xs={6}>
                          <MuiBox sx={{ 
                            p: 1.25, 
                            borderRadius: '10px', 
                            backgroundColor: 'rgba(216, 185, 138, 0.1)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: 0.75,
                            minHeight: '50px'
                          }}>
                            <Chair size={14} style={{ color: 'var(--color-secondary-700)', flexShrink: 0 }} />
                            <MuiTypography variant="body2" sx={{ fontSize: '0.8rem', color: 'var(--color-text-primary)', lineHeight: 1.3, wordBreak: 'break-word' }}>
                              {new Intl.NumberFormat('en-US').format(hall.chairs)} كرسي
                            </MuiTypography>
                          </MuiBox>
                        </MuiGrid>
                      </MuiGrid>

                      {/* Services & Amenities */}
                      <MuiBox sx={{ display: 'flex', gap: 1, mb: 2, flexWrap: 'wrap' }}>
                        {hall.services.length > 0 && (
                          <MuiChip
                            label={`${hall.services.length} خدمة`}
                            size="small"
                            color="info"
                            icon={<Settings size={14} />}
                          />
                        )}
                        {hall.amenities.length > 0 && (
                          <MuiChip
                            label={`${hall.amenities.length} مرفق`}
                            size="small"
                            color="secondary"
                            icon={<Star size={14} />}
                          />
                        )}
                      </MuiBox>

                      {/* Manager Info */}
                      <MuiBox sx={{ 
                        p: 1.5, 
                        borderRadius: '10px', 
                        backgroundColor: 'rgba(0, 0, 0, 0.02)',
                        border: '1px solid rgba(0, 0, 0, 0.05)'
                      }}>
                        <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>
                          <User size={16} style={{ color: 'var(--color-text-secondary)' }} />
                          <MuiTypography variant="body2" sx={{ fontWeight: 600, fontSize: '0.875rem' }}>
                            {hall.manager.name}
                          </MuiTypography>
                        </MuiBox>
                        <MuiBox sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                          {hall.manager.username && (
                            <MuiTypography variant="caption" sx={{ fontSize: '0.75rem', color: 'var(--color-text-secondary)' }}>
                              @{hall.manager.username}
                            </MuiTypography>
                          )}
                          {hall.manager.phone && (
                            <MuiTypography variant="caption" sx={{ fontSize: '0.75rem', color: 'var(--color-text-secondary)' }}>
                              {formatPhoneNumber(hall.manager.phone)}
                            </MuiTypography>
                          )}
                        </MuiBox>
                      </MuiBox>
                    </MuiCardContent>

                    {/* Actions */}
                    <MuiCardActions sx={{ p: 2, pt: 0, gap: 1, flexWrap: 'wrap' }}>
                      <MuiButton
                        size="small"
                        variant="outlined"
                        onClick={() => handleOpenViewDialog(hall)}
                        start_icon={<Eye size={16} />}
                        sx={{ flex: 1, minWidth: '80px' }}
                      >
                        عرض
                      </MuiButton>
                      <MuiButton
                        size="small"
                        variant="outlined"
                        onClick={() => handleOpenDialog(hall)}
                        start_icon={<Pencil size={16} />}
                        sx={{ flex: 1, minWidth: '80px' }}
                      >
                        تعديل
                      </MuiButton>
                      <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        <MuiSwitch
                          checked={hall.isActive}
                          onChange={(e) => {
                            e.stopPropagation()
                            toggleStatusMutation.mutate({ id: hall.id, isActive: !hall.isActive })
                          }}
                          color="success"
                          size="small"
                        />
                        <MuiTypography variant="caption" sx={{ fontSize: '0.75rem', color: 'var(--color-text-secondary)' }}>
                          {hall.isActive ? 'نشطة' : 'غير نشطة'}
                        </MuiTypography>
                      </MuiBox>
                      <MuiButton
                        size="small"
                        color="error"
                        variant="outlined"
                        onClick={() => handleOpenConfirm(hall, 'delete')}
                        start_icon={<Trash2 size={16} />}
                        sx={{ flex: 1, minWidth: '80px' }}
                      >
                        حذف
                      </MuiButton>
                    </MuiCardActions>
                  </MuiCard>
                )}
              />

              {/* Pagination for Cards View */}
              {hallsResponse?.pagination && (
                <MuiPaper sx={{ mt: 3, borderRadius: '16px', overflow: 'hidden' }}>
                  <TablePagination
                    page={pagination.page}
                    limit={pagination.limit}
                    total={hallsResponse.pagination.totalItems || 0}
                    totalPages={pagination.totalPages}
                    onPageChange={(newPage) => setPagination(prev => ({ ...prev, page: newPage }))}
                    onRowsPerPageChange={(newLimit) => setPagination(prev => ({ 
                      ...prev, 
                      limit: newLimit,
                      page: 1
                    }))}
                    rowsPerPageOptions={[6, 12, 24, 48]}
                    label="عدد القاعات في الصفحة:"
                  />
                </MuiPaper>
              )}
            </>
          )}
        </>
      )}

      {/* ====================== Dialogs ====================== */}

      {/* Add/Edit Dialog */}
      <MuiDialog
        open={dialogOpen}
        onClose={handleCloseDialog}
        maxWidth="lg"
        fullWidth
        fullHeight
        PaperProps={{
          sx: { 
            borderRadius: 3,
            maxHeight: '95vh',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden',
            width: '100%'
          }
        }}
      >
        <MuiBox sx={{ display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0, height: '100%' }}>
          {/* Title */}
          <MuiDialogTitle 
            onClose={handleCloseDialog}
            sx={{ 
              flexShrink: 0,
              backgroundColor: 'primary.light',
              color: 'primary.contrastText',
              py: 2
            }}
          >
            <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
              <Building2 size={24} />
              <span>{editingHall ? 'تعديل القاعة' : 'إضافة قاعة جديدة'}</span>
            </MuiBox>
          </MuiDialogTitle>

          <form onSubmit={handleSubmit(onSubmit)} style={{ display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0, overflow: 'hidden' }}>
            <MuiDialogContent 
              dividers 
              sx={{ 
                pt: 3,
                flex: 1,
                minHeight: 0,
                overflowY: 'auto',
                overflowX: 'hidden'
              }}
            >
              <MuiGrid container spacing={2}>
                {/* Basic Information */}
                <MuiGrid item xs={12}>
                  <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main', display: 'flex', alignItems: 'center', gap: 1 }}>
                    <Building2 size={20} />
                    المعلومات الأساسية
                  </MuiTypography>
                </MuiGrid>

                <MuiGrid item xs={12} md={6}>
                  <Controller
                    name="name"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="اسم القاعة *"
                        fullWidth
                        size="small"
                        error={!!errors.name}
                        helperText={errors.name?.message}
                        required
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12} md={6}>
                  <Controller
                    name="location"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="الموقع *"
                        fullWidth
                        size="small"
                        error={!!errors.location}
                        helperText={errors.location?.message}
                        required
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12}>
                  <Controller
                    name="address"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="العنوان التفصيلي *"
                        fullWidth
                        size="small"
                        multiline
                        rows={2}
                        error={!!errors.address}
                        helperText={errors.address?.message}
                        required
                        placeholder="العنوان الكامل للقاعة..."
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12} md={6}>
                  <Controller
                    name="capacity"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="السعة (عدد الأشخاص) *"
                        type="number"
                        fullWidth
                        size="small"
                        error={!!errors.capacity}
                        helperText={errors.capacity?.message}
                        required
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12} md={6}>
                  <Controller
                    name="defaultPrices"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="السعر الافتراضي (للشخص) *"
                        type="number"
                        fullWidth
                        size="small"
                        error={!!errors.defaultPrices}
                        helperText={errors.defaultPrices?.message}
                        required
                        InputProps={{
                          startAdornment: (
                            <MuiBox sx={{ color: 'text.secondary', mr: 1 }}>
                              <DollarSign size={16} />
                            </MuiBox>
                          )
                        }}
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12}>
                  <Controller
                    name="description"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="الوصف"
                        fullWidth
                        size="small"
                        multiline
                        rows={3}
                        error={!!errors.description}
                        helperText={errors.description?.message}
                        placeholder="وصف مختصر للقاعة والمميزات..."
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12}>
                  <MuiDivider sx={{ my: 2 }} />
                  <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main', display: 'flex', alignItems: 'center', gap: 1 }}>
                    <Table size={20} />
                    المعدات والتجهيزات
                  </MuiTypography>
                </MuiGrid>

                <MuiGrid item xs={12} md={4}>
                  <Controller
                    name="tables"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="عدد الطاولات *"
                        type="number"
                        fullWidth
                        size="small"
                        error={!!errors.tables}
                        helperText={errors.tables?.message}
                        required
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12} md={4}>
                  <Controller
                    name="chairs"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="عدد الكراسي *"
                        type="number"
                        fullWidth
                        size="small"
                        error={!!errors.chairs}
                        helperText={errors.chairs?.message}
                        required
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12} md={4}>
                  <Controller
                    name="maxEmployees"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="الحد الأقصى للموظفين *"
                        type="number"
                        fullWidth
                        size="small"
                        error={!!errors.maxEmployees}
                        helperText={errors.maxEmployees?.message}
                        required
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12}>
                  <MuiDivider sx={{ my: 2 }} />
                  <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main', display: 'flex', alignItems: 'center', gap: 1 }}>
                    <Settings size={20} />
                    المرافق والخدمات
                  </MuiTypography>
                </MuiGrid>

                <MuiGrid item xs={12}>
                  <Controller
                    name="amenities"
                    control={control}
                    render={({ field }) => (
                      <MuiAutocomplete
                        multiple
                        options={[
                          'واي فاي',
                          'موقف سيارات',
                          'تكييف مركزي',
                          'مطعم',
                          'موسيقى',
                          'تجهيزات فاخرة',
                          'ديكورات مميزة',
                          'إضاءة احترافية',
                          'صوتيات متطورة',
                          'شاشات عرض'
                        ]}
                        value={field.value}
                        onChange={(event, newValue) => field.onChange(newValue)}
                        renderInput={(params) => (
                          <MuiTextField
                            {...params}
                            label="المرافق"
                            size="small"
                            placeholder="اختر المرافق المتاحة"
                          />
                        )}
                        renderTags={(value, getTagProps) =>
                          value.map((option, index) => (
                            <MuiChip
                              label={option}
                              size="small"
                              {...getTagProps({ index })}
                              icon={getAmenityIcon(option)}
                            />
                          ))
                        }
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12}>
                  <MuiBox sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 2 }}>
                    <MuiTypography variant="body2">
                      الخدمات المرفقة ({selectedServices.length})
                    </MuiTypography>
                    <MuiButton
                      size="small"
                      variant="outlined"
                      onClick={handleOpenServicesDialog}
                      start_icon={<Settings size={16} />}
                    >
                      إدارة الخدمات
                    </MuiButton>
                  </MuiBox>
                  {selectedServices.length > 0 ? (
                    <MuiBox sx={{ 
                      p: 2, 
                      backgroundColor: 'background.default', 
                      borderRadius: 2,
                      border: '1px dashed',
                      borderColor: 'divider'
                    }}>
                      <MuiGrid container spacing={1}>
                        {selectedServices.map((service, index) => {
                          const serviceDetails = availableServices.find(s => s._id === service.service)
                          return (
                            <MuiGrid item xs={12} key={index}>
                              <MuiBox sx={{ 
                                p: 1.5, 
                                backgroundColor: 'rgba(0, 0, 0, 0.02)', 
                                borderRadius: 1,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between'
                              }}>
                                <MuiBox>
                                  <MuiTypography variant="body2" sx={{ fontWeight: 600 }}>
                                    {serviceDetails?.name || 'خدمة غير معروفة'}
                                  </MuiTypography>
                                  <MuiTypography variant="caption" sx={{ color: 'text.secondary' }}>
                                    السعر: {formatCurrency(service.customPrice || serviceDetails?.basePrice || 0)}
                                    {service.isIncluded && ' • مدرجة في السعر الأساسي'}
                                  </MuiTypography>
                                </MuiBox>
                                <MuiChip
                                  label={service.isIncluded ? 'مدرجة' : 'إضافية'}
                                  color={service.isIncluded ? 'success' : 'info'}
                                  size="small"
                                />
                              </MuiBox>
                            </MuiGrid>
                          )
                        })}
                      </MuiGrid>
                    </MuiBox>
                  ) : (
                    <MuiAlert severity="info" sx={{ mb: 2 }}>
                      لم يتم إضافة أي خدمات بعد
                    </MuiAlert>
                  )}
                </MuiGrid>

                <MuiGrid item xs={12}>
                  <MuiDivider sx={{ my: 2 }} />
                  <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main', display: 'flex', alignItems: 'center', gap: 1 }}>
                    <User size={20} />
                    بيانات المدير
                  </MuiTypography>
                </MuiGrid>

                <MuiGrid item xs={12} md={6}>
                  <Controller
                    name="managerName"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="اسم المدير *"
                        fullWidth
                        size="small"
                        error={!!errors.managerName}
                        helperText={errors.managerName?.message}
                        required
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12} md={6}>
                  <Controller
                    name="managerUsername"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="اسم المستخدم *"
                        fullWidth
                        size="small"
                        error={!!errors.managerUsername}
                        helperText={errors.managerUsername?.message}
                        required
                        InputProps={{
                          startAdornment: (
                            <MuiBox sx={{ color: 'text.secondary', mr: 1 }}>
                              @
                            </MuiBox>
                          )
                        }}
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12} md={6}>
                  <Controller
                    name="managerPhone"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label="رقم هاتف المدير *"
                        fullWidth
                        size="small"
                        error={!!errors.managerPhone}
                        helperText={errors.managerPhone?.message}
                        required
                        placeholder="أرقام فقط"
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12} md={6}>
                  <Controller
                    name="managerPassword"
                    control={control}
                    render={({ field }) => (
                      <MuiTextField
                        {...field}
                        label={editingHall ? "كلمة المرور (اتركها فارغة للإبقاء على الحالية)" : "كلمة المرور *"}
                        type="password"
                        fullWidth
                        size="small"
                        error={!!errors.managerPassword}
                        helperText={errors.managerPassword?.message}
                        required={!editingHall}
                      />
                    )}
                  />
                </MuiGrid>

                <MuiGrid item xs={12}>
                  <MuiDivider sx={{ my: 2 }} />
                  <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main', display: 'flex', alignItems: 'center', gap: 1 }}>
                    <ImageIcon size={20} />
                    الصور
                  </MuiTypography>
                  
                  {/* Upload Button */}
                  <MuiBox sx={{ mb: 2 }}>
                    <input
                      ref={fileInputRef}
                      accept="image/*"
                      style={{ display: 'none' }}
                      id="image-upload"
                      type="file"
                      multiple
                      onChange={handleImageUpload}
                      disabled={uploadingImages}
                    />
                    <label htmlFor="image-upload">
                      <MuiButton
                        variant="contained"
                        component="span"
                        start_icon={uploadingImages ? <MuiCircularProgress size={20} /> : <Upload size={16} />}
                        size="small"
                        disabled={uploadingImages}
                      >
                        {uploadingImages ? 'جاري الرفع...' : 'رفع صور'}
                      </MuiButton>
                    </label>
                    <MuiTypography variant="caption" sx={{ color: 'text.secondary', ml: 2 }}>
                      يمكنك رفع أكثر من صورة (JPG, PNG, GIF)
                    </MuiTypography>
                  </MuiBox>
                  
                  {/* Images Gallery */}
                  <MuiBox sx={{ display: 'flex', flexWrap: 'wrap', gap: 2, mb: 2 }}>
                    {watchedImages && watchedImages.map((image, index) => (
                      <MuiBox
                        key={index}
                        sx={{
                          width: 120,
                          height: 120,
                          borderRadius: 2,
                          overflow: 'hidden',
                          position: 'relative',
                          border: watchedPrimaryImage === image ? '3px solid' : '1px solid',
                          borderColor: watchedPrimaryImage === image ? 'primary.main' : 'divider',
                          cursor: 'pointer',
                          '&:hover': {
                            '& .image-overlay': {
                              opacity: 1
                            }
                          }
                        }}
                      >
                        <img
                          src={image}
                          alt={`صورة ${index + 1}`}
                          style={{ 
                            width: '100%', 
                            height: '100%', 
                            objectFit: 'cover',
                            transition: 'transform 0.3s ease'
                          }}
                        />
                        
                        {/* Uploading Overlay */}
                        {uploadingImages && (
                          <MuiBox
                            sx={{
                              position: 'absolute',
                              top: 0,
                              left: 0,
                              right: 0,
                              bottom: 0,
                              backgroundColor: 'rgba(0,0,0,0.7)',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center'
                            }}
                          >
                            <MuiCircularProgress size={30} sx={{ color: 'white' }} />
                          </MuiBox>
                        )}
                        
                        {/* Action Overlay */}
                        <MuiBox
                          className="image-overlay"
                          sx={{
                            position: 'absolute',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            backgroundColor: 'rgba(0,0,0,0.7)',
                            opacity: 0,
                            transition: 'opacity 0.2s',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: 1
                          }}
                        >
                          <MuiButton
                            size="small"
                            variant={watchedPrimaryImage === image ? "contained" : "outlined"}
                            color={watchedPrimaryImage === image ? "primary" : "inherit"}
                            onClick={() => handleSetPrimaryImage(image)}
                            disabled={uploadingImages}
                            sx={{ color: 'white', borderColor: 'white' }}
                          >
                            {watchedPrimaryImage === image ? 'رئيسية' : 'تعيين كرئيسية'}
                          </MuiButton>
                          <MuiButton
                            size="small"
                            variant="outlined"
                            color="error"
                            onClick={() => handleRemoveImage(index)}
                            disabled={uploadingImages}
                            sx={{ color: 'white', borderColor: 'white' }}
                          >
                            حذف
                          </MuiButton>
                        </MuiBox>
                        
                        {/* Primary Image Badge */}
                        {watchedPrimaryImage === image && (
                          <MuiBox
                            sx={{
                              position: 'absolute',
                              top: 8,
                              right: 8,
                              backgroundColor: 'primary.main',
                              color: 'white',
                              borderRadius: '50%',
                              width: 28,
                              height: 28,
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '0.75rem',
                              fontWeight: 'bold'
                            }}
                          >
                            <Star size={14} />
                          </MuiBox>
                        )}
                      </MuiBox>
                    ))}
                  </MuiBox>
                  
                  {(!watchedImages || watchedImages.length === 0) && (
                    <MuiAlert severity="info">
                      لم يتم رفع أي صور بعد. اضغط على "رفع صور" لإضافة صور للقاعة.
                    </MuiAlert>
                  )}
                </MuiGrid>

                {/* Status Field */}
                <MuiGrid item xs={12}>
                  <MuiDivider sx={{ my: 2 }} />
                  <MuiTypography variant="body2" color="text.secondary" sx={{ mb: 2, display: 'flex', alignItems: 'center', gap: 1 }}>
                    <Shield size={16} />
                    حالة القاعة:
                  </MuiTypography>
                  <Controller
                    name="isActive"
                    control={control}
                    render={({ field }) => (
                      <MuiBox sx={{ display: 'flex', gap: 2 }}>
                        <MuiButton
                          variant={field.value ? "contained" : "outlined"}
                          color="success"
                          size="small"
                          onClick={() => field.onChange(true)}
                          start_icon={<Check size={16} />}
                        >
                          نشطة
                        </MuiButton>
                        <MuiButton
                          variant={!field.value ? "contained" : "outlined"}
                          color="warning"
                          size="small"
                          onClick={() => field.onChange(false)}
                          start_icon={<X size={16} />}
                        >
                          غير نشطة
                        </MuiButton>
                      </MuiBox>
                    )}
                  />
                </MuiGrid>
              </MuiGrid>
            </MuiDialogContent>

            <MuiDialogActions
              sx={{
                flexShrink: 0,
                borderTop: '1px solid rgba(0, 0, 0, 0.12)',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                px: 3,
                py: 2
              }}
            >
              <MuiButton
                onClick={handleCloseDialog}
                color="inherit"
                disabled={isSubmitting}
                size="small"
              >
                إلغاء
              </MuiButton>
              <MuiButton
                type="submit"
                variant="contained"
                color="primary"
                disabled={isSubmitting}
                start_icon={isSubmitting ? <MuiCircularProgress size={20} /> : null}
                size="small"
              >
                {isSubmitting ? 'جاري الحفظ...' : (editingHall ? 'تحديث' : 'حفظ')}
              </MuiButton>
            </MuiDialogActions>
          </form>
        </MuiBox>
      </MuiDialog>

      {/* Services Management Dialog */}
      <MuiDialog
        open={servicesDialogOpen}
        onClose={handleCloseServicesDialog}
        maxWidth="md"
        fullWidth
      >
        <MuiDialogTitle>
          <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
            <Settings size={24} />
            <span>إدارة الخدمات</span>
          </MuiBox>
        </MuiDialogTitle>
        
        <MuiDialogContent dividers sx={{ pt: 3 }}>
          <MuiGrid container spacing={2}>
            <MuiGrid item xs={12}>
              <MuiTypography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                اختر الخدمات المقدمة في القاعة:
              </MuiTypography>
            </MuiGrid>
            
            {/* Available Services */}
            <MuiGrid item xs={12}>
              <MuiTypography variant="subtitle2" sx={{ mb: 1 }}>
                الخدمات المتاحة
              </MuiTypography>
              <MuiBox sx={{ display: 'flex', flexWrap: 'wrap', gap: 1, mb: 3 }}>
                {availableServices.filter(service => 
                  !selectedServices.some(s => s.service === service._id)
                ).map(service => (
                  <MuiChip
                    key={service._id}
                    label={`${service.name} - ${formatCurrency(service.basePrice || 0)}`}
                    onClick={() => handleAddService(service)}
                    color="primary"
                    variant="outlined"
                    size="small"
                  />
                ))}
              </MuiBox>
            </MuiGrid>
            
            {/* Selected Services */}
            <MuiGrid item xs={12}>
              <MuiTypography variant="subtitle2" sx={{ mb: 1 }}>
                الخدمات المختارة ({selectedServices.length})
              </MuiTypography>
              {selectedServices.length === 0 ? (
                <MuiAlert severity="info">
                  لم يتم اختيار أي خدمات بعد
                </MuiAlert>
              ) : (
                <MuiGrid container spacing={2}>
                  {selectedServices.map((service, index) => {
                    const serviceDetails = availableServices.find(s => s._id === service.service)
                    return (
                      <MuiGrid item xs={12} key={index}>
                        <MuiPaper sx={{ p: 2, borderRadius: 2 }}>
                          <MuiBox sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 2 }}>
                            <MuiTypography variant="body1" sx={{ fontWeight: 600 }}>
                              {serviceDetails?.name || 'خدمة غير معروفة'}
                            </MuiTypography>
                            <MuiButton
                              size="small"
                              color="error"
                              variant="outlined"
                              onClick={() => handleRemoveService(index)}
                            >
                              حذف
                            </MuiButton>
                          </MuiBox>
                          
                          <MuiGrid container spacing={2}>
                            <MuiGrid item xs={12} md={6}>
                              <MuiTextField
                                label="السعر المخصص"
                                type="number"
                                size="small"
                                fullWidth
                                value={service.customPrice || ''}
                                onChange={(e) => handleUpdateService(index, { 
                                  customPrice: e.target.value ? Number(e.target.value) : undefined 
                                })}
                                InputProps={{
                                  startAdornment: (
                                    <MuiBox sx={{ color: 'text.secondary', mr: 1 }}>
                                      <DollarSign size={16} />
                                    </MuiBox>
                                  )
                                }}
                              />
                            </MuiGrid>
                            <MuiGrid item xs={12} md={6}>
                              <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                                <MuiTypography variant="body2">
                                  مدرجة في السعر الأساسي:
                                </MuiTypography>
                                <MuiSwitch
                                  checked={service.isIncluded || false}
                                  onChange={(e) => handleUpdateService(index, { 
                                    isIncluded: e.target.checked 
                                  })}
                                  color="success"
                                  size="small"
                                />
                              </MuiBox>
                            </MuiGrid>
                            <MuiGrid item xs={12}>
                              <MuiTextField
                                label="ملاحظات"
                                size="small"
                                fullWidth
                                multiline
                                rows={2}
                                value={service.notes || ''}
                                onChange={(e) => handleUpdateService(index, { 
                                  notes: e.target.value 
                                })}
                                placeholder="ملاحظات إضافية حول هذه الخدمة..."
                              />
                            </MuiGrid>
                          </MuiGrid>
                        </MuiPaper>
                      </MuiGrid>
                    )
                  })}
                </MuiGrid>
              )}
            </MuiGrid>
          </MuiGrid>
        </MuiDialogContent>
        
        <MuiDialogActions>
          <MuiButton onClick={handleCloseServicesDialog} color="inherit" size="small">
            إلغاء
          </MuiButton>
          <MuiButton onClick={handleSaveServices} variant="contained" color="primary" size="small">
            حفظ الخدمات
          </MuiButton>
        </MuiDialogActions>
      </MuiDialog>

      {/* View Dialog */}
      <MuiDialog
        open={viewDialogOpen}
        onClose={handleCloseViewDialog}
        maxWidth="md"
        fullWidth
        PaperProps={{
          sx: { 
            borderRadius: 3,
            maxHeight: '90vh',
            display: 'flex',
            flexDirection: 'column'
          }
        }}
      >
        {viewingHall && (
          <>
            <MuiDialogTitle onClose={handleCloseViewDialog} sx={{ 
              backgroundColor: 'info.light', 
              color: 'info.contrastText',
              py: 2,
              position: 'sticky',
              top: 0,
              zIndex: 1,
              flexShrink: 0
            }}>
              <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2, flexWrap: 'wrap' }}>
                <Building2 size={24} />
                <span style={{ wordBreak: 'break-word' }}>تفاصيل القاعة: {viewingHall.name}</span>
              </MuiBox>
            </MuiDialogTitle>
            
            <MuiDialogContent 
              dividers 
              sx={{ 
                pt: 3,
                flex: 1,
                overflowY: 'auto',
                overflowX: 'hidden'
              }}
            >
              {/* Images Gallery */}
              {viewingHall.images.length > 0 && (
                <MuiGrid item xs={12} sx={{ mb: 3 }}>
                  <MuiTypography variant="h6" sx={{ mb: 2, display: 'flex', alignItems: 'center', gap: 1 }}>
                    <ImageIcon size={20} />
                    معرض الصور ({viewingHall.images.length})
                  </MuiTypography>
                  <MuiBox sx={{ 
                    display: 'flex', 
                    gap: 2, 
                    overflowX: 'auto',
                    pb: 2,
                    '&::-webkit-scrollbar': {
                      height: 8,
                    },
                    '&::-webkit-scrollbar-track': {
                      background: 'rgba(0,0,0,0.05)',
                      borderRadius: 4,
                    },
                    '&::-webkit-scrollbar-thumb': {
                      background: 'rgba(0,0,0,0.2)',
                      borderRadius: 4,
                    }
                  }}>
                    {viewingHall.images.map((image, index) => (
                      <MuiBox
                        key={index}
                        sx={{
                          width: 200,
                          height: 150,
                          borderRadius: 2,
                          overflow: 'hidden',
                          flexShrink: 0,
                          position: 'relative',
                          border: viewingHall.primaryImage === image ? '3px solid' : '1px solid',
                          borderColor: viewingHall.primaryImage === image ? 'primary.main' : 'divider',
                          cursor: 'pointer',
                          '&:hover img': {
                            transform: 'scale(1.05)'
                          }
                        }}
                      >
                        <img
                          src={image}
                          alt={`صورة ${index + 1}`}
                          style={{ 
                            width: '100%', 
                            height: '100%', 
                            objectFit: 'cover',
                            transition: 'transform 0.3s ease'
                          }}
                        />
                        {viewingHall.primaryImage === image && (
                          <MuiBox
                            sx={{
                              position: 'absolute',
                              top: 8,
                              right: 8,
                              backgroundColor: 'primary.main',
                              color: 'white',
                              borderRadius: '50%',
                              width: 28,
                              height: 28,
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '0.75rem',
                              fontWeight: 'bold'
                            }}
                          >
                            رئيسية
                          </MuiBox>
                        )}
                      </MuiBox>
                    ))}
                  </MuiBox>
                </MuiGrid>
              )}

              <MuiGrid container spacing={3}>
                {/* Basic Information */}
                <MuiGrid item xs={12}>
                  <MuiPaper sx={{ p: 3, borderRadius: 2 }}>
                    <MuiTypography variant="h6" sx={{ mb: 3, display: 'flex', alignItems: 'center', gap: 1 }}>
                      <Building2 size={20} />
                      المعلومات الأساسية
                    </MuiTypography>
                    
                    <MuiGrid container spacing={2}>
                      <MuiGrid item xs={12} md={6}>
                        <MuiTypography variant="body2" color="text.secondary">الاسم:</MuiTypography>
                        <MuiTypography variant="body1" fontWeight="bold">{viewingHall.name}</MuiTypography>
                      </MuiGrid>
                      <MuiGrid item xs={12} md={6}>
                        <MuiTypography variant="body2" color="text.secondary">الموقع:</MuiTypography>
                        <MuiTypography variant="body1">{viewingHall.location}</MuiTypography>
                      </MuiGrid>
                      <MuiGrid item xs={12}>
                        <MuiTypography variant="body2" color="text.secondary">العنوان التفصيلي:</MuiTypography>
                        <MuiTypography variant="body1">{viewingHall.address}</MuiTypography>
                      </MuiGrid>
                      <MuiGrid item xs={12} md={6}>
                        <MuiTypography variant="body2" color="text.secondary">السعة:</MuiTypography>
                        <MuiTypography variant="body1" fontWeight="bold">
                          {viewingHall.capacity.toLocaleString()} شخص
                        </MuiTypography>
                      </MuiGrid>
                      <MuiGrid item xs={12} md={6}>
                        <MuiTypography variant="body2" color="text.secondary">السعر الافتراضي:</MuiTypography>
                        <MuiTypography variant="body1" color="success.main" fontWeight="bold">
                          {formatCurrency(viewingHall.defaultPrices)} للشخص
                        </MuiTypography>
                      </MuiGrid>
                      <MuiGrid item xs={12}>
                        <MuiTypography variant="body2" color="text.secondary">الحالة:</MuiTypography>
                        <MuiChip
                          label={viewingHall.isActive ? 'نشطة' : 'غير نشطة'}
                          color={viewingHall.isActive ? 'success' : 'warning'}
                          size="small"
                          sx={{ mt: 0.5 }}
                        />
                      </MuiGrid>
                    </MuiGrid>
                  </MuiPaper>
                </MuiGrid>

                {/* Description */}
                {viewingHall.description && (
                  <MuiGrid item xs={12}>
                    <MuiPaper sx={{ p: 3, borderRadius: 2 }}>
                      <MuiTypography variant="h6" sx={{ mb: 2, display: 'flex', alignItems: 'center', gap: 1 }}>
                        <FileText size={20} />
                        الوصف
                      </MuiTypography>
                      <MuiTypography variant="body1" sx={{ whiteSpace: 'pre-line' }}>
                        {viewingHall.description}
                      </MuiTypography>
                    </MuiPaper>
                  </MuiGrid>
                )}

                {/* Equipment */}
                <MuiGrid item xs={12} md={6}>
                  <MuiPaper sx={{ p: 3, borderRadius: 2, height: '100%' }}>
                    <MuiTypography variant="h6" sx={{ mb: 3, display: 'flex', alignItems: 'center', gap: 1 }}>
                      <Table size={20} />
                      المعدات
                    </MuiTypography>
                    
                    <MuiGrid container spacing={2}>
                      <MuiGrid item xs={6}>
                        <MuiBox sx={{ textAlign: 'center' }}>
                          <MuiTypography variant="h4" color="primary.main" fontWeight="bold">
                            {viewingHall.tables}
                          </MuiTypography>
                          <MuiTypography variant="body2" color="text.secondary">
                            طاولة
                          </MuiTypography>
                        </MuiBox>
                      </MuiGrid>
                      <MuiGrid item xs={6}>
                        <MuiBox sx={{ textAlign: 'center' }}>
                          <MuiTypography variant="h4" color="primary.main" fontWeight="bold">
                            {viewingHall.chairs}
                          </MuiTypography>
                          <MuiTypography variant="body2" color="text.secondary">
                            كرسي
                          </MuiTypography>
                        </MuiBox>
                      </MuiGrid>
                      <MuiGrid item xs={12}>
                        <MuiDivider sx={{ my: 2 }} />
                        <MuiTypography variant="body2" color="text.secondary">الحد الأقصى للموظفين:</MuiTypography>
                        <MuiTypography variant="body1" fontWeight="bold">
                          {viewingHall.maxEmployees} موظف
                        </MuiTypography>
                      </MuiGrid>
                    </MuiGrid>
                  </MuiPaper>
                </MuiGrid>

                {/* Manager Information */}
                <MuiGrid item xs={12} md={6}>
                  <MuiPaper sx={{ p: 3, borderRadius: 2, height: '100%' }}>
                    <MuiTypography variant="h6" sx={{ mb: 3, display: 'flex', alignItems: 'center', gap: 1 }}>
                      <User size={20} />
                      بيانات المدير
                    </MuiTypography>
                    
                    <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 2 }}>
                      <MuiAvatar
                        sx={{ 
                          width: 60, 
                          height: 60,
                          backgroundColor: 'primary.light',
                          color: 'primary.contrastText',
                          fontSize: '1.25rem',
                          fontWeight: 'bold'
                        }}
                      >
                        {viewingHall.manager.name.charAt(0)}
                      </MuiAvatar>
                      <MuiBox>
                        <MuiTypography variant="body1" fontWeight="bold">
                          {viewingHall.manager.name}
                        </MuiTypography>
                        {viewingHall.manager.username && (
                          <MuiTypography variant="body2" color="text.secondary">
                            @{viewingHall.manager.username}
                          </MuiTypography>
                        )}
                        {viewingHall.manager.phone && (
                          <MuiTypography variant="body2" color="text.secondary" dir="ltr">
                            {formatPhoneNumber(viewingHall.manager.phone)}
                          </MuiTypography>
                        )}
                      </MuiBox>
                    </MuiBox>
                  </MuiPaper>
                </MuiGrid>

                {/* Amenities */}
                {viewingHall.amenities.length > 0 && (
                  <MuiGrid item xs={12}>
                    <MuiPaper sx={{ p: 3, borderRadius: 2 }}>
                      <MuiTypography variant="h6" sx={{ mb: 3, display: 'flex', alignItems: 'center', gap: 1 }}>
                        <Star size={20} />
                        المرافق المتاحة ({viewingHall.amenities.length})
                      </MuiTypography>
                      <MuiBox sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
                        {viewingHall.amenities.map((amenity, index) => (
                          <MuiChip
                            key={index}
                            label={amenity}
                            icon={getAmenityIcon(amenity)}
                            color="primary"
                            variant="outlined"
                            size="medium"
                          />
                        ))}
                      </MuiBox>
                    </MuiPaper>
                  </MuiGrid>
                )}

                {/* Services */}
                {viewingHall.services.length > 0 && (
                  <MuiGrid item xs={12}>
                    <MuiPaper sx={{ p: 3, borderRadius: 2 }}>
                      <MuiTypography variant="h6" sx={{ mb: 3, display: 'flex', alignItems: 'center', gap: 1 }}>
                        <Settings size={20} />
                        الخدمات المرفقة ({viewingHall.services.length})
                      </MuiTypography>
                      <MuiGrid container spacing={2}>
                        {viewingHall.services.map((service, index) => (
                          <MuiGrid item xs={12} md={6} key={index}>
                            <MuiPaper sx={{ p: 2, borderRadius: 2, borderLeft: '4px solid', borderLeftColor: service.isIncluded ? 'success.main' : 'info.main' }}>
                              <MuiBox sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 1 }}>
                                <MuiTypography variant="body1" fontWeight="bold">
                                  {service.serviceDetails?.name || service.service || 'خدمة غير معروفة'}
                                </MuiTypography>
                                <MuiChip
                                  label={service.isIncluded ? 'مدرجة' : 'إضافية'}
                                  color={service.isIncluded ? 'success' : 'info'}
                                  size="small"
                                />
                              </MuiBox>
                              <MuiTypography variant="body2" color="success.main" fontWeight="bold">
                                {formatCurrency(service.customPrice || service.serviceDetails?.basePrice || 0)}
                              </MuiTypography>
                              {service.notes && (
                                <MuiTypography variant="body2" color="text.secondary" sx={{ mt: 1, fontSize: '0.875rem' }}>
                                  {service.notes}
                                </MuiTypography>
                              )}
                            </MuiPaper>
                          </MuiGrid>
                        ))}
                      </MuiGrid>
                    </MuiPaper>
                  </MuiGrid>
                )}

                {/* Dates */}
                <MuiGrid item xs={12}>
                  <MuiPaper sx={{ p: 3, borderRadius: 2 }}>
                    <MuiTypography variant="h6" sx={{ mb: 3, display: 'flex', alignItems: 'center', gap: 1 }}>
                      <Calendar size={20} />
                      معلومات إضافية
                    </MuiTypography>
                    <MuiGrid container spacing={2}>
                      <MuiGrid item xs={12} md={6}>
                        <MuiTypography variant="body2" color="text.secondary">تاريخ الإنشاء:</MuiTypography>
                        <MuiTypography variant="body1">
                          <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                            <Calendar size={14} />
                            {viewingHall.createdAt.toLocaleDateString('ar-SA')}
                          </MuiBox>
                          <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1, mt: 0.5 }}>
                            <Clock size={14} />
                            {viewingHall.createdAt.toLocaleTimeString('ar-SA')}
                          </MuiBox>
                        </MuiTypography>
                      </MuiGrid>
                      <MuiGrid item xs={12} md={6}>
                        <MuiTypography variant="body2" color="text.secondary">آخر تحديث:</MuiTypography>
                        <MuiTypography variant="body1">
                          <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                            <Calendar size={14} />
                            {viewingHall.updatedAt.toLocaleDateString('ar-SA')}
                          </MuiBox>
                          <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1, mt: 0.5 }}>
                            <Clock size={14} />
                            {viewingHall.updatedAt.toLocaleTimeString('ar-SA')}
                          </MuiBox>
                        </MuiTypography>
                      </MuiGrid>
                    </MuiGrid>
                  </MuiPaper>
                </MuiGrid>
              </MuiGrid>
            </MuiDialogContent>
            
            <MuiDialogActions sx={{ 
              px: 3, 
              py: 2, 
              position: 'sticky', 
              bottom: 0, 
              backgroundColor: 'background.paper',
              borderTop: '1px solid rgba(0, 0, 0, 0.08)',
              zIndex: 1,
              flexShrink: 0
            }}>
              <MuiButton
                onClick={() => {
                  handleCloseViewDialog()
                  handleOpenDialog(viewingHall)
                }}
                color="primary"
                variant="contained"
                size="small"
                start_icon={<Pencil size={16} />}
              >
                تعديل
              </MuiButton>
              <MuiButton
                onClick={handleCloseViewDialog}
                color="inherit"
                size="small"
              >
                إغلاق
              </MuiButton>
            </MuiDialogActions>
          </>
        )}
      </MuiDialog>

      {/* Filter Dialog */}
      <MuiDialog
        open={filterDialogOpen}
        onClose={handleCloseFilterDialog}
        maxWidth="xs"
        fullWidth
      >
        <MuiDialogTitle>
          <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
            <Filter size={24} />
            <span>تصفية القاعات</span>
          </MuiBox>
        </MuiDialogTitle>
        
        <MuiDialogContent dividers>
          <MuiGrid container spacing={2}>
            <MuiGrid item xs={12} sm={6}>
              <MuiTextField
                label="الحد الأدنى للسعة"
                type="number"
                fullWidth
                size="small"
                value={filters.minCapacity}
                onChange={(e) => setFilters(prev => ({ ...prev, minCapacity: e.target.value }))}
              />
            </MuiGrid>
            
            <MuiGrid item xs={12} sm={6}>
              <MuiTextField
                label="الحد الأقصى للسعة"
                type="number"
                fullWidth
                size="small"
                value={filters.maxCapacity}
                onChange={(e) => setFilters(prev => ({ ...prev, maxCapacity: e.target.value }))}
              />
            </MuiGrid>
            
            <MuiGrid item xs={12} sm={6}>
              <MuiTextField
                label="الحد الأدنى للسعر"
                type="number"
                fullWidth
                size="small"
                value={filters.minPrice}
                onChange={(e) => setFilters(prev => ({ ...prev, minPrice: e.target.value }))}
              />
            </MuiGrid>
            
            <MuiGrid item xs={12} sm={6}>
              <MuiTextField
                label="الحد الأقصى للسعر"
                type="number"
                fullWidth
                size="small"
                value={filters.maxPrice}
                onChange={(e) => setFilters(prev => ({ ...prev, maxPrice: e.target.value }))}
              />
            </MuiGrid>
            
            <MuiGrid item xs={12}>
              <MuiTypography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                حالة القاعة:
              </MuiTypography>
              <MuiBox sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
                <MuiButton
                  variant={filters.isActive === 'all' ? "contained" : "outlined"}
                  color="primary"
                  size="small"
                  onClick={() => setFilters(prev => ({ ...prev, isActive: 'all' }))}
                >
                  الكل
                </MuiButton>
                <MuiButton
                  variant={filters.isActive === 'active' ? "contained" : "outlined"}
                  color="success"
                  size="small"
                  onClick={() => setFilters(prev => ({ ...prev, isActive: 'active' }))}
                >
                  النشطة فقط
                </MuiButton>
                <MuiButton
                  variant={filters.isActive === 'inactive' ? "contained" : "outlined"}
                  color="warning"
                  size="small"
                  onClick={() => setFilters(prev => ({ ...prev, isActive: 'inactive' }))}
                >
                  غير النشطة فقط
                </MuiButton>
              </MuiBox>
            </MuiGrid>
          </MuiGrid>
        </MuiDialogContent>
        
        <MuiDialogActions>
          <MuiButton onClick={handleResetFilters} color="inherit" size="small">
            إعادة التعيين
          </MuiButton>
          <MuiButton onClick={handleCloseFilterDialog} color="inherit" size="small">
            إلغاء
          </MuiButton>
          <MuiButton onClick={handleApplyFilters} variant="contained" color="primary" size="small">
            تطبيق التصفية
          </MuiButton>
        </MuiDialogActions>
      </MuiDialog>

      {/* Export Dialog */}
      <MuiDialog
        open={exportDialogOpen}
        onClose={handleCloseExportDialog}
        maxWidth="xs"
        fullWidth
      >
        <MuiDialogTitle>
          <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
            <Download size={24} />
            <span>تصدير البيانات</span>
          </MuiBox>
        </MuiDialogTitle>
        
        <MuiDialogContent dividers>
          <MuiTypography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
            سيتم تصدير {hallsResponse?.pagination?.totalItems || 0} قاعة بتنسيق Excel
          </MuiTypography>
          
          <MuiBox sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
            <MuiTypography variant="body2">
              <strong>الأعمدة المتضمنة:</strong>
            </MuiTypography>
            
            <MuiBox sx={{ pl: 2 }}>
              {exportOptions.columns.map((column, index) => (
                <MuiTypography key={index} variant="body2" color="text.secondary">
                  • {getColumnName(column)}
                </MuiTypography>
              ))}
            </MuiBox>
            
            <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2, mt: 2 }}>
              <MuiTypography variant="body2">تضمين القاعات غير النشطة:</MuiTypography>
              <MuiSwitch
                checked={exportOptions.includeInactive}
                onChange={() => setExportOptions(prev => ({ 
                  ...prev, 
                  includeInactive: !prev.includeInactive 
                }))}
                color="primary"
                size="small"
              />
            </MuiBox>
          </MuiBox>
        </MuiDialogContent>
        
        <MuiDialogActions>
          <MuiButton onClick={handleCloseExportDialog} color="inherit" size="small">
            إلغاء
          </MuiButton>
          <MuiButton 
            onClick={handleExportData} 
            variant="contained" 
            color="success"
            start_icon={<Download size={20} />}
            size="small"
          >
            بدء التصدير
          </MuiButton>
        </MuiDialogActions>
      </MuiDialog>

      {/* Confirm Dialog */}
      <ConfirmDialog
        open={confirmDialog.open}
        onClose={handleCloseConfirm}
        onConfirm={handleConfirmAction}
        title={confirmDialog.title}
        message={confirmDialog.message}
        confirmLabel={
          confirmDialog.action === 'delete' ? 'حذف' :
          confirmDialog.action === 'deactivate' ? 'تعطيل' :
          'تفعيل'
        }
        confirmColor={
          confirmDialog.action === 'delete' ? 'error' :
          confirmDialog.action === 'deactivate' ? 'warning' :
          'success'
        }
        cancelLabel="إلغاء"
        loading={deleteMutation.isPending || toggleStatusMutation.isPending}
      />
    </>
  )
}

// Helper function for column names
function getColumnName(key) {
  const columns = {
    'name': 'اسم القاعة',
    'location': 'الموقع',
    'address': 'العنوان',
    'capacity': 'السعة',
    'tables': 'الطاولات',
    'chairs': 'الكراسي',
    'maxEmployees': 'الموظفين',
    'defaultPrices': 'السعر',
    'manager': 'المدير',
    'services': 'الخدمات',
    'status': 'الحالة'
  }
  return columns[key] || key
}



///////////////////////////////////////////////
///////////////////////////////////////////////
///////////////////////////////////////////////
///////////////////////////////////////////////
///////////////////////////////////////////////


/**
 * Halls Management Page - إدارة القاعات
 * صفحة إدارة القاعات مع دعم كامل للـ CRUD، التصدير، والبحث المتقدم
 */

// import { useState, useMemo, useEffect } from 'react'
// import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
// import { useForm, Controller } from 'react-hook-form'
// import { zodResolver } from '@hookform/resolvers/zod'
// import { z } from 'zod'
// import { useMediaQuery, useTheme } from '@mui/material'
// import * as XLSX from 'xlsx'
// import { saveAs } from 'file-saver'

// // المكونات الأساسية
// import MuiBox from '@/components/ui/MuiBox'
// import MuiTypography from '@/components/ui/MuiTypography'
// import MuiButton from '@/components/ui/MuiButton'
// import MuiTextField from '@/components/ui/MuiTextField'
// import MuiPaper from '@/components/ui/MuiPaper'
// import MuiCard from '@/components/ui/MuiCard'
// import MuiCardContent from '@/components/ui/MuiCardContent'
// import MuiCardActions from '@/components/ui/MuiCardActions'
// import MuiDialog from '@/components/ui/MuiDialog'
// import MuiDialogTitle from '@/components/ui/MuiDialogTitle'
// import MuiDialogContent from '@/components/ui/MuiDialogContent'
// import MuiDialogActions from '@/components/ui/MuiDialogActions'
// import MuiDivider from '@/components/ui/MuiDivider'
// import MuiGrid from '@/components/ui/MuiGrid'
// import MuiChip from '@/components/ui/MuiChip'
// import MuiAlert from '@/components/ui/MuiAlert'
// import MuiCircularProgress from '@/components/ui/MuiCircularProgress'
// import MuiSelect from '@/components/ui/MuiSelect'
// import MuiSwitch from '@/components/ui/MuiSwitch'
// import MuiAutocomplete from '@/components/ui/MuiAutocomplete'
// import MuiAvatar from '@/components/ui/MuiAvatar'
// import MuiIconButton from '@/components/ui/MuiIconButton'

// // Layout & Common Components
// import DashboardLayout from '@/components/layout/DashboardLayout'
// import { 
//   LoadingScreen, 
//   EmptyState, 
//   ConfirmDialog, 
//   SEOHead, 
//   CardsView, 
//   TablePagination, 
//   DataTable 
// } from '@/components/common'

// // Hooks & Utilities
// import { useNotification, useDebounce } from '@/hooks'
// import { QUERY_KEYS } from '@/config/constants'
// import { getHallsList, createHall, updateHall, deleteHall } from '@/api/admin'
// import { formatCurrency, formatPhoneNumber, generateExportFileName } from '@/utils/helpers'

// // الأيقونات
// import {
//   Building2,
//   Search,
//   Plus,
//   Pencil,
//   Trash2,
//   AlertCircle,
//   Eye,
//   Download,
//   Filter,
//   RefreshCw,
//   CheckCircle,
//   XCircle,
//   User,
//   Phone,
//   Users,
//   DollarSign,
//   MapPin,
//   Table,
//   Armchair as Chair,
//   Check,
//   X,
//   FileText,
//   Image as ImageIcon,
//   Wifi,
//   Car,
//   Coffee,
//   Music,
//   Star,
//   Upload,
//   Settings,
//   Shield,
//   Calendar,
//   Clock,
//   Edit,
//   MoreVertical
// } from 'lucide-react'

// // ====================== Validation Schema ======================

// const createHallSchema = (editingHall = null) => z.object({
//   name: z.string()
//     .min(3, 'اسم القاعة يجب أن يكون 3 أحرف على الأقل')
//     .max(100, 'اسم القاعة طويل جداً'),
  
//   location: z.string()
//     .min(3, 'الموقع مطلوب')
//     .max(200, 'الموقع طويل جداً'),
  
//   address: z.string()
//     .min(5, 'العنوان التفصيلي مطلوب')
//     .max(300, 'العنوان طويل جداً'),
  
//   capacity: z.coerce.number()
//     .min(1, 'السعة مطلوبة')
//     .max(10000, 'السعة كبيرة جداً'),
  
//   tables: z.coerce.number()
//     .min(1, 'عدد الطاولات مطلوب')
//     .max(1000, 'عدد الطاولات كبير جداً'),
  
//   chairs: z.coerce.number()
//     .min(1, 'عدد الكراسي مطلوب')
//     .max(10000, 'عدد الكراسي كبير جداً'),
  
//   maxEmployees: z.coerce.number()
//     .min(1, 'الحد الأقصى للموظفين مطلوب')
//     .max(1000, 'الحد الأقصى للموظفين كبير جداً'),
  
//   defaultPrices: z.coerce.number()
//     .min(0, 'السعر مطلوب')
//     .max(1000000, 'السعر كبير جداً'),
  
//   managerName: z.string()
//     .min(3, 'اسم المدير مطلوب')
//     .max(100, 'اسم المدير طويل جداً'),
  
//   managerUsername: z.string()
//     .min(3, 'اسم المستخدم مطلوب')
//     .max(50, 'اسم المستخدم طويل جداً')
//     .regex(/^[a-zA-Z0-9_]+$/, 'اسم المستخدم يجب أن يحتوي على أحرف إنجليزية وأرقام و _ فقط'),
  
//   managerPhone: z.string()
//     .regex(/^\d+$/, 'رقم الهاتف يجب أن يكون أرقام فقط')
//     .min(6, 'رقم الهاتف يجب أن يكون 6 أرقام على الأقل')
//     .max(15, 'رقم الهاتف طويل جداً'),
  
//   managerPassword: editingHall 
//     ? z.string()
//         .min(6, 'كلمة المرور يجب أن تكون 6 أحرف على الأقل')
//         .max(50, 'كلمة المرور طويلة جداً')
//         .optional()
//         .or(z.literal(''))
//     : z.string()
//         .min(6, 'كلمة المرور مطلوبة')
//         .max(50, 'كلمة المرور طويلة جداً'),
  
//   description: z.string()
//     .max(1000, 'الوصف طويل جداً')
//     .optional()
//     .or(z.literal('')),
  
//   amenities: z.array(z.string())
//     .optional()
//     .default([]),
  
//   services: z.array(z.object({
//     service: z.string(),
//     customPrice: z.number().optional(),
//     isIncluded: z.boolean().optional().default(false),
//     notes: z.string().optional()
//   }))
//     .optional()
//     .default([]),
  
//   images: z.array(z.string())
//     .optional()
//     .default([]),
  
//   primaryImage: z.string()
//     .optional()
//     .nullable(),
  
//   isActive: z.boolean()
//     .optional()
//     .default(true)
// })

// // ====================== Main Component ======================

// export default function HallsManagement() {
//   const queryClient = useQueryClient()
//   const { success, error: showError } = useNotification()
//   const theme = useTheme()
//   const isLargeScreen = useMediaQuery(theme.breakpoints.up('md'))

//   // ====================== State Management ======================
//   const [search, setSearch] = useState('')
//   const debouncedSearch = useDebounce(search, 500)

//   const [filters, setFilters] = useState({
//     minCapacity: '',
//     maxCapacity: '',
//     minPrice: '',
//     maxPrice: '',
//     isActive: 'all'
//   })

//   const [dialogOpen, setDialogOpen] = useState(false)
//   const [viewDialogOpen, setViewDialogOpen] = useState(false)
//   const [exportDialogOpen, setExportDialogOpen] = useState(false)
//   const [filterDialogOpen, setFilterDialogOpen] = useState(false)

//   const [editingHall, setEditingHall] = useState(null)
//   const [viewingHall, setViewingHall] = useState(null)

//   const [confirmDialog, setConfirmDialog] = useState({
//     open: false,
//     hall: null,
//     title: '',
//     message: '',
//     action: 'delete'
//   })

//   const [exportOptions, setExportOptions] = useState({
//     format: 'excel',
//     includeInactive: false,
//     columns: ['name', 'location', 'address', 'capacity', 'tables', 'chairs', 'defaultPrices', 'manager', 'services', 'status']
//   })

//   const [sortConfig, setSortConfig] = useState({
//     field: 'name',
//     direction: 'asc'
//   })

//   // Pagination State
//   const [pagination, setPagination] = useState({
//     page: 1,
//     limit: 10,
//     total: 0,
//     totalPages: 0
//   })

//   // Dynamic schema based on editing state
//   const hallSchema = useMemo(() => 
//     createHallSchema(editingHall),
//     [editingHall]
//   )

//   // ====================== Form Setup ======================
//   const { control, handleSubmit, reset, watch, setValue, formState: { errors } } = useForm({
//     resolver: zodResolver(hallSchema),
//     defaultValues: {
//       name: '',
//       location: '',
//       address: '',
//       capacity: '',
//       tables: '',
//       chairs: '',
//       maxEmployees: '',
//       defaultPrices: '',
//       managerName: '',
//       managerUsername: '',
//       managerPhone: '',
//       managerPassword: '',
//       description: '',
//       amenities: [],
//       services: [],
//       images: [],
//       primaryImage: null,
//       isActive: true
//     }
//   })

//   // Watch form values
//   const watchedServices = watch('services')
//   const watchedImages = watch('images')
//   const watchedAmenities = watch('amenities')
//   const watchedPrimaryImage = watch('primaryImage')

//   // ====================== Data Fetching ======================
//   const { data: hallsResponse, isLoading, error, isFetching, refetch } = useQuery({
//     queryKey: [QUERY_KEYS.ADMIN_HALLS, {
//       search: debouncedSearch,
//       page: pagination.page,
//       limit: pagination.limit,
//       sortBy: sortConfig.field,
//       sortOrder: sortConfig.direction,
//       ...filters
//     }],
//     queryFn: () => getHallsList({
//       search: debouncedSearch,
//       page: pagination.page,
//       limit: pagination.limit,
//       sortBy: sortConfig.field,
//       sortOrder: sortConfig.direction,
//       ...Object.fromEntries(
//         Object.entries(filters).filter(([key, value]) => value !== '' && value !== 'all')
//       )
//     }),
//     keepPreviousData: true,
//     staleTime: 30000,
//     cacheTime: 60000
//   })

//   // Update pagination from response
//   useEffect(() => {
//     if (hallsResponse?.pagination) {
//       setPagination(prev => ({
//         ...prev,
//         total: hallsResponse.pagination.totalItems || 0,
//         totalPages: hallsResponse.pagination.totalPages || 1
//       }))
//     }
//   }, [hallsResponse])

//   // ====================== Data Processing ======================
//   const normalizedHalls = useMemo(() => {
//     if (!hallsResponse?.data || !Array.isArray(hallsResponse.data)) {
//       return []
//     }

//     return hallsResponse.data.map(hall => ({
//       id: hall.id || hall._id,
//       name: hall.name || 'غير محدد',
//       location: hall.location || 'غير محدد',
//       address: hall.address || '',
//       capacity: hall.capacity || 0,
//       tables: hall.tables || 0,
//       chairs: hall.chairs || 0,
//       maxEmployees: hall.maxEmployees || 0,
//       defaultPrices: hall.defaultPrices || 0,
//       manager: {
//         name: hall.generalManager?.name || 'غير معين',
//         phone: hall.generalManager?.phone || '',
//         id: hall.generalManager?._id
//       },
//       description: hall.description || '',
//       amenities: Array.isArray(hall.amenities) ? hall.amenities : [],
//       services: Array.isArray(hall.services) ? hall.services : [],
//       images: Array.isArray(hall.images) ? hall.images : [],
//       isActive: hall.isActive !== false,
//       createdAt: hall.createdAt ? new Date(hall.createdAt) : new Date(),
//       updatedAt: hall.updatedAt ? new Date(hall.updatedAt) : new Date(),
//       primaryImage: hall.primaryImage
//     }))
//   }, [hallsResponse])

//   const displayedHalls = useMemo(() => normalizedHalls, [normalizedHalls])

//   // ====================== Table Columns ======================
//   const tableColumns = useMemo(() => [
//     {
//       id: 'name',
//       label: 'اسم القاعة',
//       align: 'right',
//       format: (value, row) => (
//         <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
//           <Building2 size={18} style={{ color: 'var(--color-secondary-500)' }} />
//           <MuiTypography variant="body2" sx={{ fontWeight: 600 }}>
//             {value}
//           </MuiTypography>
//         </MuiBox>
//       )
//     },
//     {
//       id: 'location',
//       label: 'الموقع',
//       align: 'right',
//       format: (value) => (
//         <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
//           <MapPin size={14} style={{ color: 'var(--color-text-secondary)' }} />
//           <MuiTypography variant="body2">{value}</MuiTypography>
//         </MuiBox>
//       )
//     },
//     {
//       id: 'capacity',
//       label: 'السعة',
//       align: 'center',
//       format: (value) => (
//         <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5, justifyContent: 'center' }}>
//           <Users size={16} style={{ color: 'var(--color-info-500)' }} />
//           <MuiTypography variant="body2" sx={{ fontWeight: 600 }}>
//             {new Intl.NumberFormat('en-US').format(value)}
//           </MuiTypography>
//         </MuiBox>
//       )
//     },
//     {
//       id: 'defaultPrices',
//       label: 'السعر الافتراضي',
//       align: 'center',
//       format: (value) => (
//         <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5, justifyContent: 'center' }}>
//           <MuiTypography variant="body2" sx={{ fontWeight: 600, color: 'var(--color-success-500)' }}>
//             {formatCurrency(value)}
//           </MuiTypography>
//         </MuiBox>
//       )
//     },
//     {
//       id: 'manager',
//       label: 'المدير',
//       align: 'right',
//       format: (value, row) => (
//         <MuiBox>
//           <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 0.5 }}>
//             <User size={14} style={{ color: 'var(--color-text-secondary)' }} />
//             <MuiTypography variant="body2" sx={{ fontSize: '0.875rem' }}>
//               {row.manager?.name || 'غير معين'}
//             </MuiTypography>
//           </MuiBox>
//           {row.manager?.phone && (
//             <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
//               <Phone size={12} style={{ color: 'var(--color-text-secondary)' }} />
//               <MuiTypography variant="caption" sx={{ fontSize: '0.75rem', color: 'var(--color-text-secondary)' }}>
//                 {formatPhoneNumber(row.manager.phone)}
//               </MuiTypography>
//             </MuiBox>
//           )}
//         </MuiBox>
//       )
//     },
//     {
//       id: 'isActive',
//       label: 'الحالة',
//       align: 'center',
//       format: (value) => (
//         <MuiChip
//           label={value ? 'نشطة' : 'غير نشطة'}
//           color={value ? 'success' : 'warning'}
//           size="small"
//           icon={value ? <CheckCircle size={14} /> : <XCircle size={14} />}
//           sx={{ fontWeight: 600 }}
//         />
//       )
//     }
//   ], [])

//   // ====================== Mutations ======================
//   const addMutation = useMutation({
//     mutationFn: createHall,
//     onSuccess: (data) => {
//       success('تم إضافة القاعة بنجاح')
//       queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
//       handleCloseDialog()
//     },
//     onError: (err) => {
//       const errorMessage = err.isAuthError
//         ? 'جلسة العمل منتهية. يرجى تسجيل الدخول مرة أخرى'
//         : err.response?.data?.message || err.message || 'فشل إضافة القاعة'
//       showError(errorMessage)
//     }
//   })

//   const editMutation = useMutation({
//     mutationFn: ({ id, data }) => updateHall(id, data),
//     onSuccess: () => {
//       success('تم تعديل القاعة بنجاح')
//       queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
//       handleCloseDialog()
//     },
//     onError: (err) => {
//       const errorMessage = err.isAuthError
//         ? 'جلسة العمل منتهية. يرجى تسجيل الدخول مرة أخرى'
//         : err.response?.data?.message || err.message || 'فشل تعديل القاعة'
//       showError(errorMessage)
//     }
//   })

//   const deleteMutation = useMutation({
//     mutationFn: deleteHall,
//     onSuccess: () => {
//       success('تم حذف القاعة بنجاح')
//       queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
//       handleCloseConfirm()
//     },
//     onError: (err) => {
//       const errorMessage = err.isAuthError
//         ? 'جلسة العمل منتهية. يرجى تسجيل الدخول مرة أخرى'
//         : err.response?.data?.message || err.message || 'فشل حذف القاعة'
//       showError(errorMessage)
//     }
//   })

//   const toggleStatusMutation = useMutation({
//     mutationFn: ({ id, isActive }) => updateHall(id, { isActive }),
//     onSuccess: (_, variables) => {
//       success(`تم ${variables.isActive ? 'تفعيل' : 'تعطيل'} القاعة بنجاح`)
//       queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.ADMIN_HALLS] })
//     },
//     onError: (err) => {
//       showError(err.response?.data?.message || err.message || 'فشل تغيير حالة القاعة')
//     }
//   })

//   // ====================== Event Handlers ======================
//   const handleOpenDialog = (hall = null) => {
//     setEditingHall(hall)
//     if (hall) {
//       reset({
//         name: hall.name,
//         location: hall.location,
//         address: hall.address || '',
//         capacity: hall.capacity,
//         tables: hall.tables,
//         chairs: hall.chairs,
//         maxEmployees: hall.maxEmployees,
//         defaultPrices: hall.defaultPrices,
//         managerName: hall.manager?.name || '',
//         managerUsername: hall.manager?.username || '',
//         managerPhone: hall.manager?.phone || '',
//         managerPassword: '',
//         description: hall.description || '',
//         amenities: hall.amenities || [],
//         services: hall.services || [],
//         images: hall.images || [],
//         primaryImage: hall.primaryImage,
//         isActive: hall.isActive
//       })
//     } else {
//       reset({
//         name: '',
//         location: '',
//         address: '',
//         capacity: '',
//         tables: '',
//         chairs: '',
//         maxEmployees: '',
//         defaultPrices: '',
//         managerName: '',
//         managerUsername: '',
//         managerPhone: '',
//         managerPassword: '',
//         description: '',
//         amenities: [],
//         services: [],
//         images: [],
//         primaryImage: null,
//         isActive: true
//       })
//     }
//     setDialogOpen(true)
//   }

//   const handleCloseDialog = () => {
//     setDialogOpen(false)
//     setEditingHall(null)
//     reset()
//   }

//   const handleOpenViewDialog = (hall) => {
//     setViewingHall(hall)
//     setViewDialogOpen(true)
//   }

//   const handleCloseViewDialog = () => {
//     setViewDialogOpen(false)
//     setViewingHall(null)
//   }

//   const handleOpenFilterDialog = () => {
//     setFilterDialogOpen(true)
//   }

//   const handleCloseFilterDialog = () => {
//     setFilterDialogOpen(false)
//   }

//   const handleApplyFilters = () => {
//     setPagination(prev => ({ ...prev, page: 1 }))
//     handleCloseFilterDialog()
//   }

//   const handleResetFilters = () => {
//     setFilters({
//       minCapacity: '',
//       maxCapacity: '',
//       minPrice: '',
//       maxPrice: '',
//       isActive: 'all'
//     })
//     setPagination(prev => ({ ...prev, page: 1 }))
//     handleCloseFilterDialog()
//   }

//   const handleOpenConfirm = (hall, action = 'delete') => {
//     let title = ''
//     let message = ''
    
//     switch (action) {
//       case 'delete':
//         title = 'حذف القاعة'
//         message = `هل أنت متأكد من حذف القاعة "${hall.name}"؟ سيتم حذف جميع البيانات المرتبطة بها ولا يمكن التراجع عن هذا الإجراء.`
//         break
//       case 'deactivate':
//         title = 'تعطيل القاعة'
//         message = `هل أنت متأكد من تعطيل القاعة "${hall.name}"؟ لن تكون متاحة للحجوزات الجديدة.`
//         break
//       case 'activate':
//         title = 'تفعيل القاعة'
//         message = `هل أنت متأكد من تفعيل القاعة "${hall.name}"؟`
//         break
//     }

//     setConfirmDialog({
//       open: true,
//       hall,
//       title,
//       message,
//       action
//     })
//   }

//   const handleCloseConfirm = () => {
//     setConfirmDialog({
//       open: false,
//       hall: null,
//       title: '',
//       message: '',
//       action: 'delete'
//     })
//   }

//   const handleConfirmAction = async () => {
//     const { hall, action } = confirmDialog
//     try {
//       switch (action) {
//         case 'delete':
//           await deleteMutation.mutateAsync(hall.id)
//           break
//         case 'deactivate':
//           await toggleStatusMutation.mutateAsync({ id: hall.id, isActive: false })
//           break
//         case 'activate':
//           await toggleStatusMutation.mutateAsync({ id: hall.id, isActive: true })
//           break
//       }
//     } catch (error) {
//       // Error handled in mutation
//     }
//   }

//   const handleOpenExportDialog = () => {
//     setExportDialogOpen(true)
//   }

//   const handleCloseExportDialog = () => {
//     setExportDialogOpen(false)
//   }

//   // ====================== Form Submission ======================
//   const onSubmit = async (data) => {
//     try {
//       const payload = {
//         name: data.name,
//         location: data.location,
//         address: data.address,
//         capacity: Number(data.capacity),
//         tables: Number(data.tables),
//         chairs: Number(data.chairs),
//         maxEmployees: Number(data.maxEmployees),
//         defaultPrices: Number(data.defaultPrices),
//         description: data.description || '',
//         amenities: data.amenities || [],
//         services: data.services || [],
//         images: data.images || [],
//         primaryImage: data.primaryImage,
//         isActive: data.isActive,
//         generalManager: {
//           name: data.managerName,
//           username: data.managerUsername,
//           phone: data.managerPhone,
//           ...(data.managerPassword && { password: data.managerPassword })
//         }
//       }

//       if (editingHall) {
//         // عند التعديل، لا نرسل كلمة المرور إذا كانت فارغة
//         if (!data.managerPassword) {
//           delete payload.generalManager.password
//         }
//         await editMutation.mutateAsync({ id: editingHall.id, data: payload })
//       } else {
//         // عند الإضافة، كلمة المرور مطلوبة
//         await addMutation.mutateAsync(payload)
//       }
//     } catch (error) {
//       // Error handled in mutation
//     }
//   }

//   // ====================== Export Functions ======================
//   const handleExportData = () => {
//     try {
//       const exportData = normalizedHalls.map(hall => ({
//         'اسم القاعة': hall.name,
//         'الموقع': hall.location,
//         'العنوان': hall.address,
//         'السعة': hall.capacity,
//         'عدد الطاولات': hall.tables,
//         'عدد الكراسي': hall.chairs,
//         'الحد الأقصى للموظفين': hall.maxEmployees,
//         'السعر (للشخص)': formatCurrency(hall.defaultPrices),
//         'اسم المدير': hall.manager.name,
//         'هاتف المدير': formatPhoneNumber(hall.manager.phone),
//         'عدد الخدمات': hall.services.length,
//         'عدد المرافق': hall.amenities.length,
//         'الحالة': hall.isActive ? 'نشطة' : 'غير نشطة',
//         'تاريخ الإنشاء': hall.createdAt.toLocaleDateString('ar-SA'),
//         'تاريخ التحديث': hall.updatedAt.toLocaleDateString('ar-SA'),
//         'الوصف': hall.description
//       }))

//       // إنشاء ورقة عمل Excel
//       const worksheet = XLSX.utils.json_to_sheet(exportData)
//       const workbook = XLSX.utils.book_new()
//       XLSX.utils.book_append_sheet(workbook, worksheet, 'القاعات')

//       // تنسيق الأعمدة
//       const wscols = [
//         { wch: 25 }, // اسم القاعة
//         { wch: 30 }, // الموقع
//         { wch: 40 }, // العنوان
//         { wch: 10 }, // السعة
//         { wch: 15 }, // الطاولات
//         { wch: 15 }, // الكراسي
//         { wch: 20 }, // الحد الأقصى للموظفين
//         { wch: 15 }, // السعر
//         { wch: 20 }, // اسم المدير
//         { wch: 15 }, // هاتف المدير
//         { wch: 15 }, // عدد الخدمات
//         { wch: 15 }, // عدد المرافق
//         { wch: 10 }, // الحالة
//         { wch: 15 }, // تاريخ الإنشاء
//         { wch: 15 }, // تاريخ التحديث
//         { wch: 40 }  // الوصف
//       ]
//       worksheet['!cols'] = wscols

//       // حفظ الملف
//       const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' })
//       const blob = new Blob([excelBuffer], {
//         type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
//       })
//       const fileName = generateExportFileName('halls')
//       saveAs(blob, fileName)
//       success('تم تصدير البيانات بنجاح')
//       handleCloseExportDialog()
//     } catch (error) {
//       showError('فشل تصدير البيانات: ' + error.message)
//     }
//   }

//   // ====================== Pagination Handlers ======================
//   const handlePageChange = (event, newPage) => {
//     setPagination(prev => ({ ...prev, page: newPage }))
//   }

//   const handleRowsPerPageChange = (newLimit) => {
//     setPagination(prev => ({
//       ...prev,
//       limit: newLimit,
//       page: 1
//     }))
//   }

//   const handleSort = (field) => {
//     setSortConfig(prev => ({
//       field,
//       direction: prev.field === field && prev.direction === 'asc' ? 'desc' : 'asc'
//     }))
//   }

//   const handleRefresh = () => {
//     refetch()
//     success('تم تحديث البيانات')
//   }

//   // ====================== UI Helpers ======================
//   const getSortIcon = (field) => {
//     if (sortConfig.field !== field) return null
//     return sortConfig.direction === 'asc' ? '↑' : '↓'
//   }

//   const isSubmitting = addMutation.isPending || editMutation.isPending

//   // قائمة المرافق المتاحة
//   const availableAmenities = [
//     'تكييف مركزي',
//     'موسيقى حية',
//     'إضاءة LED',
//     'مطبخ مجهز',
//     'مواقف سيارات',
//     'واي فاي مجاني',
//     'شاشة عرض',
//     'نظام صوتي',
//     'تدفئة مركزية',
//     'خدمة تنظيف'
//   ]

//   // ====================== Render ======================
//   return (
//     <>
//       <SEOHead 
//         pageKey="hallsManagement"
//         title="إدارة القاعات | INVOCCA"
//         description="إدارة قاعات المناسبات والحفلات، إضافة وتعديل وحذف القاعات"
//       />

//       {/* Main Header */}
//       <MuiBox sx={{ mb: { xs: 2, sm: 3, md: 4 } }}>
//         <MuiBox sx={{
//           display: 'flex',
//           alignItems: { xs: 'flex-start', sm: 'center' },
//           justifyContent: 'space-between',
//           flexDirection: { xs: 'column', sm: 'row' },
//           flexWrap: 'wrap',
//           gap: { xs: 2, sm: 2, md: 3 },
//           mb: { xs: 2, sm: 2.5, md: 3 }
//         }}>
//           <MuiBox>
//             <MuiTypography
//               variant="h4"
//               sx={{
//                 fontWeight: 800,
//                 background: 'linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%)',
//                 WebkitBackgroundClip: 'text',
//                 WebkitTextFillColor: 'transparent',
//                 backgroundClip: 'text',
//                 mb: 1,
//                 fontSize: { xs: '1.75rem', md: '2rem' }
//               }}
//             >
//               إدارة القاعات
//             </MuiTypography>
//             <MuiTypography
//               variant="body2"
//               sx={{ color: 'var(--color-text-secondary)' }}
//             >
//               {hallsResponse?.pagination
//                 ? `إجمالي ${hallsResponse.pagination.totalItems || 0} قاعة • ${displayedHalls.filter(h => h.isActive).length} نشطة`
//                 : 'جاري تحميل البيانات...'}
//             </MuiTypography>
//           </MuiBox>

//           {/* Search and Actions */}
//           <MuiBox sx={{
//             display: 'flex',
//             alignItems: 'center',
//             gap: { xs: 1, sm: 1.5, md: 2 },
//             flexWrap: 'wrap',
//             width: { xs: '100%', sm: 'auto' },
//             justifyContent: { xs: 'flex-start', md: 'flex-end' }
//           }}>
//             <MuiTextField
//               placeholder="ابحث عن قاعة..."
//               value={search}
//               onChange={(e) => setSearch(e.target.value)}
//               size="small"
//               sx={{
//                 width: { xs: '100%', sm: 250 },
//                 '& .MuiOutlinedInput-root': {
//                   borderRadius: '12px',
//                   backgroundColor: 'rgba(255, 255, 255, 0.9)',
//                   '&:hover': {
//                     backgroundColor: 'rgba(255, 255, 255, 1)',
//                   }
//                 }
//               }}
//               startIcon={<Search size={18} style={{ color: 'var(--color-text-secondary)' }} />}
//             />

//             <MuiButton
//               variant="outlined"
//               onClick={handleOpenFilterDialog}
//               startIcon={<Filter size={16} />}
//               sx={{
//                 borderRadius: '12px',
//                 borderColor: 'var(--color-border)',
//                 fontSize: { xs: '0.75rem', sm: '0.875rem' },
//                 padding: { xs: '6px 12px', sm: '8px 16px' },
//                 minWidth: { xs: 'auto', sm: '80px' },
//                 '&:hover': {
//                   borderColor: 'var(--color-primary-500)',
//                   backgroundColor: 'var(--color-primary-50)'
//                 }
//               }}
//               size="small"
//             >
//               تصفية
//             </MuiButton>

//             <MuiButton
//               variant="outlined"
//               onClick={handleRefresh}
//               startIcon={<RefreshCw size={16} />}
//               disabled={isFetching}
//               sx={{
//                 borderRadius: '12px',
//                 borderColor: 'var(--color-border)',
//                 fontSize: { xs: '0.75rem', sm: '0.875rem' },
//                 padding: { xs: '6px 12px', sm: '8px 16px' },
//                 minWidth: { xs: 'auto', sm: '80px' },
//                 '&:hover': {
//                   borderColor: 'var(--color-primary-500)',
//                   backgroundColor: 'var(--color-primary-50)'
//                 }
//               }}
//               size="small"
//             >
//               {isFetching ? 'جاري...' : 'تحديث'}
//             </MuiButton>

//             <MuiButton
//               variant="outlined"
//               onClick={handleOpenExportDialog}
//               startIcon={<Download size={16} />}
//               sx={{
//                 borderRadius: '12px',
//                 borderColor: 'var(--color-border)',
//                 fontSize: { xs: '0.75rem', sm: '0.875rem' },
//                 padding: { xs: '6px 12px', sm: '8px 16px' },
//                 minWidth: { xs: 'auto', sm: '80px' },
//                 '&:hover': {
//                   borderColor: 'var(--color-primary-500)',
//                   backgroundColor: 'var(--color-primary-50)'
//                 }
//               }}
//               size="small"
//             >
//               تصدير
//             </MuiButton>

//             <MuiButton
//               variant="contained"
//               onClick={() => handleOpenDialog()}
//               startIcon={<Plus size={16} />}
//               sx={{
//                 borderRadius: '12px',
//                 background: 'linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-700) 100%)',
//                 boxShadow: '0 4px 12px rgba(26, 26, 26, 0.2)',
//                 fontSize: { xs: '0.75rem', sm: '0.875rem' },
//                 padding: { xs: '6px 12px', sm: '8px 16px' },
//                 minWidth: { xs: 'auto', sm: '100px' },
//                 '&:hover': {
//                   boxShadow: '0 6px 20px rgba(26, 26, 26, 0.3)',
//                   transform: 'translateY(-1px)'
//                 }
//               }}
//               size="small"
//             >
//               إضافة قاعة
//             </MuiButton>
//           </MuiBox>
//         </MuiBox>
//       </MuiBox>

//       {/* Loading State */}
//       {isLoading ? (
//         <LoadingScreen 
//           message="جاري تحميل بيانات القاعات..."
//           fullScreen={false}
//           progress
//         />
//       ) : error ? (
//         <EmptyState
//           title="حدث خطأ"
//           description={error.message || 'فشل تحميل قائمة القاعات'}
//           icon={AlertCircle}
//           showPaper
//           action={
//             <MuiButton
//               variant="contained"
//               onClick={() => refetch()}
//               startIcon={<RefreshCw size={20} />}
//             >
//               إعادة المحاولة
//             </MuiButton>
//           }
//         />
//       ) : displayedHalls.length === 0 ? (
//         <EmptyState
//           title="لا توجد قاعات"
//           description={
//             debouncedSearch || Object.values(filters).some(v => v !== '' && v !== 'all')
//               ? 'لا توجد نتائج مطابقة لبحثك أو تصفيتك'
//               : "لم يتم إضافة أي قاعات بعد. ابدأ بإضافة قاعة جديدة"
//           }
//           icon={Building2}
//           showPaper
//           action={
//             <MuiButton variant="contained" onClick={() => handleOpenDialog()}>
//               إضافة قاعة جديدة
//             </MuiButton>
//           }
//         />
//       ) : (
//         <>
//           {/* Stats Bar */}
//           <MuiBox sx={{
//             mb: 3,
//             display: 'flex',
//             gap: 1,
//             flexWrap: 'wrap',
//             justifyContent: { xs: 'center', sm: 'flex-start' }
//           }}>
//             <MuiChip
//               label={`إجمالي: ${hallsResponse?.pagination?.totalItems || 0}`}
//               color="primary"
//               variant="outlined"
//               icon={<Building2 size={16} />}
//               size="small"
//             />
//             <MuiChip
//               label={`نشطة: ${displayedHalls.filter(h => h.isActive).length}`}
//               color="success"
//               variant="outlined"
//               icon={<CheckCircle size={16} />}
//               size="small"
//             />
//             <MuiChip
//               label={`متوسط السعة: ${Math.round(displayedHalls.reduce((acc, h) => acc + h.capacity, 0) / displayedHalls.length)}`}
//               color="info"
//               variant="outlined"
//               icon={<Users size={16} />}
//               size="small"
//             />
//           </MuiBox>

//           {/* Fetching Indicator */}
//           {isFetching && (
//             <MuiAlert 
//               severity="info"
//               sx={{ mb: 2 }}
//               icon={<MuiCircularProgress size={20} />}
//             >
//               جاري تحديث البيانات...
//             </MuiAlert>
//           )}

//           {/* Responsive View: Table for large screens, Cards for small screens */}
//           {isLargeScreen ? (
//             <DataTable
//               columns={tableColumns}
//               rows={displayedHalls}
//               onView={handleOpenViewDialog}
//               onEdit={handleOpenDialog}
//               onDelete={(hall) => handleOpenConfirm(hall, 'delete')}
//               onToggleStatus={(hall) => toggleStatusMutation.mutate({ id: hall.id, isActive: !hall.isActive })}
//               pagination={{
//                 page: pagination.page - 1,
//                 limit: pagination.limit,
//                 total: hallsResponse?.pagination?.totalItems || 0
//               }}
//               onPageChange={(newPage) => setPagination(prev => ({ ...prev, page: newPage + 1 }))}
//               onRowsPerPageChange={(newLimit) => setPagination(prev => ({
//                 ...prev,
//                 limit: newLimit,
//                 page: 1
//               }))}
//               emptyMessage="لا توجد قاعات"
//             />
//           ) : (
//             <>
//               <CardsView
//                 data={displayedHalls}
//                 columns={{ xs: 1, sm: 2 }}
//                 renderCard={(hall) => (
//                   <MuiCard
//                     sx={{
//                       height: '100%',
//                       width: '100%',
//                       maxWidth: '100%',
//                       display: 'flex',
//                       flexDirection: 'column',
//                       opacity: hall.isActive ? 1 : 0.7,
//                       transition: 'all 0.3s ease',
//                       borderRadius: '16px',
//                       overflow: 'hidden',
//                       boxShadow: '0 4px 12px rgba(0, 0, 0, 0.08)',
//                       '&:hover': {
//                         boxShadow: '0 8px 24px rgba(0, 0, 0, 0.12)',
//                         transform: 'translateY(-4px)'
//                       }
//                     }}
//                   >
//                     {/* Header with Status */}
//                     <MuiBox sx={{
//                       p: 2,
//                       backgroundColor: hall.isActive ? 'var(--color-success-50)' : 'var(--color-warning-50)',
//                       display: 'flex',
//                       justifyContent: 'space-between',
//                       alignItems: 'center',
//                       borderBottom: '1px solid',
//                       borderColor: 'divider'
//                     }}>
//                       <MuiTypography variant="h6" sx={{ fontWeight: 700, color: 'var(--color-primary-700)' }}>
//                         {hall.name}
//                       </MuiTypography>
//                       <MuiChip
//                         label={hall.isActive ? 'نشطة' : 'غير نشطة'}
//                         color={hall.isActive ? 'success' : 'warning'}
//                         size="small"
//                         sx={{ fontWeight: 600 }}
//                       />
//                     </MuiBox>

//                     {/* Content */}
//                     <MuiCardContent sx={{ p: 2.5, flex: 1 }}>
//                       {/* Location */}
//                       <MuiBox sx={{ display: 'flex', alignItems: 'flex-start', gap: 1, mb: 2 }}>
//                         <MapPin size={16} style={{ color: 'var(--color-text-secondary)', flexShrink: 0, marginTop: '2px' }} />
//                         <MuiTypography variant="body2" sx={{ color: 'var(--color-text-secondary)' }}>
//                           {hall.location}
//                         </MuiTypography>
//                       </MuiBox>

//                       {/* Stats Grid */}
//                       <MuiGrid container spacing={1.5} sx={{ mb: 2 }}>
//                         <MuiGrid item xs={6}>
//                           <MuiBox sx={{
//                             p: 1.25,
//                             borderRadius: '10px',
//                             backgroundColor: 'rgba(59, 130, 246, 0.1)',
//                             display: 'flex',
//                             alignItems: 'center',
//                             gap: 0.75
//                           }}>
//                             <Users size={16} style={{ color: 'var(--color-info-500)' }} />
//                             <MuiBox>
//                               <MuiTypography variant="caption" sx={{ display: 'block', color: 'var(--color-text-secondary)' }}>
//                                 السعة
//                               </MuiTypography>
//                               <MuiTypography variant="body2" sx={{ fontWeight: 700, color: 'var(--color-info-500)' }}>
//                                 {new Intl.NumberFormat('en-US').format(hall.capacity)}
//                               </MuiTypography>
//                             </MuiBox>
//                           </MuiBox>
//                         </MuiGrid>

//                         <MuiGrid item xs={6}>
//                           <MuiBox sx={{
//                             p: 1.25,
//                             borderRadius: '10px',
//                             backgroundColor: 'rgba(34, 197, 94, 0.1)',
//                             display: 'flex',
//                             alignItems: 'center',
//                             gap: 0.75
//                           }}>
//                             <MuiBox>
//                               <MuiTypography variant="caption" sx={{ display: 'block', color: 'var(--color-text-secondary)' }}>
//                                 السعر
//                               </MuiTypography>
//                               <MuiTypography variant="body2" sx={{ fontWeight: 700, color: 'var(--color-success-500)' }}>
//                                 {formatCurrency(hall.defaultPrices)}
//                               </MuiTypography>
//                             </MuiBox>
//                           </MuiBox>
//                         </MuiGrid>

//                         <MuiGrid item xs={6}>
//                           <MuiBox sx={{
//                             p: 1,
//                             borderRadius: '8px',
//                             backgroundColor: 'rgba(216, 185, 138, 0.1)',
//                             display: 'flex',
//                             alignItems: 'center',
//                             gap: 0.5
//                           }}>
//                             <Table size={14} style={{ color: 'var(--color-secondary-700)' }} />
//                             <MuiTypography variant="body2" sx={{ fontSize: '0.8rem' }}>
//                               {hall.tables} طاولة
//                             </MuiTypography>
//                           </MuiBox>
//                         </MuiGrid>

//                         <MuiGrid item xs={6}>
//                           <MuiBox sx={{
//                             p: 1,
//                             borderRadius: '8px',
//                             backgroundColor: 'rgba(216, 185, 138, 0.1)',
//                             display: 'flex',
//                             alignItems: 'center',
//                             gap: 0.5
//                           }}>
//                             <Chair size={14} style={{ color: 'var(--color-secondary-700)' }} />
//                             <MuiTypography variant="body2" sx={{ fontSize: '0.8rem' }}>
//                               {hall.chairs} كرسي
//                             </MuiTypography>
//                           </MuiBox>
//                         </MuiGrid>
//                       </MuiGrid>

//                       {/* Manager Info */}
//                       <MuiBox sx={{
//                         p: 1.5,
//                         borderRadius: '10px',
//                         backgroundColor: 'rgba(0, 0, 0, 0.02)',
//                         border: '1px solid rgba(0, 0, 0, 0.05)'
//                       }}>
//                         <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>
//                           <User size={16} style={{ color: 'var(--color-text-secondary)' }} />
//                           <MuiTypography variant="body2" sx={{ fontWeight: 600, fontSize: '0.875rem' }}>
//                             {hall.manager.name}
//                           </MuiTypography>
//                         </MuiBox>
//                         {hall.manager.phone && (
//                           <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
//                             <Phone size={14} style={{ color: 'var(--color-text-secondary)' }} />
//                             <MuiTypography variant="caption" sx={{ fontSize: '0.75rem', color: 'var(--color-text-secondary)' }}>
//                               {formatPhoneNumber(hall.manager.phone)}
//                             </MuiTypography>
//                           </MuiBox>
//                         )}
//                       </MuiBox>
//                     </MuiCardContent>

//                     {/* Actions */}
//                     <MuiCardActions sx={{ p: 2, pt: 0, gap: 1, flexWrap: 'wrap' }}>
//                       <MuiButton
//                         size="small"
//                         variant="outlined"
//                         onClick={() => handleOpenViewDialog(hall)}
//                         startIcon={<Eye size={16} />}
//                         sx={{ flex: 1, minWidth: '80px' }}
//                       >
//                         عرض
//                       </MuiButton>
//                       <MuiButton
//                         size="small"
//                         variant="outlined"
//                         onClick={() => handleOpenDialog(hall)}
//                         startIcon={<Pencil size={16} />}
//                         sx={{ flex: 1, minWidth: '80px' }}
//                       >
//                         تعديل
//                       </MuiButton>
//                       <MuiIconButton
//                         size="small"
//                         color="error"
//                         onClick={() => handleOpenConfirm(hall, 'delete')}
//                         title="حذف"
//                       >
//                         <Trash2 size={18} />
//                       </MuiIconButton>
//                     </MuiCardActions>
//                   </MuiCard>
//                 )}
//               />

//               {/* Pagination for Cards View */}
//               {hallsResponse?.pagination && (
//                 <MuiPaper sx={{ mt: 3, borderRadius: '16px', overflow: 'hidden' }}>
//                   <TablePagination
//                     page={pagination.page}
//                     limit={pagination.limit}
//                     total={hallsResponse.pagination.totalItems || 0}
//                     totalPages={pagination.totalPages}
//                     onPageChange={(newPage) => setPagination(prev => ({ ...prev, page: newPage }))}
//                     onRowsPerPageChange={(newLimit) => setPagination(prev => ({
//                       ...prev,
//                       limit: newLimit,
//                       page: 1
//                     }))}
//                     rowsPerPageOptions={[6, 12, 24, 48]}
//                     label="عدد القاعات في الصفحة:"
//                   />
//                 </MuiPaper>
//               )}
//             </>
//           )}
//         </>
//       )}

//       {/* ====================== Dialogs ====================== */}

//       {/* Add/Edit Dialog */}
//       <MuiDialog
//         open={dialogOpen}
//         onClose={handleCloseDialog}
//         maxWidth="md"
//         fullWidth
//         PaperProps={{
//           sx: {
//             borderRadius: 3,
//             maxHeight: '90vh',
//             display: 'flex',
//             flexDirection: 'column',
//             overflow: 'hidden'
//           }
//         }}
//       >
//         <MuiBox sx={{ display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0, height: '100%' }}>
//           <MuiDialogTitle onClose={handleCloseDialog} sx={{ flexShrink: 0 }}>
//             <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
//               <Building2 size={24} />
//               <span>{editingHall ? 'تعديل القاعة' : 'إضافة قاعة جديدة'}</span>
//             </MuiBox>
//           </MuiDialogTitle>

//           <form onSubmit={handleSubmit(onSubmit)} style={{ display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0, overflow: 'hidden' }}>
//             <MuiDialogContent dividers sx={{ pt: 3, flex: 1, minHeight: 0 }}>
//               <MuiGrid container spacing={2}>
//                 {/* Basic Information */}
//                 <MuiGrid item xs={12}>
//                   <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main' }}>
//                     المعلومات الأساسية
//                   </MuiTypography>
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={6}>
//                   <Controller
//                     name="name"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="اسم القاعة *"
//                         fullWidth
//                         size="small"
//                         error={!!errors.name}
//                         helperText={errors.name?.message}
//                         required
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={6}>
//                   <Controller
//                     name="location"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="الموقع *"
//                         fullWidth
//                         size="small"
//                         error={!!errors.location}
//                         helperText={errors.location?.message}
//                         required
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12}>
//                   <Controller
//                     name="address"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="العنوان التفصيلي *"
//                         fullWidth
//                         size="small"
//                         error={!!errors.address}
//                         helperText={errors.address?.message}
//                         required
//                         multiline
//                         rows={2}
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={6}>
//                   <Controller
//                     name="capacity"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="السعة (عدد الأشخاص) *"
//                         type="number"
//                         fullWidth
//                         size="small"
//                         error={!!errors.capacity}
//                         helperText={errors.capacity?.message}
//                         required
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={6}>
//                   <Controller
//                     name="defaultPrices"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="السعر الافتراضي (للشخص) *"
//                         type="number"
//                         fullWidth
//                         size="small"
//                         error={!!errors.defaultPrices}
//                         helperText={errors.defaultPrices?.message}
//                         required
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12}>
//                   <MuiDivider sx={{ my: 2 }} />
//                   <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main' }}>
//                     المعدات والتجهيزات
//                   </MuiTypography>
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={4}>
//                   <Controller
//                     name="tables"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="عدد الطاولات *"
//                         type="number"
//                         fullWidth
//                         size="small"
//                         error={!!errors.tables}
//                         helperText={errors.tables?.message}
//                         required
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={4}>
//                   <Controller
//                     name="chairs"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="عدد الكراسي *"
//                         type="number"
//                         fullWidth
//                         size="small"
//                         error={!!errors.chairs}
//                         helperText={errors.chairs?.message}
//                         required
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={4}>
//                   <Controller
//                     name="maxEmployees"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="الحد الأقصى للموظفين *"
//                         type="number"
//                         fullWidth
//                         size="small"
//                         error={!!errors.maxEmployees}
//                         helperText={errors.maxEmployees?.message}
//                         required
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12}>
//                   <Controller
//                     name="description"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="الوصف"
//                         fullWidth
//                         size="small"
//                         multiline
//                         rows={3}
//                         error={!!errors.description}
//                         helperText={errors.description?.message}
//                         placeholder="وصف مختصر للقاعة والمميزات..."
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12}>
//                   <MuiDivider sx={{ my: 2 }} />
//                   <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main' }}>
//                     بيانات المدير
//                   </MuiTypography>
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={6}>
//                   <Controller
//                     name="managerName"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="اسم المدير *"
//                         fullWidth
//                         size="small"
//                         error={!!errors.managerName}
//                         helperText={errors.managerName?.message}
//                         required
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={6}>
//                   <Controller
//                     name="managerUsername"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="اسم المستخدم *"
//                         fullWidth
//                         size="small"
//                         error={!!errors.managerUsername}
//                         helperText={errors.managerUsername?.message}
//                         required
//                         placeholder="أحرف إنجليزية وأرقام و _ فقط"
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={6}>
//                   <Controller
//                     name="managerPhone"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label="رقم هاتف المدير *"
//                         fullWidth
//                         size="small"
//                         error={!!errors.managerPhone}
//                         helperText={errors.managerPhone?.message}
//                         required
//                         placeholder="أرقام فقط"
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 <MuiGrid item xs={12} md={6}>
//                   <Controller
//                     name="managerPassword"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiTextField
//                         {...field}
//                         label={editingHall ? "كلمة المرور (اتركها فارغة للإبقاء على الحالية)" : "كلمة المرور *"}
//                         type="password"
//                         fullWidth
//                         size="small"
//                         error={!!errors.managerPassword}
//                         helperText={errors.managerPassword?.message}
//                         required={!editingHall}
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 {/* Amenities */}
//                 <MuiGrid item xs={12}>
//                   <MuiDivider sx={{ my: 2 }} />
//                   <MuiTypography variant="h6" sx={{ mb: 2, color: 'primary.main' }}>
//                     المرافق المتاحة
//                   </MuiTypography>
//                   <Controller
//                     name="amenities"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiAutocomplete
//                         multiple
//                         options={availableAmenities}
//                         value={field.value || []}
//                         onChange={(_, newValue) => field.onChange(newValue)}
//                         renderInput={(params) => (
//                           <MuiTextField
//                             {...params}
//                             placeholder="اختر المرافق"
//                             size="small"
//                           />
//                         )}
//                         renderOption={(props, option) => (
//                           <li {...props}>
//                             <MuiChip
//                               label={option}
//                               size="small"
//                               sx={{ m: 0.5 }}
//                             />
//                           </li>
//                         )}
//                         renderTags={(value, getTagProps) =>
//                           value.map((option, index) => (
//                             <MuiChip
//                               label={option}
//                               size="small"
//                               {...getTagProps({ index })}
//                               key={index}
//                             />
//                           ))
//                         }
//                       />
//                     )}
//                   />
//                 </MuiGrid>

//                 {/* Status Field */}
//                 <MuiGrid item xs={12}>
//                   <MuiDivider sx={{ my: 2 }} />
//                   <MuiTypography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
//                     حالة القاعة:
//                   </MuiTypography>
//                   <Controller
//                     name="isActive"
//                     control={control}
//                     render={({ field }) => (
//                       <MuiBox sx={{ display: 'flex', gap: 2 }}>
//                         <MuiButton
//                           variant={field.value ? "contained" : "outlined"}
//                           color="success"
//                           size="small"
//                           onClick={() => field.onChange(true)}
//                           startIcon={<Check size={16} />}
//                         >
//                           نشطة
//                         </MuiButton>
//                         <MuiButton
//                           variant={!field.value ? "contained" : "outlined"}
//                           color="warning"
//                           size="small"
//                           onClick={() => field.onChange(false)}
//                           startIcon={<X size={16} />}
//                         >
//                           غير نشطة
//                         </MuiButton>
//                       </MuiBox>
//                     )}
//                   />
//                 </MuiGrid>
//               </MuiGrid>
//             </MuiDialogContent>

//             <MuiDialogActions
//               sx={{
//                 flexShrink: 0,
//                 borderTop: '1px solid rgba(0, 0, 0, 0.12)',
//                 backgroundColor: 'rgba(255, 255, 255, 0.95)',
//                 p: 2
//               }}
//             >
//               <MuiButton
//                 onClick={handleCloseDialog}
//                 color="inherit"
//                 disabled={isSubmitting}
//                 size="small"
//               >
//                 إلغاء
//               </MuiButton>
//               <MuiButton
//                 type="submit"
//                 variant="contained"
//                 color="primary"
//                 disabled={isSubmitting}
//                 startIcon={isSubmitting ? <MuiCircularProgress size={20} /> : null}
//                 size="small"
//               >
//                 {isSubmitting ? 'جاري الحفظ...' : (editingHall ? 'تحديث' : 'حفظ')}
//               </MuiButton>
//             </MuiDialogActions>
//           </form>
//         </MuiBox>
//       </MuiDialog>

//       {/* View Dialog - مختصر */}
//       {viewingHall && (
//         <MuiDialog
//           open={viewDialogOpen}
//           onClose={handleCloseViewDialog}
//           maxWidth="sm"
//           fullWidth
//           PaperProps={{
//             sx: {
//               borderRadius: 3,
//               maxHeight: '90vh',
//               display: 'flex',
//               flexDirection: 'column'
//             }
//           }}
//         >
//           <MuiDialogTitle onClose={handleCloseViewDialog} sx={{
//             backgroundColor: 'info.light',
//             color: 'info.contrastText',
//             py: 2,
//             position: 'sticky',
//             top: 0,
//             zIndex: 1,
//             flexShrink: 0
//           }}>
//             <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2, flexWrap: 'wrap' }}>
//               <Building2 size={24} />
//               <span style={{ wordBreak: 'break-word' }}>تفاصيل القاعة: {viewingHall.name}</span>
//             </MuiBox>
//           </MuiDialogTitle>

//           <MuiDialogContent dividers sx={{ pt: 3, flex: 1, overflowY: 'auto', overflowX: 'hidden' }}>
//             <MuiGrid container spacing={2}>
//               {/* Basic Info */}
//               <MuiGrid item xs={12}>
//                 <MuiBox sx={{ p: 2, backgroundColor: 'background.default', borderRadius: 2, border: '1px solid', borderColor: 'divider' }}>
//                   <MuiTypography variant="subtitle1" sx={{ mb: 2, fontWeight: 600 }}>
//                     <Building2 size={18} style={{ marginLeft: 8, verticalAlign: 'middle' }} />
//                     المعلومات الأساسية
//                   </MuiTypography>
                  
//                   <MuiGrid container spacing={2}>
//                     <MuiGrid item xs={12} sm={6}>
//                       <MuiTypography variant="body2" color="text.secondary">الاسم:</MuiTypography>
//                       <MuiTypography variant="body1" fontWeight="bold">{viewingHall.name}</MuiTypography>
//                     </MuiGrid>
//                     <MuiGrid item xs={12} sm={6}>
//                       <MuiTypography variant="body2" color="text.secondary">الموقع:</MuiTypography>
//                       <MuiTypography variant="body1">{viewingHall.location}</MuiTypography>
//                     </MuiGrid>
//                     <MuiGrid item xs={12} sm={6}>
//                       <MuiTypography variant="body2" color="text.secondary">السعة:</MuiTypography>
//                       <MuiTypography variant="body1">{viewingHall.capacity.toLocaleString()} شخص</MuiTypography>
//                     </MuiGrid>
//                     <MuiGrid item xs={12} sm={6}>
//                       <MuiTypography variant="body2" color="text.secondary">السعر:</MuiTypography>
//                       <MuiTypography variant="body1" color="success.main" fontWeight="bold">
//                         {formatCurrency(viewingHall.defaultPrices)} للشخص
//                       </MuiTypography>
//                     </MuiGrid>
//                   </MuiGrid>
//                 </MuiBox>
//               </MuiGrid>

//               {/* Manager Info */}
//               <MuiGrid item xs={12}>
//                 <MuiBox sx={{ p: 2, backgroundColor: 'background.default', borderRadius: 2, border: '1px solid', borderColor: 'divider' }}>
//                   <MuiTypography variant="subtitle1" sx={{ mb: 2, fontWeight: 600 }}>
//                     <User size={18} style={{ marginLeft: 8, verticalAlign: 'middle' }} />
//                     بيانات المدير
//                   </MuiTypography>
                  
//                   <MuiGrid container spacing={2}>
//                     <MuiGrid item xs={12} sm={6}>
//                       <MuiTypography variant="body2" color="text.secondary">الاسم:</MuiTypography>
//                       <MuiTypography variant="body1" fontWeight="bold">{viewingHall.manager.name}</MuiTypography>
//                     </MuiGrid>
//                     <MuiGrid item xs={12} sm={6}>
//                       <MuiTypography variant="body2" color="text.secondary">الهاتف:</MuiTypography>
//                       <MuiTypography variant="body1" dir="ltr">
//                         {formatPhoneNumber(viewingHall.manager.phone) || 'غير متوفر'}
//                       </MuiTypography>
//                     </MuiGrid>
//                   </MuiGrid>
//                 </MuiBox>
//               </MuiGrid>

//               {/* Description */}
//               {viewingHall.description && (
//                 <MuiGrid item xs={12}>
//                   <MuiBox sx={{ p: 2, backgroundColor: 'background.default', borderRadius: 2, border: '1px solid', borderColor: 'divider' }}>
//                     <MuiTypography variant="subtitle1" sx={{ mb: 2, fontWeight: 600 }}>
//                       <FileText size={18} style={{ marginLeft: 8, verticalAlign: 'middle' }} />
//                       الوصف
//                     </MuiTypography>
//                     <MuiTypography variant="body1">{viewingHall.description}</MuiTypography>
//                   </MuiBox>
//                 </MuiGrid>
//               )}
//             </MuiGrid>
//           </MuiDialogContent>

//           <MuiDialogActions sx={{
//             px: 3,
//             py: 2,
//             position: 'sticky',
//             bottom: 0,
//             backgroundColor: 'background.paper',
//             borderTop: '1px solid rgba(0, 0, 0, 0.08)',
//             zIndex: 1,
//             flexShrink: 0
//           }}>
//             <MuiButton
//               onClick={() => {
//                 handleCloseViewDialog()
//                 handleOpenDialog(viewingHall)
//               }}
//               color="primary"
//               variant="outlined"
//               size="small"
//             >
//               تعديل
//             </MuiButton>
//             <MuiButton
//               onClick={handleCloseViewDialog}
//               color="inherit"
//               size="small"
//             >
//               إغلاق
//             </MuiButton>
//           </MuiDialogActions>
//         </MuiDialog>
//       )}

//       {/* Filter Dialog */}
//       <MuiDialog
//         open={filterDialogOpen}
//         onClose={handleCloseFilterDialog}
//         maxWidth="xs"
//         fullWidth
//       >
//         <MuiDialogTitle>
//           <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
//             <Filter size={24} />
//             <span>تصفية القاعات</span>
//           </MuiBox>
//         </MuiDialogTitle>

//         <MuiDialogContent dividers>
//           <MuiGrid container spacing={2}>
//             <MuiGrid item xs={12} sm={6}>
//               <MuiTextField
//                 label="الحد الأدنى للسعة"
//                 type="number"
//                 fullWidth
//                 size="small"
//                 value={filters.minCapacity}
//                 onChange={(e) => setFilters(prev => ({ ...prev, minCapacity: e.target.value }))}
//               />
//             </MuiGrid>
//             <MuiGrid item xs={12} sm={6}>
//               <MuiTextField
//                 label="الحد الأقصى للسعة"
//                 type="number"
//                 fullWidth
//                 size="small"
//                 value={filters.maxCapacity}
//                 onChange={(e) => setFilters(prev => ({ ...prev, maxCapacity: e.target.value }))}
//               />
//             </MuiGrid>
//             <MuiGrid item xs={12} sm={6}>
//               <MuiTextField
//                 label="الحد الأدنى للسعر"
//                 type="number"
//                 fullWidth
//                 size="small"
//                 value={filters.minPrice}
//                 onChange={(e) => setFilters(prev => ({ ...prev, minPrice: e.target.value }))}
//               />
//             </MuiGrid>
//             <MuiGrid item xs={12} sm={6}>
//               <MuiTextField
//                 label="الحد الأقصى للسعر"
//                 type="number"
//                 fullWidth
//                 size="small"
//                 value={filters.maxPrice}
//                 onChange={(e) => setFilters(prev => ({ ...prev, maxPrice: e.target.value }))}
//               />
//             </MuiGrid>
//             <MuiGrid item xs={12}>
//               <MuiTypography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
//                 حالة القاعة:
//               </MuiTypography>
//               <MuiBox sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
//                 <MuiButton
//                   variant={filters.isActive === 'all' ? "contained" : "outlined"}
//                   color="primary"
//                   size="small"
//                   onClick={() => setFilters(prev => ({ ...prev, isActive: 'all' }))}
//                 >
//                   الكل
//                 </MuiButton>
//                 <MuiButton
//                   variant={filters.isActive === 'active' ? "contained" : "outlined"}
//                   color="success"
//                   size="small"
//                   onClick={() => setFilters(prev => ({ ...prev, isActive: 'active' }))}
//                 >
//                   النشطة فقط
//                 </MuiButton>
//                 <MuiButton
//                   variant={filters.isActive === 'inactive' ? "contained" : "outlined"}
//                   color="warning"
//                   size="small"
//                   onClick={() => setFilters(prev => ({ ...prev, isActive: 'inactive' }))}
//                 >
//                   غير النشطة فقط
//                 </MuiButton>
//               </MuiBox>
//             </MuiGrid>
//           </MuiGrid>
//         </MuiDialogContent>

//         <MuiDialogActions>
//           <MuiButton onClick={handleResetFilters} color="inherit" size="small">
//             إعادة التعيين
//           </MuiButton>
//           <MuiButton onClick={handleCloseFilterDialog} color="inherit" size="small">
//             إلغاء
//           </MuiButton>
//           <MuiButton onClick={handleApplyFilters} variant="contained" color="primary" size="small">
//             تطبيق التصفية
//           </MuiButton>
//         </MuiDialogActions>
//       </MuiDialog>

//       {/* Export Dialog */}
//       <MuiDialog
//         open={exportDialogOpen}
//         onClose={handleCloseExportDialog}
//         maxWidth="xs"
//         fullWidth
//       >
//         <MuiDialogTitle>
//           <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
//             <Download size={24} />
//             <span>تصدير البيانات</span>
//           </MuiBox>
//         </MuiDialogTitle>

//         <MuiDialogContent dividers>
//           <MuiTypography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
//             سيتم تصدير {hallsResponse?.pagination?.totalItems || 0} قاعة بتنسيق Excel
//           </MuiTypography>

//           <MuiBox sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
//             <MuiBox sx={{ display: 'flex', alignItems: 'center', gap: 2, mt: 2 }}>
//               <MuiTypography variant="body2">تضمين القاعات غير النشطة:</MuiTypography>
//               <MuiButton
//                 size="small"
//                 variant={exportOptions.includeInactive ? "contained" : "outlined"}
//                 color={exportOptions.includeInactive ? "primary" : "inherit"}
//                 onClick={() => setExportOptions(prev => ({
//                   ...prev,
//                   includeInactive: !prev.includeInactive
//                 }))}
//               >
//                 {exportOptions.includeInactive ? 'نعم' : 'لا'}
//               </MuiButton>
//             </MuiBox>
//           </MuiBox>
//         </MuiDialogContent>

//         <MuiDialogActions>
//           <MuiButton onClick={handleCloseExportDialog} color="inherit" size="small">
//             إلغاء
//           </MuiButton>
//           <MuiButton 
//             onClick={handleExportData}
//             variant="contained"
//             color="success"
//             startIcon={<Download size={20} />}
//             size="small"
//           >
//             بدء التصدير
//           </MuiButton>
//         </MuiDialogActions>
//       </MuiDialog>

//       {/* Confirm Dialog */}
//       <ConfirmDialog
//         open={confirmDialog.open}
//         onClose={handleCloseConfirm}
//         onConfirm={handleConfirmAction}
//         title={confirmDialog.title}
//         message={confirmDialog.message}
//         confirmLabel={
//           confirmDialog.action === 'delete' ? 'حذف' :
//           confirmDialog.action === 'deactivate' ? 'تعطيل' :
//           'تفعيل'
//         }
//         confirmColor={
//           confirmDialog.action === 'delete' ? 'error' :
//           confirmDialog.action === 'deactivate' ? 'warning' :
//           'success'
//         }
//         cancelLabel="إلغاء"
//         loading={deleteMutation.isPending || toggleStatusMutation.isPending}
//       />
//     </>
//   )
// }

